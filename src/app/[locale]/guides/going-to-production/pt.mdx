export const header = {
  title: 'Going to production',
  description:
    'Improving your Atmosphere stack deployment for production use at scale',
}

O Atmosphere foi criado para ser distribuído, o que significa que qualquer pessoa pode e deve se sentir à vontade para hospedar sua própria infraestrutura do Protocolo AT. Se você estiver hospedando em grande escala, ou seja, oferecendo um serviço para muitos milhares de usuários, provavelmente precisará realizar algum “fortalecimento” adicional do seu serviço hospedado e tomar decisões mais complexas sobre o provisionamento da sua infraestrutura.
O [código](https://github.com/bluesky-social/atproto) para alimentar um Atmosphere totalmente distribuído está em constante aperfeiçoamento. Aqui está um guia com algumas lições e melhores práticas para gerenciar seus próprios serviços.
## PDS
Fornecemos um [script de instalação do PDS](https://github.com/bluesky-social/pds) projetado para você começar a usar seu próprio PDS em um VPS com recursos modestos. Isso permitirá que você hospede seus próprios repositórios de dados, crie e gerencie contas e sirva seus dados auto-hospedados na rede Atmosphere mais ampla ou em qualquer outro aplicativo Atmosphere. Esta seção da documentação irá ajudá-lo a colocar esse PDS em produção.
## Nomes de domínio
Se você estiver executando um aplicativo que não seja da Bluesky além de uma implantação PDS, **você precisará de nomes de domínio separados** para sua hospedagem PDS e seu aplicativo. Isso porque, caso contrário, os blobs de imagem e vídeo seriam servidos a partir do mesmo nome de domínio que as páginas OAuth e de gerenciamento de sessão. Isso poderia levar a problemas de segurança, como roubo de credenciais, e significa que usar subdomínios não é uma solução prática.
Em outras palavras, se você tiver um aplicativo em [https://greensky.app](https://greensky.app/), você não deve usar [https://pds.greensky.app](https://pds.greensky.app/) como nome de host do PDS, mas sim algo como [https://greensky-pds.net](https://greensky-pds.net/). Se você usasse [https://pds.greensky.social](https://pds.eurosky.social/) (o que faria sentido), isso poderia excluir um aplicativo cliente OAuth em [https://chat.greensky.social](https://chat.eurosky.social/) no futuro. Mas você poderia fazer algo como [https://chat.greensky.app](https://chat.eurosky.app/).
O PDS tem cabeçalhos CORS restritivos por padrão.
 
É difícil alterar um nome de host PDS depois que ele tem contas ativas — cada conta precisa ser migrada individualmente. Isso é absolutamente possível usando [chaves de rotação PLC], mas a migração não é imediata. Observe também que o PDS é o domínio em que os usuários inserirão suas senhas (e, portanto, serão lembradas nos gerenciadores de senhas).
## Backups e recuperação
Nosso [script de instalação oficial do PDS](https://github.com/bluesky-social/pds) configura o SQLite como um backend de banco de dados. Especificamente, ele usa um banco de dados SQLite para o [repositório de dados] de cada usuário e alguns outros para dados de todo o PDS. Isso pode ser surpreendente, já que o SQLite não possui nenhum mecanismo para lidar com backups ou réplicas prontos para uso, mas o SQLite tem se mostrado cada vez mais [escalável](https://fly.io/blog/sqlite-internals-rollback-journal/) com algumas ferramentas adicionais.
O segredo aqui é o [Litestream](https://fly.io/blog/litestream-v050-is-here/), que faz exatamente isso — [Backups e recuperação para SQLite](https://github.com/benbjohnson/litestream). Para obter uma implantação PDS SQLite recuperável e escalável com o Litestream, recomendamos:
- Definir `PDS_SQLITE_DISABLE_WAL_AUTO_CHECKPOINT` = `true` . Isso está na [configuração da variável de ambiente](https://github.com/bluesky-social/atproto/blob/f8e56b387fcd3bc8405225c1bbdef66ca5dc1591/packages/pds/src/config/env.ts#L48) do seu PDS. O que isso faz é forçar o cliente SQLite do PDS a manter o registro antecipado de gravação aberto e deixar o ponto de verificação real para o Litestream.
- Use o [Litestream com systemd](https://litestream.io/guides/systemd/) ou outro agendador para encontrar os bancos de dados atualizados mais recentemente e fazer backup deles. Por padrão, os bancos de dados individuais dos usuários estão localizados em `/pds/actors/`. O Litestream limpará o registro de gravação antecipada e o ponto de verificação automaticamente, portanto, não há risco de o WAL crescer descontroladamente.
- Se necessário, certifique-se de que este script também seja executado no SIGTERM ao limpar contêineres ou pods da sua implantação.
Em um cenário de recuperação de desastre, você baixaria todos os arquivos de banco de dados de conta mais recentes (que podem estar faltando algumas horas de dados) e os arquivos de banco de dados de todo o PDS (que devem estar praticamente completos). Em seguida, execute um script de recuperação que aplique todas as operações de repositório da saída do firehose no nível do PDS. Isso inclui atualizações de identidade e conta. Em seguida, inicie o backup do PDS.
## Gerenciamento de chaves PLC
É importante proteger a chave de rotação de identidade PLC extra para contas hospedadas — por exemplo, em um [Sistema de Gerenciamento de Chaves](https://developer.hashicorp.com/vault/docs/secrets/key-management) ou [Módulo de Segurança de Hardware](https://csrc.nist.gov/glossary/term/hardware_security_module_hsm). Preste atenção a estas duas variáveis de ambiente:
- `PDS_PLC_ROTATION_KEY_K256_PRIVATE_KEY_HEX`: usada pelo serviço PDS para realizar operações no PLC, incluindo a recuperação de contas de usuário. Se você estiver usando AWS, isso pode ser configurado com o [AWS Key Management Service](https://aws.amazon.com/kms/), usando `PDS_PLC_ROTATION_KEY_KMS_KEY_ID`.
- `PDS_RECOVERY_DID_KEY`: uma chave pública que é adicionada ao DID dos usuários. A chave privada correspondente **deve ser** armazenada em um local seguro e pode ser usada para recuperar contas de usuário em caso de perda catastrófica de dados, incluindo o `PDS_PLC_ROTATION_KEY_K256_PRIVATE_KEY_HEX`.
## Armazenamento de objetos
Por padrão, o script de instalação do PDS configura o armazenamento em disco local para blobs (imagens, vídeos, etc.). Isso é adequado para pequenas implantações, mas não é recomendado para implantações de produção.
As necessidades de armazenamento variam, mas recomendamos fortemente o uso de armazenamento compatível com S3 (por exemplo, [Minio](https://github.com/minio/minio) ou uma oferta de armazenamento em bloco de um provedor de VPS) em vez de armazenar imagens e vídeos no disco local.
## Limites de taxa
A implementação do PDS inclui [limites de operação do repositório](https://docs.bsky.app/docs/advanced-guides/rate-limits) por padrão.
 
Se você remover esses limites, todo o PDS poderá ficar limitado no [Relay](https://github.com/bluesky-social/indigo/tree/main/cmd/relay) (que por si só tem limites de taxa de eventos padrão para cada host PDS), portanto, esteja ciente disso se você também não estiver executando seu próprio Relay.
Por padrão, nosso script de instalação do PDS configurará um único processo de aplicativo Node. Esses são aplicativos back-end sem estado que são executados no SQLite. Se você escalar horizontalmente para executar vários processos Node, também precisará usar o [Redis](https://redis.io/) para permitir que eles compartilhem o estado. Existem duas variáveis de ambiente usadas para configurar o Redis:
- `PDS_REDIS_SCRATCH_ADDRESS`  — sua instância Redis (por exemplo, localhost:6379)
- `PDS_REDIS_SCRATCH_PASSWORD` — suas credenciais Redis.
Isso permite que sua limitação de taxa seja dimensionada de maneira adequada.
Se você estiver executando vários processos em paralelo, também pode aproveitar os [contêineres sidecar](https://litestream.io/guides/docker/#why-sidecar-containers-work) para seus bancos de dados SQLite.
## Moderação
A moderação é quase sempre realizada no nível do PDS. No entanto, se você também estiver executando um Relay, esteja ciente de que a interface web de administração do Relay possui formulários para realizar ações no nível da conta e no nível do PDS, se necessário. Existem também alguns pontos finais PDS relacionados à moderação que não são expostos via XRPC, com os quais nossa ferramenta CLI [goat](https://github.com/bluesky-social/goat) pode interagir. Consulte [goat/pds_admin.go](https://github.com/bluesky-social/goat/blob/main/pds_admin.go) para obter exemplos.
O [Ozone](https://github.com/bluesky-social/ozone) é nosso serviço de rotulagem e interface de moderação. Se você estiver criando seu próprio AppView, os AppViews podem usar o “firehose” `subscribeLabel` do Ozone para receber atualizações. O Ozone também pode receber permissão para ler informações privadas adicionais no nível do PDS, como o e-mail da conta. Isso é útil para coisas como recuperação de conta.
Geralmente, você deve executar instâncias separadas do Ozone para moderar o PDS (já que elas podem ver informações privadas da conta) e AppViews independentes, a menos que haja realmente uma única organização administrativa fazendo a moderação para ambos.
export const header = {
  title: 'Going to production',
  description:
    'Improving your Atmosphere stack deployment for production use at scale',
}

Atmosphere는 분산형으로 설계되었습니다. 즉 누구나 자유롭게 자체 AT 프로토콜 인프라를 호스팅할 수 있으며, 그렇게 해야 합니다. 대규모로 자체 호스팅하는 경우, 즉 수천 명의 사용자에게 서비스를 제공하는 경우 호스팅 서비스에 대한 추가적인 “보안 강화” 작업이 필요할 수 있으며, 인프라 프로비저닝에 관한 더 복잡한 결정을 내려야 할 것입니다.
완전히 분산된 Atmosphere를 구동하는 [코드](https://github.com/bluesky-social/atproto)는 지속적으로 개선되고 있습니다. 자체 서비스 관리를 위한 교훈과 모범 사례가 담긴 가이드를 참고하세요.
## PDS
저희는 [PDS 설치 스크립트](https://github.com/bluesky-social/pds)를 제공하며, 이는 적당한 자원의 VPS에서 자체 PDS를 가동할 수 있도록 설계되었습니다. 이를 통해 자체 데이터 저장소를 호스팅하고, 계정을 생성 및 관리하며, 자체 호스팅 데이터를 더 넓은 Atmosphere 네트워크나 다른 Atmosphere 앱에서 제공할 수 있습니다. 이 문서 섹션은 해당 PDS를 실제 운영 환경으로 전환하는 데 도움을 드립니다.
## 도메인 이름
PDS 배포 외에도 Bluesky 앱이 아닌 다른 앱을 운영 중인 경우, PDS 호스팅과 앱을 위해 **별도의 도메인 이름이 필요합니다**. 이는 이미지 및 동영상 블롭이 OAuth 및 세션 관리 페이지와 동일한 도메인 이름에서 제공될 수 있기 때문입니다. 이는 자격 증명 도용과 같은 보안 문제로 이어질 수 있으며, 서브도메인 사용이 실용적인 해결책이 아님을 의미합니다.
즉, [https://greensky.app](https://greensky.app/)에 앱이 있다면, PDS 호스트명으로 [https://pds.greensky.app](https://pds.greensky.app/)을 사용해서는 안 되며, [https://greensky-pds.net](https://greensky-pds.net/)과 같은 주소를 사용해야 합니다. [https://pds.greensky.social](https://pds.eurosky.social/)을 사용한다면(이것은 합리적일 수 있음), 향후 [https://chat.greensky.social](https://chat.eurosky.social/)의 OAuth 클라이언트 앱을 배제할 수 있습니다. 하지만 [https://chat.greensky.app](https://chat.eurosky.app/)과 같은 방식을 사용할 수 있습니다.
PDS는 기본적으로 제한적인 CORS 헤더를 적용합니다.
활성 계정이 있는 상태에서 PDS 호스트명을 변경하는 것은 어렵습니다 — 모든 계정을 개별적으로 마이그레이션해야 합니다. [PLC 회전 키](https://pds.pixel.com/documentation/pcl-rotation-keys)를 사용하면 가능하지만, 마이그레이션이 간편하지는 않습니다. 또한 PDS는 사용자가 비밀번호를 입력하는 도메인이며(따라서 비밀번호 관리자에 저장됨) 이 점을 유의하세요.
## 백업 및 복구
[공식 PDS 설치 스크립트](https://github.com/bluesky-social/pds)는 SQLite를 데이터베이스 백엔드로 구성합니다. 구체적으로, 각 사용자의 [데이터 저장소]마다 하나의 SQLite DB를 사용하고, PDS 전체 데이터를 위한 몇 개의 DB를 추가로 사용합니다. SQLite는 기본적으로 백업이나 복제를 처리하는 메커니즘이 없기 때문에 이는 놀랍게 느껴질 수 있지만, 일부 추가 도구를 사용하면 SQLite가 [매우 잘 확장됨](https://fly.io/blog/sqlite-internals-rollback-journal/)이 점차 입증되고 있습니다.
여기서 핵심은 [Litestream](https://fly.io/blog/litestream-v050-is-here/)입니다. 이 도구는 정확히 [SQLite용 백업 및 복구](https://github.com/benbjohnson/litestream) 기능을 수행합니다. Litestream을 사용해 복구 가능하고 확장성 있는 PDS SQLite 배포를 구축하려면 다음을 권장합니다:
- `PDS_SQLITE_DISABLE_WAL_AUTO_CHECKPOINT` = `true` 설정. 이는 PDS의 [환경 변수 구성](https://github.com/bluesky-social/atproto/blob/f8e56b387fcd3bc8405225c1bbdef66ca5dc1591/packages/pds/src/config/env.ts#L48)에 있습니다. 이 설정은 PDS SQLite 클라이언트가 사전 기록 로깅을 계속 열어두도록 강제하고 실제 체크포인트 작업은 Litestream에 맡깁니다.
- [systemd와 함께 Litestream 사용](https://litestream.io/guides/systemd/) 또는 다른 스케줄러를 사용하여 가장 최근에 업데이트된 DB를 찾아 백업하십시오. 기본적으로 개별 사용자 데이터베이스는 `/pds/actors/`에 위치합니다. Litestream은 자동으로 WAL을 정리하고 체크포인트를 수행하므로 WAL이 통제 불능 상태로 커질 위험이 없습니다.
- 필요한 경우, 배포 환경에서 컨테이너나 포드를 정리할 때 SIGTERM 신호로 이 스크립트가 실행되도록 설정하십시오.
재해 복구 시나리오에서는 가장 최근의 계정 데이터베이스 파일(몇 시간 분량의 데이터가 누락될 수 있음)과 PDS 전체 데이터베이스 파일(대략 완전해야 함)을 모두 가져옵니다. 그런 다음 PDS 수준 파이어호스 출력에서 리포지토리 작업을 적용하는 복구 스크립트를 실행합니다. 여기에는 신원 및 계정 업데이트가 포함됩니다. 그런 다음 PDS를 다시 시작합니다.
## PLC 키 관리
호스팅 계정의 추가 PLC 신원 회전 키를 안전하게 보호하는 것이 중요합니다. 예를 들어 [키 관리 시스템](https://developer.hashicorp.com/vault/docs/secrets/key-management)이나 [하드웨어 보안 모듈](https://csrc.nist.gov/glossary/term/hardware_security_module_hsm)에 보관하십시오. 다음 두 환경 변수에 주의하십시오:
- `PDS_PLC_ROTATION_KEY_K256_PRIVATE_KEY_HEX`: PDS 서비스가 사용자 계정 복구를 포함한 PLC 작업 수행에 사용합니다. AWS를 사용하는 경우, `PDS_PLC_ROTATION_KEY_KMS_KEY_ID`를 사용하여 [AWS 키 관리 서비스](https://aws.amazon.com/kms/)로 구성할 수 있습니다.
- `PDS_RECOVERY_DID_KEY`: 사용자의 DID에 추가되는 공개 키입니다. 해당 개인 키는 반드시 안전한 장소에 보관해야 하며, `PDS_PLC_ROTATION_KEY_K256_PRIVATE_KEY_HEX`를 포함한 데이터의 재앙적인 손실 시 사용자 계정 복구에 사용할 수 있습니다.
## 객체 저장소
기본적으로 PDS 설치 스크립트는 로컬 디스크 저장소를 블롭(이미지, 비디오 등)용으로 구성합니다. 소규모 배포에는 적합하지만, 프로덕션 배포에는 권장되지 않습니다.
저장 공간 요구 사항은 다양하지만, 로컬 디스크에 이미지 및 동영상을 저장하는 대신 S3 호환 저장소(예: [Minio](https://github.com/minio/minio) 또는 VPS 제공업체의 블록 스토리지 서비스)를 사용하는 것을 강력히 권장합니다.
## 속도 제한
PDS 구현에는 기본적으로 [저장소 작업 제한](https://docs.bsky.app/docs/advanced-guides/rate-limits)이 포함됩니다.
 
이러한 제한을 제거하면 전체 PDS가 [릴레이](https://github.com/bluesky-social/indigo/tree/main/cmd/relay)에서 제한될 수 있습니다(릴레이 자체도 각 PDS 호스트에 대해 기본 이벤트 속도 제한을 적용함). 따라서 자체 릴레이를 운영하지 않는 경우 이 점을 유의하십시오.
기본적으로 PDS 설치 스크립트는 단일 Node 애플리케이션 프로세스를 설정합니다. 이는 SQLite 위에 실행되는 상태 비저장 백엔드 애플리케이션입니다. 여러 Node 프로세스를 실행하기 위해 수평 확장할 경우 상태 공유를 위해 [Redis](https://redis.io/)도 사용해야 합니다. Redis 구성을 위해 사용되는 환경 변수는 두 가지입니다:
- `PDS_REDIS_SCRATCH_ADDRESS` — Redis 인스턴스 주소(예: localhost:6379)
- `PDS_REDIS_SCRATCH_PASSWORD` — Redis 인증 정보
이를 통해 속도 제한 기능이 원활하게 확장됩니다.
여러 프로세스를 병렬로 실행하는 경우 SQLite 데이터베이스에 [사이드카 컨테이너](https://litestream.io/guides/docker/#why-sidecar-containers-work)를 활용하는 것도 고려해 볼 수 있습니다.
## 검토
검토는 거의 항상 PDS 수준에서 수행됩니다. 다만 릴레이를 함께 운영 중인 경우, 릴레이 관리자 웹 인터페이스에 필요 시 계정 수준 및 PDS 수준 작업을 수행할 수 있는 양식이 마련되어 있음을 유의하세요. XRPC를 통해 노출되지 않는 일부 검토 관련 PDS 엔드포인트도 있으며, 당사의 [goat](https://github.com/bluesky-social/goat) CLI 도구를 통해 상호작용할 수 있습니다. 예시는 [goat/pds_admin.go](https://github.com/bluesky-social/goat/blob/main/pds_admin.go)를 참조하십시오.
[Ozone](https://github.com/bluesky-social/ozone)은 라벨링 서비스이자 검토 인터페이스입니다. 자체 AppView를 구축하는 경우, AppView는 Ozone의 `subscribeLabel` “파이어호스”를 통해 업데이트를 수신할 수 있습니다. Ozone에는 계정 이메일과 같은 추가 PDS 레벨 비공개 정보에 대한 읽기 권한도 부여될 수 있습니다. 이는 계정 복구 등에 유용합니다.
일반적으로 PDS(개인 계정 정보 접근 권한이 있음)와 독립형 AppViews의 검토를 위해 별도의 Ozone 인스턴스를 운영해야 합니다. 단, 실제로 단일 관리 조직이 양쪽 모두의 검토를 수행하는 경우는 예외입니다.
import {Heading} from '@/components/Heading'

export const header = {
  title: 'アカウントと削除',
  description:
    'ATプロトコルでアカウントのライフサイクルと削除がどのように機能するか',
}

<Heading level={2} id="account-lifecycles">アカウントライフサイクル</Heading>

この文書は[アカウントホスティング](/specs/account)仕様が与えるアカウントライフサイクル概要を補完します。アカウントライフサイクルの移り変わりの幾つかにおける望ましい挙動や、どのfirehoseイベントがどんな順番で現れるべきかをまとめます。ソフトウェアは一般的に不完全なイベントや誤ったイベントの送信への耐性が期待されます。

アカウントライフサイクルを理解することは、ATプロトコルにおけるレコード削除の理解の助けにもなります。

<Heading level={2} id="new-account-creation">新規アカウント作成</Heading>

アカウントがPDSに登録され、新しいID（DID）が作成されたとき、以下のことが起こります。

- PDSはアカウントのID（DIDやハンドル）を生成したり、存在を確認します。DIDがネットワーク上の他サービスから解決可能かつ現在のPDSを指すことが確認されたら、PDSは`#identity`イベントを送信します。送信前にハンドルもサードパーティから解決可能になることが望ましいですが、必須ではありません（特にそのPDSがアカウントにハンドルを提供する場合はそうですが、その場合に限りません）。イベント送信時、アカウント状態は`active`かもしれませんし、そうでないかもしれません。
- アカウント作成が完了したら、PDSはアカウント状態に関するAPIに対して`active`で応答するようになり、`#account`イベントを送信します。
- アカウントのリポジトリは`rev`と`commit`が初期化され、`#commit`イベントが送信されます。初期リポジトリは空（レコード無し）かもしれませんし、レコードを含んでいるかもしれません。
- イベントの順序は正式には決まっていませんが、`#identity`、`#account`、`#commit`の順を推奨します。
- 下流のサービスはこれらのイベントを処理し、パススルーします。

<Heading level={2} id="account-migration">アカウント移行</Heading>

新しいPDSへのアカウント移行に関連するイベントと挙動は以下の通りです。

- 新しいPDSはアカウント作成時にはイベントを送信しません。新しいPDSにおけるアカウント状態は`deactivated`です（APIに対してそのように応答します）。
- 新しいPDSによってIDが更新および確認されると、PDSは`#identity`イベントを送信します。
- 新しいPDSでアカウントが`active`に変更されたら、PDSは`#account`および`#commit`イベントを送信します。順序は正式には決まっていませんが、`#account`を先にすることを推奨します。理想的には`#commit`イベントは空（新規レコード無し）ですが、新しい署名鍵で署名されており、新しい、または増加した`rev`を持ちます。
- アカウントが古いPDSで無効化されると、PDSは`#account`イベントを送信してアカウントが無効化したことを示し、`deactivated`状態にします。
- リレーは現在IDで宣言されているPDSからではない`#account`および`#commit`イベントを無視します。すなわち、これらのイベントは出力firehoseにパススルーしません。また、ローカルのアカウント状態が`active`でないアカウントからの`#commit`イベントも無視します。まとめると、アカウント移行時のリレーからのイベントは`#identity`（新PDSから）、`#account`（新PDSから）、`#commit`（新PDSから）の3つです。旧PDSからの`#account`イベントは通常無視されます。
- 下流サービス（例：AppView）は自身のIDキャッシュを更新し、（`#commit`受信時に）そのアカウントの`rev`を増加させたら、それ以外は何もする必要はありません。

<Heading level={2} id="account-deletion">アカウント削除</Heading>

- PDSは`#account`イベントを`active`がfalseかつ`deleted`状態で送信します。
- リレーはローカルのアカウント状態を更新し、`#account`イベントをパススルーします。リレーが完全なミラーの場合、即座に対象アカウントに関する`getRepo`、`getRecord`および類似APIを止め、エラー応答で理由を示します。リレーはポリシーに基づいて、対象リポジトリのコンテンツをローカルで完全に削除するかもしれません。firehoseのバックフィルウィンドウに時間制限があるなら、ウィンドウからそのリポジトリのコミットイベントを即座に削除する必要はありません。
- PDSは"active"ではないアカウントの`#commit`を送信しません。もしそのリポジトリについて（アクシデントや処理または配送の順番乱れによって）何かしら`#commit`が送信されても、下流のサービスはそのイベントを無視し、パススルーもしません。
- 下流のサービス（例：AppView）は即座にそのアカウントのコンテンツ提供や配布を止め**なければいけません**。恒久的なデータ削除はポリシーによって延期する*かもしれません*。集計（例：レコード数）の更新もポリシーや実装によって遅れたりバックグラウンドキューで処理されるかもしれません。エラーメッセージは"gone"（存在するが利用できない）か"not found"（過去に存在したことも明かさない）を示すかもしれません。

<Note>
下流サービスの挙動はこのガイドで繰り返されるテーマです。ATプロトコルの性質上、下流サービスは[firehoseイベント](/guides/streaming-data)による同期がずれたり、削除要求の処理に失敗することがあります。削除が要求されたりセルフホストPDSで削除されたレコードであっても、リレーに処理されて別のアプリケーションやatproto外のデータモデルに取り込まれた（つまり、レコード要求を元のPDSまで解決しない）場合、まだどこかに存在しているかもしれません。この問題をなるべく緩和するために、firehose上の削除イベントには完全なレコードは[意図的に含まれていません](https://github.com/bluesky-social/indigo/issues/927)。原則として、ホストされているアカウントの信頼できる情報源はPDSであるとみなされる*べき*です。
</Note>

アカウント停止はアカウント削除と同じように働きます。

<Heading level={2} id="deactivation">アカウント無効化</Heading>

- PDSは`#account`イベントを`active`がfalseかつ`deactivated`状態で送信します。
- 削除と同様にリレーはイベントを処理し、コンテンツ再配布は行わず、イベントをパススルーします。リレーはコンテンツを消去しませんが、長期間無効化されたままであれば削除するかもしれません（ポリシー次第）。
- 削除と同様、`#commit`イベントはPDSから送信されず、リレーは受信したとしても無視し、パススルーしません。
- 下流サービス（例：AppView）はコンテンツを利用不可にしますが、ローカルから削除する必要はありません。対象のアカウントやコンテンツのステータスとして"unavailable"を示します。ベストプラクティスは、アカウント無効化によるものだと提示することです。

アカウント凍結はアカウント無効化と同じように働きます。

<Heading level={2} id="account-reactivation">アカウント再有効化</Heading>

- PDSは`#account`イベントを`active`状態で送信します。
- リレーはアカウントの再有効化を検証します（イベントがIDの示すPDSから来ていること等）。ローカルのアカウント状態を更新し、イベントをパススルーします。
- 下流サービス（例：AppView）はローカルのアカウント状態を更新します。
- 対象アカウントの最新のコンテンツを持っていないサービス（過去に削除してしまった等）は、リポジトリの[CAR](/specs/repository#car-file-serialization)エクスポートを取得し、バックグラウンドタスクで処理することがあります。（リレーのような）上流のホストはリポジトリのコピーを持っているかもしれませんし、サービスがそのアカウントのPDSに直接接続するかもしれません。これは必須ではなく、代わりに`#commit`イベントを待つこともあります。
- もしアカウントが過去に削除または長期間無効化されていた場合、ベストプラクティスは再有効化後にPDSが`#commit`イベントを送信して、下流サービスに確実に同期させることです。

<Heading level={2} id="further-reading-and-resources">関連・参考資料</Heading>

- [読み取りと書き込み](/guides/reads-and-writes)
- [データ読み取り](/guides/reading-data)
- [データ書き込み](/guides/writing-data)
- [ソーシャルグラフ](/guides/social-graph)
- [レコードキー仕様](/specs/record-key)
- [URIスキーム](/specs/at-uri-scheme)

export const metadata = {
  title: '계정 수명 주기 이벤트',
  description: '계정 수명 주기 모범 사례',
}

# 계정 수명 주기 모범 사례

이 문서는 계정 수명 주기에 대한 개요를 제공하는 [계정 호스팅](/specs/account) 사양을 보완합니다. 여기에서는 몇 가지 일반적인 계정 수명 주기 전환에 대해 예상되는 동작과, 어떤 순서로 firehose 이벤트가 발생하는지를 요약합니다. 소프트웨어는 부분적이거나 잘못된 이벤트 전송에 대해 견고하게 동작해야 합니다.

**신규 계정 생성:** PDS에서 계정이 등록되고 새로운 아이덴티티(DID)가 생성될 때.

- PDS는 계정의 아이덴티티(DID와 핸들)를 생성하거나 기존의 것을 확인합니다. DID가 네트워크의 다른 서비스에 의해 확인될 수 있는 상태가 되고, 현재 PDS 인스턴스를 가리키면, PDS는 `#identity` 이벤트를 발생시킵니다. (특히 PDS가 계정에 핸들을 제공하는 경우, 제3자가 핸들을 확인할 수 있을 때까지 이벤트 발생을 지연하는 것이 좋지만 필수는 아닙니다.) 이 이벤트 발생 시 계정 상태가 `active`일 수도 있고 아닐 수도 있습니다.
- 계정 생성이 완료되어, PDS가 API 요청에 대해 계정 상태를 `active`로 응답하면, `#account` 이벤트를 발생시킬 수 있습니다.
- 계정의 레포지토리가 `rev`와 `commit`으로 초기화되면, `#commit` 메시지를 발생시킬 수 있습니다. 초기 레포지토리는 "비어있을"(레코드가 없을) 수도 있고, 레코드가 포함되어 있을 수도 있습니다.
- 이벤트의 구체적인 순서는 공식적으로 지정되어 있지 않지만, 권장 순서는: `#identity`, `#account`, `#commit`입니다.
- 다운스트림 서비스는 이 이벤트들을 처리하고 전달합니다.

**계정 마이그레이션:** 아래에서 자세히 설명되지만, 관련 이벤트 및 동작은 다음과 같습니다:

- 새 PDS는 초기 계정 생성 시 아무런 이벤트도 발생시키지 않습니다. 새 PDS에서의 계정 상태는 `deactivated`(비활성화)로 설정되며, API 요청에도 그렇게 응답합니다.
- 아이덴티티가 업데이트되어 새 PDS에서 확인되면, `#identity` 이벤트를 발생시켜야 합니다.
- 새 PDS에서 계정이 `active` 상태로 전환되면, `#account` 이벤트와 `#commit` 이벤트를 발생시켜야 합니다. 구체적인 순서는 필수적이지 않지만, `#account` 이벤트를 먼저 발생시키는 것이 권장됩니다. 이상적으로는 `#commit` 이벤트는 빈 이벤트(새로운 레코드 없음)여야 하지만, 새 서명 키로 서명되고 `rev`가 갱신 또는 증가되어야 합니다.
- 이전 PDS에서 계정이 비활성화되면, 해당 PDS는 계정이 비활성화되었음을 나타내는 `#account` 이벤트를 발생시켜야 합니다.
- 릴레이는 현재 선언된 아이덴티티의 PDS 인스턴스에서 발생하지 않은 `#account` 및 `#commit` 이벤트는 무시해야 하며, 출력 firehose로 전달되어서는 안 됩니다. 또한, 로컬 계정 상태가 `active`가 아닐 때 발생하는 `#commit` 이벤트 역시 무시되어야 합니다. 전반적으로, 계정 마이그레이션은 새 PDS에서 발생한 세 가지 이벤트, 즉 `#identity`, `#account`, `#commit` 이벤트가 릴레이에 의해 전달되어야 하며, 이전 PDS에서 발생한 `#account` 이벤트는 일반적으로 무시됩니다.
- 다운스트림 서비스(예: AppView)는 아이덴티티 캐시를 업데이트하고, `#commit` 이벤트 수신 시 계정의 `rev`를 증가시키지만, 다른 추가 조치는 필요하지 않습니다.

**계정 삭제:**

- PDS는 `active`가 false이며 상태가 `deleted`인 `#account` 이벤트를 발생시킵니다.
- 릴레이는 해당 레포지토리의 로컬 계정 상태를 업데이트하고 `#account` 이벤트를 전달합니다. 릴레이가 전체 미러일 경우, 즉시 `getRepo`, `getRecord` 등과 같은 API 요청에 대해 해당 계정을 제공하지 않으며, 응답 오류에 그 이유를 명시합니다. 릴레이는 현지 정책에 따라 로컬에 저장된 레포지토리 콘텐츠를 완전히 삭제할 수도 있습니다. 백필(backfill) 윈도우에 존재하는 커밋 이벤트를 즉시 삭제할 필요는 없으나, 해당 윈도우가 시간 제한이 있다면 삭제할 수 있습니다.
- PDS는 계정이 "active"하지 않은 상태에서 `#commit` 이벤트를 발생시키지 않아야 합니다. 만약 실수나 순서 문제, 전달 오류 등으로 인해 추가적인 `#commit` 메시지가 발생한다면, 다운스트림 서비스는 해당 이벤트를 무시하고 전달하지 않아야 합니다.
- 다운스트림 서비스(예: AppView)는 즉시 해당 계정의 콘텐츠 제공 및 배포를 중단해야 합니다. 로컬 데이터의 삭제는 현지 정책에 따라 연기될 수 있으며, 집계(예: 레코드 수) 업데이트 역시 백그라운드 큐에서 처리하거나 지연될 수 있습니다. 오류 메시지는 콘텐츠가 "사라졌다"(한때 존재했으나 더 이상 이용 불가) 또는 "찾을 수 없다"(이전에 존재했음을 밝히지 않음)를 나타낼 수 있습니다.

계정 정지는 계정 삭제와 유사하게 동작합니다.

**계정 비활성화:**

- PDS는 `active`가 false이고 상태가 `deactivated`인 `#account` 이벤트를 발생시킵니다.
- 계정 삭제와 유사하게, 릴레이는 해당 이벤트를 처리하고 콘텐츠 재배포를 중단하며, 이벤트를 전달합니다. 릴레이는 로컬 콘텐츠를 완전히 삭제하지 않아야 하지만, 비활성화 상태가 오랫동안 지속될 경우 현지 정책에 따라 로컬 복사본을 삭제할 수도 있습니다.
- 계정 삭제와 유사하게, PDS는 `#commit` 이벤트를 발생시키지 않아야 하며, 만약 발생하더라도 릴레이는 이를 무시하고 전달하지 않아야 합니다.
- 다운스트림 서비스(예: AppViews)는 계정과 관련된 콘텐츠를 제공하지 않아야 하며, 로컬 데이터 삭제는 반드시 필요하지 않습니다. 대신 계정/콘텐츠 상태를 "이용 불가"로 표시하되, 최선의 방법은 계정 비활성화 때문임을 명확히 나타내는 것입니다.

계정 정지도 비활성화와 유사하게 동작합니다.

**계정 재활성화:**

- PDS는 `active` 상태의 `#account` 이벤트를 발생시킵니다.
- 릴레이는 해당 이벤트가 현재 아이덴티티의 PDS 인스턴스에서 발생했는지 확인하고, 계정 재활성화가 유효한지 검증합니다. 이후 로컬 계정 상태를 업데이트하고 이벤트를 전달합니다.
- 다운스트림 서비스(예: AppViews)는 해당 계정의 로컬 계정 상태를 업데이트해야 합니다.
- 만약 서비스가 해당 계정의 최신 레포지토리 콘텐츠(예: 이전에 삭제되어 더 이상 로컬에 존재하지 않음)를 보유하고 있지 않다면, 백그라운드 작업으로 레포지토리 CAR 내보내기를 가져와 처리할 수 있습니다. "업스트림" 호스트(예: 릴레이)가 레포지토리 사본을 보유하고 있거나, 서비스가 직접 계정의 PDS 호스트에 연결할 수도 있습니다. 이는 필수 사항은 아니며, 대신 `#commit` 이벤트를 기다릴 수도 있습니다.
- 계정이 이전에 삭제되었거나 오랜 시간 비활성화된 경우, 다운스트림 서비스와의 동기화를 보장하기 위해 PDS가 재활성화 후 빈 `#commit` 이벤트를 발생시키는 것이 권장됩니다.

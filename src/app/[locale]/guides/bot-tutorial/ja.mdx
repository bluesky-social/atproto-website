import {Heading} from '@/components/Heading'

export const header = {
  title: 'エージェント作成',
  description: 'Blueskyに自動投稿するボットの作成',
}

ボットは、ネットワーク上で自動投稿するアカウントです。直近の地震の規模を投稿するボットや、アーカイブの写真を定期的に投稿するボットなどが人気です。

このチュートリアルでは、[アプリパスワード](/guides/sdk-auth)で認証し、ネットワークとやり取りするボットを作成します。

<Heading level={2} id="prerequisites">前提条件</Heading>

このチュートリアルでは、TypeScriptアプリケーションをゼロから構築します。TypeScriptとNode.jsの基本的な理解を前提としています。

以下をインストールしておいてください。
- Node.js 18以上

[homebrew](https://brew.sh/)に対応したプラットフォームでは、次のコマンドでインストールできます。

```bash
brew install node
```

さらに、`lex` CLIツールをグローバルにインストールしておく必要があります。

```bash
npm install -g @atproto/lex
```

次に、新しいTypeScriptプロジェクトディレクトリを作成し、プロジェクトを初期化します。

```bash
mkdir my-agent
cd my-agent
npm init -y
npm i -D typescript ts-node @types/node dotenv cron @atproto/lex @atproto/lex-password-session
npx tsc --init --verbatimModuleSyntax false
```

既存アカウントから投稿するつもりでなければ、ボット用に[新しいアカウントを作成](https://bsky.app/)してください。また、そのアカウント用の[アプリパスワード](/guides/sdk-auth)も生成してください。

<Heading level={2} id="part-1-lexicons">パート1：Lexion</Heading> 

[Lexicon](/guides/lexicon)はAtprotoのレコードを定義します。ボットは[app.bsky.feed.post](https://lexicon.garden/lexicon/did:plc:4v4y5r3lwsbtmsxhile2ljac/app.bsky.feed.post) Lexiconを使ってBluesky投稿を作成します。`lex`を使えば、このLexiconをダウンロードしてプロジェクトに組み込めます。

```bash
lex install app.bsky.feed.post
```

必要であれば、ダウンロードしたLexiconファイルを`lib/lexicons/app.bsky.post.json`で確認できます。ここから`lex build`を実行すると、インストール済みLexiconすべてに対してTypeScriptの型を生成できます。

```bash
lex build
```

生成されたコードは`src/lexicons`に配置されます。これでボットスクリプトを作成できます。

<Heading level={2} id="part-2-create-a-bot">パート2：ボット作成</Heading>

`src/index.ts`に新しいファイルを作成してください。このファイルにボットのコードを書きます。

まず必要なimportを追加し、`PasswordSession.create()`を呼び出してアプリパスワードでボットを認証します。

```ts
import { Client } from '@atproto/lex'
import { PasswordSession } from '@atproto/lex-password-session'
import * as dotenv from 'dotenv'
import { CronJob } from 'cron'
import * as process from 'process'
import * as app from './lexicons/app.js'

dotenv.config()

// セッション生成
async function login() {
    const service = process.env.BOT_PDS!
    const identifier = process.env.BOT_HANDLE!
    const password = process.env.BOT_PASSWORD!
    const session = await PasswordSession.login({
        service, // eg 'https://bsky.social'
        identifier, // eg 'alice.bsky.social'
        password,
    })

    return session
}
```

次に、投稿する関数を追加します。認証済みセッションを使って新しい`Client`を生成し、投稿を作成します。`app.bsky.feed.post` Lexiconには2つのパラメータが必要です。投稿本文（ここでは"🙂"）とタイムスタンプです。

```ts
// 投稿ロジック
async function makePost(session: PasswordSession) {
    const client = new Client(session)
    await client.create(app.bsky.feed.post, {
        text: '🙂',
        createdAt: new Date().toISOString(),
    })
    console.log('Just posted!')
}

async function main() {
    const session = await login()
    await makePost(session)
}

main().catch(console.error)
```

最後に、`cron`パッケージを使って、3時間ごとに投稿するコードを`main()`に追加します。

```ts
async function main() {
    const session = await login()
    await makePost(session)
    // cronジョブで実行
    const scheduleExpression = '0 */3 * * *'
    const job = new CronJob(scheduleExpression, () => makePost(session))
    job.start()
}
```

これでボットに必要なコードはすべて揃いました。次は動作確認です。

<Heading level={2} id="part-3-run-the-bot">パート3：ボット実行</Heading>

ボットのホスト（PDS）、ユーザー名、パスワードを`.env`ファイルに保存します。

```bash
BOT_PDS= # eg 'https://bsky.social' （セルフホストPDSの場合はそのURLを使用）
BOT_HANDLE= # eg 'alice.bsky.social'
BOT_PASSWORD=
```

これで`ts-node`を使ってボットをテストできます。

```bash
ts-node src/index.ts
```

このボットは手元のマシンで実行することも、[Fly.io](http://fly.io/) のようなプラットフォームにデプロイすることもできます。

ボットはネットワークのレート制限を守る必要がある点に注意してください。例えば、[Blueskyには独自のレート制限があります](https://docs.bsky.app/docs/advanced-guides/rate-limits)。 

<Heading level={2} id="part-4-from-bot-to-agent">パート4：ボットからエージェントへ</Heading>

ここまでは、一定間隔で投稿するボットを作成してきました。ここからは、他のユーザーとやり取りできる、より高度なエージェントへ拡張していきます。

このセクションでは、[Vercel AI SDK](https://www.npmjs.com/package/ai)を使います。このライブラリは、Vercel AI Gateway経由でAnthropicなどのモデルプロバイダーを統一されたAPIで利用できます。APIキーを取得するには、無料の[Hobby project](https://vercel.com/)に登録する必要があります。

APIキーを取得したら、プロジェクトにAI SDKを追加します。

```bash
npm i ai
```

次に、`.env`ファイルへ環境変数を1つ追加します。

```bash
BOT_PDS=
BOT_HANDLE=
BOT_PASSWORD=
AI_GATEWAY_API_KEY=xxxxxxxxx
```

最後に、メンション取得のため追加のLexiconをインストールする必要があります。次のコマンドで必要なLexiconのインストールとビルドを行います。

```bash
lex install app.bsky.notification.listNotifications app.bsky.feed.getPostThread
lex build --override
```

あと少しです。`src/index.ts`に`ai`のimportを追加します。

```ts
import { generateText } from 'ai'
```

これで、スクリプト内の`login`関数以降を、AI SDKを使ってリプライを生成する新しいロジックに置き換えられます。

```ts
async function generateReply(mentionText: string): Promise<string> {
  const { text } = await generateText({
    model: 'anthropic/claude-sonnet-4-5',
    system: 'You are a mystical fortune teller bot on Bluesky named "The Oracle". Speak in a dramatic, mysterious tone with occasional emoji (🔮 ✨ 🌙 ⭐). If someone asks a yes/no question, give a cryptic but leaning answer. If they ask for general guidance, offer a brief horoscope-style prediction. Keep responses under 280 characters. Never break character.',
    prompt: mentionText,
  })
  return text
}

// 新着メンションとリプライを確認
async function checkMentions(session: PasswordSession) {
  const client = new Client(session)
  const notifications = await client.call(app.bsky.notification.listNotifications, {
    limit: 20,
  })

  for (const notif of notifications.notifications) {
    // 未読メンションのみを処理
    if (notif.reason !== 'mention' || notif.isRead) continue

    // メンション元の投稿を取得
    const post = await client.call(app.bsky.feed.getPostThread, {
      uri: notif.uri,
    })

    const mentionText = post.thread.post.record.text
    const reply = await generateReply(mentionText)

    // 投稿にリプライ
    await client.create(app.bsky.feed.post, {
      text: reply,
      createdAt: new Date().toISOString(),
      reply: {
        root: { uri: notif.uri, cid: post.thread.post.cid },
        parent: { uri: notif.uri, cid: post.thread.post.cid },
      },
    })

    console.log(`Replied to mention: ${mentionText}`)
  }
}

async function main() {
    const session = await login()
    const job = new CronJob('*/1 * * * *', () => checkMentions(session))
    job.start()

    console.log('Agent is running...')
}

main().catch(console.error)
```

ここではいくつか新しい概念が出てきます。`app.bsky.feed.post`のロジックは見覚えがあるはずですが、ここではさらに`app.bsky.notification.listNotifications`と`app.bsky.feed.getPostThread`も使用します。前者は通知一覧の取得に使い、後者は指定した投稿URIのスレッド全体を取得するために使います。

もちろん、プロンプトの内容は好きなように変更してください。

ボットを再デプロイすれば、メンションに返信するようになります。

<Note>
アカウントへ定期的に投稿するボットは、このネットワークでは歓迎されています。ボットが他のユーザーとやり取りすること（いいね、リポスト、リプライなど）は、そのユーザーがボットアカウントをタグ付けしたときだけにしてください。オプトイン型のやり取りであるべきで、そうでない場合はスパムとして報告される可能性があります。
</Note>

<Heading level={2} id="conclusion">結論</Heading>

これで、ネットワーク上にレコードを作成する自動化されたAtprotoアプリを構築できました。

さらに多くのガイドやチュートリアルは[Guides](/guides)セクションで、より多くのサンプルアプリは[Cookbook](https://github.com/bluesky-social/cookbook/)リポジトリで確認できます。ぜひ開発を楽しんでください。

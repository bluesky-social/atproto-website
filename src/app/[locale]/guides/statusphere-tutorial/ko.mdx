import {Container} from "@/components/Container"
import setstatus from "./set-status.png"
import pdsls from "./pdsls-status.png"
import tap from "./tap-status.png"
import feed from "./feed-status.png"

export const header = {
  title: 'Create a Social App',
  description: 'Build an app that lets you broadcast and receive status updates using AT Record Lexicons.',
}

ì´ íŠœí† ë¦¬ì–¼ì—ì„œëŠ” ì‚¬ìš©ì ì •ì˜ ì–´íœ˜ì§‘(Lexicon)ê³¼ ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ í™œìš©í•˜ì—¬ ìƒíƒœ ì„¤ì • ì•±ì„ êµ¬ì¶•í•©ë‹ˆë‹¤.
ì´ íŠœí† ë¦¬ì–¼ì˜ ì†ŒìŠ¤ ì½”ë“œì™€ ë‹¤ë¥¸ ì˜ˆì œ í”„ë¡œì íŠ¸ëŠ” [Cookbook](https://github.com/bluesky-social/cookbook/) ì €ì¥ì†Œì˜ `statusphere` ë””ë ‰í„°ë¦¬ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
## í•„ìˆ˜ ì¡°ê±´
ë³¸ íŠœí† ë¦¬ì–¼ì€ [NextJSë¥¼ í™œìš©í•œ OAuth íŠœí† ë¦¬ì–¼](/guides/oauth-tutorial)ì—ì„œ ìƒì„±í•œ ì•±ì„ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤. ì‹œì‘í•˜ê¸° ì „ì— NextJS OAuth ì•±ì„ ì™„ì„±í•´ ë‘ì…”ì•¼ í•©ë‹ˆë‹¤. í•´ë‹¹ ë‹¨ê³„ë¥¼ ê±´ë„ˆë›°ê³  ì‹¶ë‹¤ë©´ [Cookbook]( (https://github.com/bluesky-social/nextjs-oauth-tutorial/tree/129cf28b4146ae709e0dac43ce20154ab5237559)ì—ì„œ ì™„ì„±ëœ OAuth ì•±ì„ ë³µì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ë‹¤ìŒì´ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤:
- Node.js 18 ì´ìƒ
- Go 1.25 ì´ìƒ
- pnpm íŒ¨í‚¤ì§€ ê´€ë¦¬ì
[homebrew](https://brew.sh/)ê°€ ì§€ì›í•˜ëŠ” í”Œë«í¼ì—ì„œëŠ” ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
brew install node pnpm go
```
ê¸°ì¡´ í”„ë¡œì íŠ¸ì— ë‹¤ìŒ Atproto ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”:
```bash
pnpm add @atproto/common-web @atproto/lex @atproto/syntax @atproto/tap
```
ë˜í•œ `lex` CLI ë„êµ¬ë¥¼ ì „ì—­ìœ¼ë¡œ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤:
```bash
npm install -g @atproto/lex
```
í”„ë¡œì íŠ¸ì— ì–´íœ˜ì§‘(Lexicon)ì„ ì¶”ê°€í•˜ëŠ” ê²ƒìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.
## íŒŒíŠ¸ 1: ì–´íœ˜ì§‘
[ì–´íœ˜ì§‘](/guides/lexicon)ì€ Atproto ë‚´ ë ˆì½”ë“œì˜ ìŠ¤í‚¤ë§ˆë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ë³¸ íŠœí† ë¦¬ì–¼ì„ ìœ„í•´ ì €í¬ëŠ” ì´ë¯¸ ìƒˆë¡œìš´ "Statusphere" Lexiconì„ `xyz.statusphere.status`ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `lex`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ Lexiconì„ ë‹¤ìš´ë¡œë“œí•˜ê³  í”„ë¡œì íŠ¸ì— ë¹Œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
lex install xyz.statusphere.status
```
ì›í•œë‹¤ë©´ ë‹¤ìš´ë¡œë“œëœ Lexicon íŒŒì¼ì„ `lib/lexicons/ xyz.statusphere.status.json`ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œ `lex build`ë¥¼ ì‹¤í–‰í•˜ë©´ ì„¤ì¹˜ëœ ëª¨ë“  ë ˆì‹ì½˜ì— ëŒ€í•œ TypeScript íƒ€ì…ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
lex build --importExt=\"\"
```
<Note>
í•„ìš”í•˜ë‹¤ë©´ ì´ ëª…ë ¹ì–´ë¥¼ `package.json`ì— ì¶”ê°€í•  ìˆ˜ ìˆì§€ë§Œ, ì‚¬ì „ì´ ë¹Œë“œëœ ìƒíƒœì—ì„œ ì´ íŠœí† ë¦¬ì–¼ì—ì„œëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šì„ ê²ƒì…ë‹ˆë‹¤. `lex install`ë¡œ í”„ë¡œì íŠ¸ì— ë‹¤ë¥¸ ì‚¬ì „ì„ ì¶”ê°€í•  ê²½ìš°, ` --override` í”Œë˜ê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ `lex build`ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
</Note>
ì§€ê¸ˆ í•´ì•¼ í•  í•œ ê°€ì§€ ë”ëŠ” `lib/auth/client.ts` íŒŒì¼ì˜ `SCOPE` ìƒìˆ˜ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ì´ ì»¬ë ‰ì…˜ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ìš”ì²­í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. Atproto ê¶Œí•œ ë²”ìœ„ëŠ” Lexiconsì´ë¯€ë¡œ ì•±ì´ ìš”ì²­í•˜ëŠ” ë²”ìœ„ ëª©ë¡ì— `xyz.statusphere.status`ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```typescript
export const SCOPE = "atproto repo:xyz.statusphere.status";
```
ì´ì œ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ìƒì„±ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
## íŒŒíŠ¸ 2: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ
`lib/db/index.ts`ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ìƒˆ í…Œì´ë¸”ì„ ì¶”ê°€í•˜ì„¸ìš”:
```typescript
export interface DatabaseSchema {
  auth_state: AuthStateTable;
  auth_session: AuthSessionTable;
  account: AccountTable;   // ì‹ ê·œ
  status: StatusTable;     // ì‹ ê·œ
}
// ... ê¸°ì¡´ ì¸ì¦ í…Œì´ë¸” ...
export interface AccountTable {
  did: string;
  handle: string;
  active: 0 | 1;
}
export interface StatusTable {
  uri: string;
  authorDid: string;
  status: string;
  createdAt: string;
  indexedAt: string;
  current: 0 | 1;
}
```
ë‹¤ìŒìœ¼ë¡œ, ì´ í…Œì´ë¸”ë“¤ì„ ìƒì„±í•˜ëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤. OAuth íŠœí† ë¦¬ì–¼ì„ ê¸°ë°˜ìœ¼ë¡œ êµ¬ì¶• ì¤‘ì´ê³  ì´ë¯¸ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë°°í¬/ë§ˆì´ê·¸ë ˆì´ì…˜í•œ ê²½ìš°, ì´ë“¤ì„ `lib/db/migrations.ts`ì— "002"ì™€ ê°™ì€ ìƒˆ ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤:
```typescript
const migrations: Record<string, Migration> = {
  "001": {} // ì¸ì¦ í…Œì´ë¸”ìš© ê¸°ì¡´ ë§ˆì´ê·¸ë ˆì´ì…˜
  "002": {
    async up(db: Kysely<unknown>) {
      
await db.schema
        .createTable("account")
        .addColumn("did", "text", (col) => col.primaryKey())
        .addColumn("handle", "text", (col) => col.notNull())
        .addColumn('active', "integer", (col) => col.notNull().defaultTo(1))
        .execute();
      
await db.schema
 
        .createTable("status")
        .addColumn("uri", "text", (col) => col.primaryKey())
        .addColumn('authorDid', "text", (col) => col.notNull())
        
.addColumn("status", "text", (col) => col.notNull())
        .addColumn("createdAt", "text", (col) => col.notNull())
        .addColumn("indexedAt", "text", (col) => col.notNull())
        .addColumn('current', "integer", (col) => col.notNull().defaultTo(0))
        
.execute();
      await db.schema
        .createIndex("status_current_idx")
        .on("status")
        .columns(['current', "indexedAt"])
        .execute ();
    },
    async down(db: Kysely<unknown>) {
      await db.schema.dropTable("status").execute();
      await db.schema.dropTable('account').execute();
      await db.schema.dropTable("auth_session").execute ();
      await db.schema.dropTable("auth_state").execute();
    },
  },
};
```
`pnpm migrate`ë¥¼ ì‹¤í–‰í•˜ì—¬ ì´ëŸ¬í•œ ìƒˆë¡œìš´ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ì œ ì‹¤ì œ ì•± ë¡œì§ì„ êµ¬ì¶•í•´ ë³´ê² ìŠµë‹ˆë‹¤!
## íŒŒíŠ¸ 3: ìƒíƒœ ì œì¶œ
ë¨¼ì € ì‚¬ìš©ìê°€ ìì‹ ì˜ [PDS](/guides/the-at-stack#pds)ì— ìƒíƒœë¥¼ ì‘ì„±í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ êµ¬ì¶•í•©ë‹ˆë‹¤. `app/api/status/route.ts`ì— ìƒˆ API ê²½ë¡œë¥¼ ìƒì„±í•˜ì„¸ìš”:
```typescript
import { NextRequest, NextResponse } from "next/server";
import { Client } from "@atproto/lex";
import { getSession } from "@/lib/auth/session";
import { getOAuthClient } from "@/lib/auth/client";
import * as xyz from "@/src/lexicons/xyz";
export async function POST(request: NextRequest) {
  const session = await getSession();
  
if (!session) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  const { status } = await request.json();
  if (!status || typeof status !== 'string') {
    return NextResponse.json({ error: "Status is required" }, { status: 400 });
  
}
  const client = await getOAuthClient();
  const oauthSession = await client.restore(session.did);
  const lexClient = new Client(oauthSession);
  const createdAt = new Date().toISOString();
  const res = await lexClient.create(xyz.statusphere.status, {
    status,
    
createdAt,
  });
  return NextResponse.json({
    success: true,
    uri: res.uri,
  });
```
ì´ ì½”ë“œëŠ” ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í–ˆëŠ”ì§€ í™•ì¸í•˜ê³ , OAuth ì„¸ì…˜ì„ ì‚¬ìš©í•´ lex `Client`ë¥¼ ìƒì„±í•œ í›„ ì œì¶œëœ ìƒíƒœ í…ìŠ¤íŠ¸ë¡œ ìƒˆë¡œìš´ `xyz.statusphere.status` ë ˆì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
ë‹¤ìŒìœ¼ë¡œ `components/StatusPicker.tsx`ì— ìƒíƒœ ì„ íƒê¸° ì»´í¬ë„ŒíŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”:
```tsx
"use client";
import { useState } from "react";
import { useRouter } from "next/navigation";
const EMOJIS = ["ğŸ‘", "ğŸ‘", "ğŸ’™", "ğŸ”¥", "ğŸ˜†", "ğŸ˜¢", "ğŸ¤”", "ğŸ˜´", "ğŸ‰", "ğŸ¤©", "ğŸ˜­", "ğŸ¥³", "ğŸ˜¤", "ğŸ’€", "âœ¨", "ğŸ‘€", "ğŸ™", "ğŸ“š", "ğŸ’»", "ğŸ•", "ğŸŒ´"];
interface StatusPickerProps {
  currentStatus?: string | null;
}
export function StatusPicker({ currentStatus }: StatusPickerProps) {
  const router = useRouter();
  const [selected, setSelected] = useState<string | null>(currentStatus ?? null);
  const [loading, setLoading] = useState(false);
  
async function handleSelect(emoji: string) {
    setLoading(true);
    
setSelected(emoji);
    try {
      const res = await fetch("/api/status", {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: emoji }),
      });
      
if (!res.ok) {
        throw new Error("ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
      }
      router.refresh();
    } catch (err) {
      console.error("ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", err);
      
setSelected(currentStatus ?? null);
    } finally {
      setLoading(false);
    }
  }
  return (
    <div>
      <p className="text-sm text-zinc-500 dark:text-zinc-400 mb-3">
        ìƒíƒœ ì„¤ì •
      
</p>
      <div className="flex flex-wrap gap-2">
        {EMOJIS.map((emoji) => (
          <button
            key={emoji}
            onClick={() => handleSelect(emoji)}
            disabled={loading}
            className={`text-2xl p-2 rounded-lg transition-all
              
${selected === emoji
                ? "bg-blue-100 dark:bg-blue-900 ring-2 ring-blue-500"
                : "hover:bg-zinc-100 dark:hover:bg-zinc-800"
              }
              disabled:opacity-50 disabled:cursor-not-allowed`}
          >
            
{emoji}
          </button>
        ))}
      </div>
    </div>
  );
}
```
ë§ˆì§€ë§‰ìœ¼ë¡œ `app/page.tsx`ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ìƒíƒœ ì„ íƒê¸°ë¥¼ í¬í•¨ì‹œí‚µë‹ˆë‹¤:
```tsx
import { getSession } from "@/lib/auth/session";
import { LoginForm } from "@/components/LoginForm";
import { LogoutButton } from "@/components/LogoutButton";
import { StatusPicker } from "@/components/StatusPicker";
export default async function Home() {
  
const session = await getSession();
  return (
    <div className="flex min-h-screen items-center justify-center bg-zinc-50 dark:bg-zinc-950">
      <main className="w-full max-w-md mx-auto p-8">
        <div className="text-center mb-8">
          
<h1 className="text-3xl font-bold text-zinc-900 dark:text-zinc-100 mb-2">
            Statusphere
          </h1>
          <p className="text-zinc-600 dark:text-zinc-400">
            Atmosphereì—ì„œ ìƒíƒœ ì„¤ì •í•˜ê¸°
          
</p>
        </div>
        <div className="bg-white dark:bg-zinc-900 rounded-lg border border-zinc-200 dark:border-zinc-800 p-6">
          {session ? (
            <div className="space-y-4">
              <div className="flex items-center justify-between mb-4">
                
<p className="text-sm text-zinc-500 dark:text-zinc-400">
                  ë¡œê·¸ì¸ë¨
                </p>
                <LogoutButton />
              </div>
              <StatusPicker />
            </div>
          ) : (
            <LoginForm />
          )}
        </div>
      </main>
    </div>
  );
}
```
`pnpm dev`ë¡œ ì•±ì„ ì‹¤í–‰í•˜ì„¸ìš” â€” ë¡œê·¸ì¸í•˜ê³  ì´ëª¨ì§€ë¥¼ ì„ íƒí•´ ìƒíƒœë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
<Container>
  <Image src={setstatus} alt="" className="w-full max-w-md mx-auto" />
</Container>
ì´ ì•±ì—ì„œëŠ” ì•„ì§ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ì§€ë§Œ, [pdsls](https:// pdsls.dev)ì—ì„œ ê³„ì •ì„ ì¡°íšŒí•˜ê³  `xyz.statusphere.status` ì–´íœ˜ë¥¼ í™•ì¸í•˜ì—¬ ì´ ê¸°ë¡ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<Container>
  <Image src={pdsls} alt="" className="w-full max-w-md mx-auto" />
</Container>
ë‹¤ìŒìœ¼ë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ì‹¤ì œë¡œ ìˆ˜ì‹ í•˜ê¸° ìœ„í•œ ë™ê¸°í™” ê¸°ëŠ¥ì„ ì¶”ê°€í•  ê²ƒì…ë‹ˆë‹¤.
## íŒŒíŠ¸ 4: Tapì„ ì´ìš©í•œ ì‹¤ì‹œê°„ ë™ê¸°í™”
[Tap](/guides/backfilling#using-tap)ì€ AT Protocol ë ˆì½”ë“œë¥¼ ë™ê¸°í™”í•˜ê³  ìŠ¤íŠ¸ë¦¬ë°í•˜ëŠ” ê°€ì¥ ì¢‹ì€ ë°©ë²•ì…ë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ì˜ ìƒˆ ë ˆì½”ë“œë¥¼ ë™ê¸°í™”í•˜ê¸° ìœ„í•´ Tap [TypeScript ë¼ì´ë¸ŒëŸ¬ë¦¬](https://www.npmjs.com/package/@atproto/tap)ë¥¼ ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤. `lib/tap/index.ts`ë¥¼ ìƒì„±í•˜ì„¸ìš”:
```typescript
import { Tap } from "@atproto/tap";
const TAP_URL = process.env.TAP_URL || "http://localhost:2480";
let _tap: Tap | null = null;
export const getTap = (): Tap => {
  if (!_tap) {
    _tap = new Tap(TAP_URL);
  
}
  return _tap;
};
```
ë‹¤ìŒìœ¼ë¡œ, Tap ì´ë²¤íŠ¸ ì²˜ë¦¬ë¥¼ ìœ„í•œ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ë¥¼ í¬í•¨í•˜ëŠ” `lib/db/queries.ts`ë¥¼ ìƒì„±í•©ë‹ˆë‹¤:
```typescript
import { getDb, AccountTable, StatusTable, DatabaseSchema } from ".";
import { AtUri } from "@atproto/syntax";
import { Transaction } from "kysely";
export async function getAccountStatus(did: string) {
  const db = getDb();
  const status = await db
    .selectFrom("status")
    .selectAll()
    .where("authorDid", "=", did)
    .orderBy('createdAt', "desc")
    
.limit(1)
    .executeTakeFirst();
  return status ?? null;
}
export async function insertStatus(data: StatusTable) {
  getDb()
    .transaction()
    .execute(async (tx) => {
      await tx
        .insertInto("status")
        .values(data)
        
.onConflict((oc) =>
          oc.column("uri").doUpdateSet({
            status: data.status,
            createdAt: data.createdAt,
            indexedAt: data.indexedAt,
          }),
        )
        .execute();
      setCurrStatus(tx, data.authorDid);
    
});
}
export async function deleteStatus(uri: AtUri) {
  await getDb()
    .transaction()
    .execute(async (tx) => {
      await tx.deleteFrom("status").where('uri', "=", uri.toString()).execute();
      await setCurrStatus(tx, uri.hostname);
    
});
}
export async function upsertAccount(data: AccountTable) {
  await getDb()
    .insertInto("account")
    .values(data)
    .onConflict((oc) =>
      oc.column("did").doUpdateSet({
        handle: data.handle,
        active: data.active,
      }),
    )
    
.execute();
}
export async function deleteAccount(did: string) {
  await getDb().deleteFrom("account").where("did", "=", did).execute();
  await getDb().deleteFrom("status").where('authorDid', "=", did).execute();
}
// ì‚¬ìš©ìì˜ "í˜„ì¬" ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜ (íŠ¸ëœì­ì…˜ ë‚´ë¶€ì—ì„œ ì‚¬ìš©)
async function setCurrStatus(tx: Transaction<DatabaseSchema>, did: string) {
  // ëª¨ë“  ì‚¬ìš©ìì˜ ìƒíƒœì— ëŒ€í•œ í˜„ì¬ í”Œë˜ê·¸ ì§€ìš°ê¸°
  await tx
    .updateTable("status")
    .set({ current: 0 })
    .where("authorDid", "=", did)
    .where('current', "=", 1)
    .execute ();
  // ê°€ì¥ ìµœê·¼ ìƒíƒœë¥¼ í˜„ì¬ ìƒíƒœë¡œ ì„¤ì •
  await tx
    .updateTable("status")
    .set({ current: 1 })
    .where("uri", "=", (qb) =>
      qb
        .selectFrom("status")
        .select("uri")
        .where('authorDid', "=", did)
        
.orderBy("createdAt", "desc")
        .limit(1),
    )
    .execute();
}
```
`setCurrStatus` í—¬í¼ëŠ” ì‚¬ìš©ìë‹¹ ê°€ì¥ ìµœê·¼ ìƒíƒœë§Œ `current = 1`ì´ ë˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤. ì´ëŠ” ë‚˜ì¤‘ì— ì‚¬ìš©ë  ê²ƒì…ë‹ˆë‹¤.
Tapì€ `app/api/webhook/route.ts`ì˜ ì›¹í›… ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•´ ì´ë²¤íŠ¸ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤:
```typescript
import { NextRequest, NextResponse } from "next/server";
import { parseTapEvent, assureAdminAuth } from "@atproto/tap";
import { AtUri } from "@atproto/syntax";
import {
  
upsertAccount,
  insertStatus,
  deleteStatus,
  deleteAccount,
} from "@/lib/db/queries";
import * as xyz from "@/src/lexicons/xyz";
const TAP_ADMIN_PASSWORD = process.env.TAP_ADMIN_PASSWORD;
export async function POST(request: NextRequest) {
  // ìš”ì²­ì´ TAP ì„œë²„ì—ì„œ ì˜¨ ê²ƒì¸ì§€ í™•ì¸
  if (TAP_ADMIN_PASSWORD) {
    const authHeader = request.headers.get("Authorization");
    if (!authHeader) {
      
return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }
    try {
      assureAdminAuth(TAP_ADMIN_PASSWORD, authHeader);
    } catch {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }
  
}
  const body = await request.json();
  const evt = parseTapEvent(body);
  // ê³„ì •/ì‹ ì› ë³€ê²½ ì²˜ë¦¬
  if (evt.type === "identity") {
    if (evt.status === "deleted") {
      
await deleteAccount(evt.did);
    } else {
      await upsertAccount({
        did: evt.did,
        handle: evt.handle,
        active: evt.isActive ? 1 : 0,
      });
    }
  }
  // ìƒíƒœ ë ˆì½”ë“œ ë³€ê²½ ì²˜ë¦¬
  if (evt.type === "record") {
    
const uri = AtUri.make(evt.did, evt.collection, evt.rkey);
    if (evt.action === "create" || evt.action === "update") {
      let record: xyz.statusphere.status.Main;
      try {
        record = xyz.statusphere.status.$parse(evt.record);
      
} catch {
        return NextResponse.json({ success: false });
      }
      await insertStatus({
        uri: uri.toString(),
        authorDid: evt.did,
        status: record.status,
        
createdAt: record.createdAt,
        indexedAt: new Date().toISOString(),
        current: 1,
      });
    } else if (evt.action === "delete") {
      await deleteStatus(uri);
    }
  }
  return NextResponse.json( { success: true });
}
```
Tapì€ ë„¤íŠ¸ì›Œí¬ ì–´ë””ì—ì„œë“  ë ˆì½”ë“œê°€ ë³€ê²½ë  ë•Œ ì›¹í›… ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤. ìš”ì²­ì€ ê³µìœ  ë¹„ë°€ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ê²€ì¦ë©ë‹ˆë‹¤. `identity` ì´ë²¤íŠ¸ì˜ ê²½ìš° ê³„ì • ìºì‹œë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ , `record` ì´ë²¤íŠ¸ì˜ ê²½ìš° ë ˆì½”ë“œê°€ ì–´íœ˜ì§‘(Lexicon)ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•œ í›„ ë°ì´í„°ë² ì´ìŠ¤ì— ì‚½ì…/ì—…ë°ì´íŠ¸/ì‚­ì œí•©ë‹ˆë‹¤.
í˜„ì¬ ì‚¬ìš©ìì˜ ìƒíƒœë¥¼ ê°€ì ¸ì™€ ì „ë‹¬í•˜ë„ë¡ `app/page.tsx`ë¥¼ ë‹¤ì‹œ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”:
```tsx
import { getAccountStatus } from "@/lib/db/queries";
// Home í•¨ìˆ˜ ë‚´:
const accountStatus = session ? await getAccountStatus(session.did) : null;
// StatusPicker ìš”ì†Œì— ì¶”ê°€:
<StatusPicker currentStatus={accountStatus?.status} />
```
ì´ë ‡ê²Œ í•˜ë©´ í˜ì´ì§€ ë¡œë“œ ì‹œ `StatusPicker`ê°€ ì‚¬ìš©ìì˜ í˜„ì¬ ìƒíƒœë¥¼ ê°•ì¡° í‘œì‹œí•©ë‹ˆë‹¤.
ì´ì œ ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ ì†ŒìŠ¤ ì €ì¥ì†Œì—ì„œ `tap`ì„ ì„¤ì¹˜í•˜ê³  ì‹¤í–‰í•˜ì„¸ìš”:
```bash
go install github.com/bluesky-social/indigo/cmd/tap
tap run --webhook-url=http://localhost:3000/api/webhook --collection-filters=xyz.statusphere.status
```
ì‹¤í–‰ ì¤‘ì¸ ì•±ì„ Ctrl+Cë¡œ ì¤‘ì§€í•˜ì„¸ìš”. ê·¸ëŸ° ë‹¤ìŒ ì¶”ì ì„ ìœ„í•´ ë°ì´í„° ì €ì¥ì†Œë¥¼ Tapì— ì¶”ê°€í•©ë‹ˆë‹¤(ë‚˜ì¤‘ì— ë‹¤ë¥¸ ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì¶”ê°€í•  ì˜ˆì •ì…ë‹ˆë‹¤):
```bash
# ì•„ë˜ì— ë³¸ì¸ DIDë¡œ ëŒ€ì²´
curl -H 'Content-Type: application/json' -d '{"dids":["DID"]}' http://localhost:2480/repos/add
```
`pnpm dev`ë¡œ ì•±ì„ ì¬ì‹œì‘í•˜ê³  ë¡œê·¸ì¸ ì ˆì°¨ë¥¼ ì™„ë£Œí•˜ë©´ ì €ì¥ëœ ìƒíƒœê°€ ê°•ì¡° í‘œì‹œë©ë‹ˆë‹¤:
<Container>
  
<Image src={tap} alt="" className="w-full max-w-md mx-auto" />
</Container>
## íŒŒíŠ¸ 5: í•¸ë“¤ ë° í”¼ë“œ í‘œì‹œ
ë§ˆì§€ë§‰ìœ¼ë¡œ ì‚¬ìš©ì í•¸ë“¤ê³¼ ëª¨ë“  ì‚¬ìš©ìì˜ ìƒíƒœ í”¼ë“œë¥¼ í‘œì‹œí•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
ë¨¼ì € `lib/db/queries.ts`ì— ì¶”ê°€ ì„í¬íŠ¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš”:
```typescript
import { getHandle } from "@atproto/common-web";
import { getTap } from "@/lib/tap";
```
ê·¸ëŸ° ë‹¤ìŒ ê³„ì • í•¸ë“¤ê³¼ ìƒíƒœë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¶”ê°€ í•¨ìˆ˜ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤:
```typescript
export async function getAccountHandle(did: string): Promise<string | null> {
  const db = getDb();
  // Tapì„ í†µí•´ ê³„ì •ì„ ì¶”ì í•˜ê³  ê³„ì • ì •ë³´ë¥¼ ì–»ì€ ê²½ìš°, í•´ë‹¹ ì •ë³´ì—ì„œ ë¡œë“œí•©ë‹ˆë‹¤
  const account = await db
    .selectFrom("account")
    .select("handle")
    
.where("did", "=", did)
    .executeTakeFirst();
  if (account) return account.handle;
  // ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ Tapì„ í†µí•´ ê³„ì • DIDë¥¼ í•´ê²°í•©ë‹ˆë‹¤. Tapì€ ì‹ ì› ìºì‹±ì„ ì œê³µí•©ë‹ˆë‹¤.
  try {
    const didDoc = await getTap().resolveDid(did);
    if (!didDoc) return null;
    return getHandle(didDoc) ?? null;
  
} catch {
    return null;
  }
}
export async function getRecentStatuses(limit = 5) {
  const db = getDb ();
  return db
    .selectFrom("status")
    .innerJoin("account", "status.authorDid", "account.did")
    .selectAll()
    .orderBy('createdAt', "desc")
    .limit(limit)
    .execute();
}
export async function getTopStatuses(limit = 10) {
  const db = getDb ();
  return db
    .selectFrom("status")
    .select(["status", db.fn.count("uri").as("count")])
    .where("current", "=", 1)
    .groupBy('status')
    .orderBy("count", "desc")
    .limit(limit)
    .execute();
}
```
ë‹¤ìŒìœ¼ë¡œ `app/page.tsx`ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ìƒìœ„ ìƒíƒœ, í•¸ë“¤, íƒ€ì„ìŠ¤íƒ¬í”„ê°€ í¬í•¨ëœ ì „ì²´ í”¼ë“œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤:
```tsx
import { getSession } from "@/lib/auth/session";
import {
  getAccountStatus,
  getRecentStatuses,
  getTopStatuses,
  
getAccountHandle,
} from "@/lib/db/queries";
import { LoginForm } from "@/components/LoginForm";
import { LogoutButton } from "@/components/LogoutButton";
import { StatusPicker } from "@/components/StatusPicker";
export default async function Home() {
  
const session = await getSession();
  const [statuses, topStatuses, accountStatus, accountHandle] =
    await Promise.all([
      getRecentStatuses(),
      getTopStatuses(),
      session ? getAccountStatus(session.did) : null,
      session ? getAccountHandle(session.did) : null,
    ]);
  return (
    <div className="flex min-h-screen items-center justify-center bg-zinc-50 dark:bg-zinc-950">
      <main className="w-full max-w-md mx-auto p-8">
        <div className="text-center mb-8">
          
<h1 className="text-3xl font-bold text-zinc-900 dark:text-zinc-100 mb-2">
            Statusphere
          </h1>
          <p className="text-zinc-600 dark:text-zinc-400">
            Atmosphereì—ì„œ ìƒíƒœ ì„¤ì •í•˜ê¸°
          </ p>
        </div>
        {session ? (
          <div className="bg-white dark:bg-zinc-900 rounded-lg border border-zinc-200 dark:border-zinc-800 p-6 mb-6">
            
<div className="flex items-center justify-between mb-4">
              <p className="text-sm text-zinc-500 dark:text-zinc-400">
                @{accountHandle ?? session.did} ë¡œ ë¡œê·¸ì¸ë¨
              </p>
              <LogoutButton />
            
</div>
            <StatusPicker currentStatus={accountStatus?.status} />
          </div>
        ) : (
          <div className="bg-white dark:bg-zinc-900 rounded-lg border border-zinc-200 dark:border-zinc-800 p-6 mb-6">
            <LoginForm />
          
</div>
        )}
        {topStatuses.length > 0 && (
          <div className="bg-white dark:bg-zinc-900 rounded-lg border border-zinc-200 dark:border-zinc-800 p-6 mb-6">
            <h3 className="text-sm font-medium text-zinc-500 dark: text-zinc-400 mb-3">
              ì£¼ìš” ìƒíƒœ
            </h3>
            
<div className="flex flex-wrap gap-2">
              {topStatuses.map((s) => (
                <span
                  key={s.status}
                  className="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-zinc-100 dark:bg-zinc-800 text-sm"
                
>
                  <span className="text-lg">{s.status}</span>
                  <span className="text-zinc-500 dark:text-zinc-400">
                    {String(s.count)}
                  </span>
                
</span>
              ))}
            </div>
          </div>
        )}
        <div className="bg-white dark:bg-zinc-900 rounded-lg border border-zinc-200 dark:border-zinc-800 p-6">
          
<h3 className="text-sm font-medium text-zinc-500 dark:text-zinc-400 mb-3">
            ìµœê·¼
          </h3>
          {statuses.length === 0 ? (
            <p className="text-zinc-500 dark:text-zinc-400 text-sm">
              ì•„ì§ ìƒíƒœê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ë¡œ ë‚¨ê²¨ë³´ì„¸ìš”!
            
</p>
          ) : (
            <ul className="space-y-3">
              {statuses.map((s) => (
                <li key={s.uri} className="flex items-center gap-3">
                  <span className="text-2xl">{s.status}</span>
                  
<span className="text-zinc-600 dark:text-zinc-400 text-sm">
                    @{s.handle}
                  </span>
                  
<span className="text-zinc-400 dark:text-zinc-500 text-xs ml-auto">
                    {timeAgo(s.createdAt)}
                  </span>
                </li>
              ))}
            </ul>
          )}
        </div>
      </main>
    </div>
  );
}
function timeAgo(dateString: string): string {
  const now = Date.now();
  const then = new Date(dateString).getTime();
  const seconds = Math.floor((now - then) / 1000);
  if (seconds < 60) return "ë°©ê¸ˆ ì „";
  
const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `${minutes}m`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours}h`;
  const days = Math.floor (hours / 24);
  return `${days}d`;
}
```
ì´ì œ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìëŠ” ë‹¨ìˆœíˆ "ë¡œê·¸ì¸ë¨" ëŒ€ì‹  "@ì‚¬ìš©ìëª… ë‹˜ìœ¼ë¡œ ë¡œê·¸ì¸ë¨"ì„ ë³¼ ìˆ˜ ìˆìœ¼ë©°, ëª¨ë“  ì‚¬ìš©ìì˜ ìµœê·¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í”¼ë“œì™€ í•¨ê»˜ í˜„ì¬ ê°€ì¥ ì¸ê¸° ìˆëŠ” ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ë³´ì—¬ì£¼ëŠ” "ì¸ê¸° ìƒíƒœ" ì„¹ì…˜ë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
`pnpm dev`ë¡œ ì•±ì„ ì¤‘ì§€í•˜ê³  ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ë§ˆì§€ë§‰ìœ¼ë¡œ í•œ ê°€ì§€ â€” ì•ì„œ `tap`ì— ë‹¨ì¼ ë°ì´í„° ì†ŒìŠ¤ë§Œ ì¶”ê°€í–ˆìŒì„ ê¸°ì–µí•˜ì„¸ìš”. ì „ì²´ ë„¤íŠ¸ì›Œí¬ì˜ ìƒíƒœë¥¼ ë³´ë ¤ë©´ `--signal-collection` í”Œë˜ê·¸ì™€ í•¨ê»˜ `tap`ì„ ì¤‘ì§€í•˜ê³  ì¬ì‹¤í–‰í•˜ì„¸ìš”:
```bash
tap run \
  --webhook-url=http://localhost:3000/api/webhook \
  
--collection-filters=xyz.statusphere.status \
  --signal-collection=xyz.statusphere.status
```...
 ê·¸ëŸ¬ë©´ ë„¤íŠ¸ì›Œí¬ ë‚´ ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì˜ ìƒíƒœ ë©”ì‹œì§€ê°€ í‘œì‹œë˜ê¸° ì‹œì‘í•©ë‹ˆë‹¤!
<Container>
  <Image src={feed} alt="" className="w-full max-w-md mx-auto" />
</Container>
## ê²°ë¡ 
ì´ì œ OAuthë¡œ ë¡œê·¸ì¸í•˜ê³ , ìƒíƒœ ë ˆì½”ë“œë¥¼ ì •ì˜í•˜ëŠ” ì»¤ìŠ¤í…€ ì–´íœ˜(Lexicon)ë¥¼ ì‚¬ìš©í•˜ë©°, Tapìœ¼ë¡œ ë ˆì½”ë“œë¥¼ ì‹¤ì‹œê°„ ë™ê¸°í™”í•˜ëŠ” ì™„ì „í•œ Atproto ì•±ì„ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.
ì´ë¥¼ í†µí•´ AT Protocol ê¸°ë°˜ ê°œë°œì„ ê³„ì†í•˜ëŠ” ë° í•„ìš”í•œ ëª¨ë“  ë„êµ¬ë¥¼ í™•ë³´í–ˆìŠµë‹ˆë‹¤. ë” ë§ì€ ê°€ì´ë“œì™€ íŠœí† ë¦¬ì–¼ì€ ì €í¬ [ê°€ì´ë“œ](/guides) ì„¹ì…˜ì—ì„œ ë” ë§ì€ ê°€ì´ë“œì™€ íŠœí† ë¦¬ì–¼ì„, [ì¿¡ë¶](https://github.com/bluesky-social/cookbook/) ì €ì¥ì†Œì—ì„œ ë” ë§ì€ ì˜ˆì œ ì•±ì„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¦ê±°ìš´ ê°œë°œ ë˜ì„¸ìš”!
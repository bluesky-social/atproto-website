export const metadata = {
  title: 'Auto-hospedagem',
  description:
    'Auto-hospedar um Bluesky PDS significa executar seu próprio Servidor de Dados Pessoais, capaz de se federar com a rede ATProto mais ampla.',
}

# Auto-hospedagem

Auto-hospedar um Bluesky PDS significa executar seu próprio Servidor de Dados Pessoais, capaz de se federar com a rede ATProto mais ampla. {{className: 'lead'}}

## Índice

* [Preparação para auto-hospedagem de PDS](#preparacao-para-auto-hospedagem-de-pds)
* [Abra seu firewall de nuvem para HTTP e HTTPS](#abra-seu-firewall-de-nuvem-para-http-e-https)
* [Configure o DNS para seu domínio](#configure-dns-para-seu-dominio)
* [Verifique se o DNS está funcionando conforme o esperado](#verifique-se-o-dns-esta-funcionando-conforme-o-esperado)
* [Instalador no Ubuntu 20.04/22.04 e Debian 11/12](#instalador-no-ubuntu-20-04-22-04-e-debian-11-12)
* [Verificando se seu PDS está online e acessível](#verificando-se-seu-pds-está-online-e-acessível)
* [Criando uma conta usando pdsadmin](#criando-uma-conta-usando-pdsadmin)
* [Criando uma conta usando um código de convite](#criando-uma-conta-usando-um-código-de-convite)
* [Configurando um servidor SMTP](#configurando-um-servidor-smtp)
* [Usando o aplicativo Bluesky com seu PDS](#usando-o-aplicativo-bluesky-com-seus-pds)
* [Adicionando um nome de domínio de nível superior como seu identificador](#adicionando-um-nome-de-dominio-de-nivel-superior-como-seu-identificador)
* [Usando updateAccountHandle para atualizar seu identificador](#usando-update-account-handle-para-atualizar-seu-identificador)
* [Depurando aviso de identificador inválido](#depurando-aviso-de-identificador-invalido)
* [Atualizando seu PDS](#atualizando-seus-pds)
* [Obtendo ajuda](#obtendo-ajuda)

## Preparação para auto-hospedagem de PDS

Inicie um servidor em qualquer provedor de nuvem, [Digital Ocean](https://digitalocean.com/) e [Vultr](https://vultr.com/) são duas escolhas populares.

Certifique-se de que você pode fazer ssh para seu servidor e ter acesso root.

**Requisitos do servidor**
* Endereço IPv4 público
* Nome DNS público
* Acesso público de entrada à Internet permitido nas portas 80/tcp e 443/tcp

**Recomendações do servidor**
| | |
| ---------------- | ------------ |
| Sistema operacional | Ubuntu 22.04 |
| Memória (RAM) | 1 GB |
| Núcleos da CPU | 1 |
| Armazenamento | SSD de 20 GB |
| Arquiteturas | amd64, arm64 |
| Número de usuários | 1-20 |

**Observação:** é uma boa prática de segurança restringir o acesso ssh de entrada (porta 22/tcp) ao endereço IP público do seu próprio computador. Você pode verificar seu endereço IP público atual usando [ifconfig.me](https://ifconfig.me/).

## Abra seu firewall de nuvem para HTTP e HTTPS

Uma das fontes mais comuns de configuração incorreta é não abrir as portas do firewall corretamente. Certifique-se de verificar novamente esta etapa.

No console do seu provedor de nuvem, as seguintes portas devem estar abertas para acesso de entrada da internet pública.

* 80/tcp (usado apenas para verificação de certificação TLS)
* 443/tcp (usado para todas as solicitações de aplicativos)

**Observação:** não há necessidade de configurar TLS ou redirecionar solicitações da porta 80 para 443 porque o servidor web Caddy, incluído no arquivo de composição do Docker, cuidará disso para você.

## Configure o DNS para seu domínio

No painel de controle do seu provedor de DNS, configure um domínio com registros apontando para seu servidor.

| Nome | Tipo | Valor | TTL |
| --------------- | ---- | ------------- | --- |
| `example.com` | `A` | `12.34.56.78` | 600 |
| `*.example.com` | `A` | `12.34.56.78` | 600 |

**Observação:**
* Substitua `example.com` pelo seu nome de domínio.
* Substitua `12.34.56.78` pelo endereço IP do seu servidor.
* Alguns provedores podem usar o símbolo `@` para representar a raiz do seu domínio.
* O registro curinga é necessário ao permitir que usuários criem novas contas no seu PDS.
* O TTL pode ser qualquer coisa, mas 600 (10 minutos) é razoável

## Verifique se o DNS está funcionando conforme o esperado

Use um serviço como [DNS Checker](https://dnschecker.org/) para verificar se você consegue resolver nomes de domínio.

Exemplos para verificar (tipo de registro `A`):
* `example.com`
* `random.example.com`
* `test123.example.com`

Todos eles devem retornar o IP público do seu servidor.

## Instalador no Ubuntu 20.04/22.04 e Debian 11/12

No seu servidor via ssh, baixe o script do instalador usando wget:

```bash
wget https://raw.githubusercontent.com/bluesky-social/pds/main/installer.sh
```

ou baixe usando curl:

```bash
curl https://raw.githubusercontent.com/bluesky-social/pds/main/installer.sh >installer.sh
```

E então execute o instalador usando bash:

```bash
sudo bash installer.sh
```

## Verificando se seu PDS está online e acessível

> [!DICA]
> Os problemas mais comuns para obter o conteúdo do PDS consumido na rede ativa são quando as pessoas substituem a configuração do Caddy fornecida por nginx, apache ou proxies reversos semelhantes. Obter certificados TLS, WebSockets e nomes de servidores virtuais corretos pode ser complicado. Atualmente, não estamos fornecendo suporte técnico para outras configurações.

Você pode verificar se seu servidor está online e íntegro solicitando o ponto de extremidade healthcheck.

Você pode visitar `https://example.com/xrpc/_health` no seu navegador. Você deve ver uma resposta JSON com uma versão, como:

```
{"version":"0.2.2-beta.2"}
```

Você também precisará verificar se os WebSockets estão funcionando, para que o resto da rede pegue o conteúdo do seu PDS. Você pode testar instalando uma ferramenta como `wsdump` e executando um comando como:

```bash
wsdump "wss://example.com/xrpc/com.atproto.sync.subscribeRepos?cursor=0"
```

Observe que não haverá eventos de saída no WebSocket até que eles sejam criados no PDS, então o comando acima pode continuar a ser executado sem saída se as coisas forem configuradas com sucesso.

## Criando uma conta usando pdsadmin

Usando ssh no seu servidor, use `pdsadmin` para criar uma conta se você ainda não tiver feito isso.

```bash
sudo pdsadmin account create
```

## Criando uma conta usando um código de convite

Usando ssh no seu servidor, use `pdsadmin` para criar um código de convite.

```bash
sudo pdsadmin create-invite-code
```

Ao criar uma conta usando o aplicativo, insira este código de convite.

## Configurando um servidor SMTP

Depois de configurar seu PDS, configure um servidor SMTP para receber e-mails do aplicativo Bluesky, como o e-mail "verifique seu endereço de e-mail".

No seu servidor PDS, abra o arquivo `/pds/pds.env`

```bash
sudo nano /pds/pds.env
```

Adicione estas linhas com sua configuração específica:

```bash
PDS_EMAIL_FROM_ADDRESS="exemplo@contadegmail.tld"
PDS_EMAIL_SMTP_URL="smtps://exemplo@contadegmail.tld:<senha-do-app>.gmail.com:465"
```

Recomendamos usar o [servidor SMTP do Gmail](https://support.google.com/a/answer/176600?hl=en) do Google como uma maneira rápida de configurar um servidor SMTP para usuários com uma conta do Gmail. Você precisará gerar uma [senha de aplicativo](https://support.google.com/accounts/answer/185833?sjid=10418456355978061137-NC).

Reinicie seu servidor PDS após alterar as variáveis de ambiente em `/pds/pds.env`

_Nota: Para contornar a configuração SMTP para verificação de e-mail, você pode consultar a tabela sqlite (tabela email_token) em seu PDS._

```bash
sudo sqlite3 /pds/account.sqlite "SELECT * FROM email_token;"
```

_O token estará na terceira coluna_

```bash
update_email|did:plc:someid|TOKEN-EMAIL|2024-11-06T18:35:18.589Z
```

## Usando o aplicativo Bluesky com seu PDS

Você pode usar o aplicativo Bluesky para se conectar ao seu PDS.

1. Obtenha o aplicativo Bluesky
* [Bluesky para Web](https://bsky.app/)
* [Bluesky para iPhone](https://apps.apple.com/us/app/bluesky-social/id6444370199)
* [Bluesky para Android](https://play.google.com/store/apps/details?id=xyz.blueskyweb.app)
1. Insira a URL do seu PDS (por exemplo, `https://example.com/`)

_Observação: como o certificado TLS do subdomínio é criado sob demanda, pode levar de 10 a 30 segundos para que seu identificador fique acessível. Se você não estiver vendo sua primeira postagem/perfil, aguarde 30 segundos e tente fazer outra postagem._

_Nota: Usuários com subdomínios hospedados no Squarespace relataram problemas que foram resolvidos após mudarem para registradores de domínio com suporte a subdomínios curinga._

## Adicionando um nome de domínio de nível superior como seu identificador

* Crie uma conta usando um identificador temporário do Bluesky
* No aplicativo Bluesky, vá para Configurações > Alterar Identificador
* Escolha "Eu tenho meu próprio domínio"
* Digite seu nome de domínio
* Adicione o registro TXT fornecido aos seus registros DNS
* Clique em "Verificar registro DNS"

_Dica: Antes de excluir sua conta Bluesky, mude para um identificador temporário se quiser reutilizar o TLD._

## Usando updateAccountHandle para atualizar seu identificador

Execute o seguinte comando curl com suas variáveis específicas. Veja [updateAccountHandle](https://docs.bsky.app/docs/api/com-atproto-admin-update-account-handle) para documentação.

```bash
curl --fail --silent --show-error \
     --request POST \
     --header "Content-Type: application/json" \
     --user "admin:${PDS_ADMIN_PASSWORD}" \
     --data "{\"did\": \"${DID}\", \"handle\": \"${HANDLE}\"}" \
     "https://${PDS_HOSTNAME}/xrpc/com.atproto.admin.updateAccountHandle"
```

As variáveis necessárias podem ser encontradas em `/pds/pds.env`

```bash
sudo cat /pds/pds.env
```

## Depurando aviso de identificador inválido

[Goat](https://github.com/bluesky-social/indigo/blob/d1686e9b80835948407fd7ad2428e92379298dac/cmd/goat/README.md) é uma ferramenta útil para descobrir o que está acontecendo com seu identificador.

```txt
$ goat resolve wyden.senate.gov
{
  "id": "did:plc:ydtsvzzsl6nlfkmnuooeqcmc",
  "alsoKnownAs": [
    "at://wyden.senate.gov"
  ],
  "verificationMethod": [
    {
      "id": "did:plc:ydtsvzzsl6nlfkmnuooeqcmc#atproto",
      "type": "Multikey",
      "controller": "did:plc:ydtsvzzsl6nlfkmnuooeqcmc",
      "publicKeyMultibase": "zQ3shuMW7q4KBdsFcdvebGi2EVv8KcqS24tF9Pg7Wh5NLB2NM"
    }
  ],
  "service": [
    {
      "id": "#atproto_pds",
      "type": "AtprotoPersonalDataServer",
      "serviceEndpoint": "https://shimeji.us-east.host.bsky.network"
    }
  ]
}
```

## Atualizando seu PDS

É recomendável que você mantenha seu PDS atualizado com novas versões, caso contrário, as coisas podem quebrar. Você pode usar a ferramenta `pdsadmin` para atualizar seu PDS.

```bash
sudo pdsadmin update
```

## Obtendo ajuda

- [Visite o GitHub](https://github.com/bluesky-social/pds) para problemas e discussões.
- [Junte-se ao AT Protocol PDS Admins Discord](https://discord.gg/e7hpHxRfBP) para conversar com outras pessoas que hospedam instâncias e obter atualizações importantes sobre a distribuição do PDS.
import {Container} from "@/components/Container"
import {Heading} from "@/components/Heading"
import oauth from "./oauth-only.png"
import skyblur from "./skyblur-oauth.png"
import granular from "./skyblur-granular.png"
import lexicon from "./skyblur-lexicon.png"

export const header = {
  title: '権限リクエスト',
  description:
    'アプリ開発者とLexicon設計者のための権限ガイド',
}

<Heading level={2} id="for-app-developers">アプリ開発者向け</Heading>

このガイドでは、atprotoアプリケーションの権限リクエスト方法を説明します。[OAuth](/guides/auth)はサードパーティーアプリにユーザーのソーシャルグラフへのアクセス権を与えるために使用され、ここで説明する概念の前提条件です。

atprotoのリソース制御は[権限](/specs/permission)で説明され、付与されます。特定のLexicon名前空間（レコード型とAPIエンドポイント）に関連する権限のグループは「権限セット」としてまとめられます。どちらも[OAuth](/specs/auth)の文脈で使われ、PDS上のアカウントリソースへのクライアントアクセスを付与します。例えば、ユーザーの公開リポジトリに特定の型のレコードを書き込む権限や、リモートサービスへの認証付きAPIリクエストを行う権限です。開発者はアプリが動作に必要な権限を宣言し、エンドユーザーはアプリへのアクセス許可時にその権限を確認します。

一般的には、UIをすっきりさせるために既存の権限セットを使うのが最善ですが、必要に応じて個別の権限を要求したり独自の権限セットを定義することもできます。これらのリクエストがOAuthフローでどのように表示されるかは、[OAuthフローの例](#oauth-flow-examples)を参照してください。

<Heading level={2} id="requesting-permissions">権限の要求</Heading>

アプリがatprotoのIDプロバイダーでOAuthフローを開始する際、認可リクエストの`scope`パラメータに含めることで特定の権限セットを要求できます。これはOAuthクライアント登録時に[`oauth-client-metadata.json`ファイル](/specs/oauth#clients)へ*スペース区切りのリスト*として指定します。

```
{
scope: "atproto rpc:app.bsky.feed.searchPosts?aud=* blob:*/*",
...
}
```

ATにおけるOAuthは[Pushed Authorization Requests](https://auth0.com/blog/what-are-oauth-push-authorization-requests-par/)（PAR）を使用します。クライアントメタデータファイルはセッションライフサイクル中に動的に取得され、`oauth-client-metadata.json`の`scope`パラメータはアプリが実際に行う認可HTTPリクエストと*一致している必要があります*。

```
https://your-authorization-server.com/authorize?
    client_id=1234567890&
    redirect_uri=https://your-app/callback&
    scope=atproto rpc:app.bsky.feed.searchPosts?aud=* blob:*/*
    response_type=code&
    audience=https://myapi&
    state=1234567890
```

アプリに必要な機能を満たす最小限の権限だけを要求するようにしてください。[移行スコープ](/specs/oauth#authorization-scopes)は、他アプリの投稿を含むユーザーのATレコードを作成・更新・削除する権限を付与します。一般に、こうした広範な権限要求は避けるべきです。そうすることでユーザーとの信頼関係を築き、認可プロセスの摩擦を最小化します。

ユーザー体験の観点では、要求する権限セットの数は少なく保つのが望ましいです。権限セットが追加されるたびに認可ダイアログの情報量が増え、判断疲れにつながる可能性があります。ユーザーに要求権限の一部のみを付与させることもできますが、エッジケースを生む場合があります。

<Heading level={2} id="permission-types">権限の種類</Heading>

PDSインスタンス上のユーザー所有リソースに関わる権限は、次の5種類で表されます。

- `repo`：公開リポジトリ（レコードとコレクション）
- `rpc`：サービス認証（外部サービスへのAPI呼び出し）
- `blob`：アップロードされたメディアファイル
- `identity`：DIDとハンドル
- `account`：ホスティング状態、メールアドレス

スコープ文字列の構文ではワイルドカード（\*）が許可され、すべてのレコードへのアクセスが付与されます。最も一般的な例は、画像や動画の取り扱い向けの`blob:*/*`です。部分的なワイルドカードはサポート*されません*。例えば、`app.bsky.*`は有効なスコープ文字列ではありません。特定の名前空間やLexiconから複数の権限を要求したい場合は、個別に列挙するか、[権限セット](#for-lexicon-designers)を使用する必要があります。これは過剰に広い権限要求を避けるための意図的な設計です。

権限セット自体もLexiconスキーマであり、他のLexiconと同様に名前空間が付いています。他のLexiconと異なり、権限セットはスコープ文字列で`include:`のプレフィックスが付き、動的に更新できます。

<Heading level={2} id="rolling-out-changes">変更の展開</Heading>

アプリを新しい権限セットに対応させる際は、ソフトウェアのリリースと権限セットの更新を同期させることが重要です。ユーザーの承認が必要な新しい権限セットを追加すると、ユーザーは新しい権限を付与するためにアプリを再認可する必要があります。

[クライアントメタデータドキュメント](/specs/oauth#clients)のリリース/デプロイの手順は、アプリのコードデプロイ手順とは別である場合があります。適切に計画してください。新しい権限を要求する更新済みの`oauth-client-metadata.json`は、その権限を必要とするアプリのバージョンより先に公開されている必要があります。

<Heading level={2} id="for-lexicon-designers">Lexicon設計者向け</Heading>

LexiconはJSONで作成されます。例は[Lexiconガイド](/guides/lexicon)で確認できます。AtmosphereのHTTP APIメソッドは、それぞれ特定のLexiconセットをスコープし実装するため、Lexiconには適切なクエリパラメータ、リクエストボディ、レスポンスボディが含まれている必要があります。各Lexiconは権限スコープにもなります。つまり、`app.bsky.feed.post`はATレコード形式であり、ウェブエンドポイントであり、粒度の細かい権限でもあります。

Lexiconスキーマはatproto上でLexiconリポジトリのレコードとして公開されます。技術的な詳細は[Lexiconの発行と解決](/specs/lexicon#lexicon-publication-and-resolution)を参照してください。

<Heading level={2} id="permission-set-design">権限セットの設計</Heading>

フル機能のクライアントアプリは、多数の細かな権限（数十、場合によっては数百）を必要とします。権限管理を簡素化するために、Lexicon設計者は公開するスキーマの一部として権限の集合を定義できます。これらの権限セット自体もLexiconスキーマであり、`com.example.authBasicFeatures`のような名前空間IDで参照されます。

例えば、アプリケーションは`include:com.example.authBasicFeatures?aud=did:web:api.example.com%23svc_appview`のような権限セットtを要求できます。これはアプリの動作に必要な権限の集まりを定義するLexiconに解決されます。

```
{
  "lexicon": 1,
  "id": "com.example.authBasicFeatures",
  "defs": {
    "main": {
      "type": "permission-set",
      "title": "Basic App Functionality",
      "detail": "Creation of posts and interactions",
      "permissions": [
        {
          "type": "permission",
          "resource": "repo",
          "collection": ["app.example.post"]
        },
        {
          "type": "permission",
          "resource": "rpc",
          "inheritAud": true,
          "lxm": [
            "app.example.getFeed"
            "app.example.getProfile",
            ...
          ]
        },
      ]
    }
  }
}
```

`app.example.feed.authOnlyPost`や`com.example.authBasicFeatures`の例にある`auth`プレフィックスに注目してください。これは、そのLexiconが権限セットとして使われるよう設計されていることを示す命名規則です。

権限セットは、そのセット自身と同じNSID名前空間下のリソースを参照する権限のみを表現できます。例えば、`app.example.feed.authOnlyPost`というセットには、`app.example.feed.post`レコードへの権限や、リモートサービスへの`app.example.feed.getPostThread` APIエンドポイントのリクエスト権限を含めることができます。しかし、`app.example.actor.profile`への権限は付与できません。階層が一段上の`app.example.authFull`のような権限セットであれば、これらすべてのリソースへの権限を含められます。

`title`と`details`フィールドは説明用で、OAuthフローの一部として表示されます。[OAuthフローの例](#oauth-flow-examples)を参照してください。これらの説明フィールドは国際化にも対応しています。詳細は[権限セット仕様](/specs/permission#permission-sets)を参照してください。

`rpc`権限における`inheritAud`の使用により、[継承の挙動](/specs/permission#rpc)を制御できます。

画像/動画の取り扱い用の`blob:*/*`権限は権限セットに含めることができず、常に個別に要求する必要があります。

<Heading level={2} id="linting-and-validating">リントとバリデーション</Heading>

[`goat`](https://github.com/bluesky-social/goat)を使ってLexiconを作成・公開できます。公開前に`goat`でLexiconのリントとバリデーションも行えます。例えば、`app.bsky.feed.post`の取得とリントは以下のように行えます。

```bash
$ goat lex pull app.bsky.feed.post
 🟢 app.bsky.feed.post

$ goat lex lint lexicons/app/bsky/feed/post.json
 🟡 lexicons/app/bsky/feed/post.json
    [unlimited-string]: no max length
    [unlimited-string]: no max length
error: linting issues detected
```

誰しも完璧ではありません😊

`goat lex new record`を使って新しいLexiconレコードを作成できます。

```bash
$ goat lex new record dev.project.thing
```

[スタイルガイド](/guides/lexicon-style-guide)に従ってLexiconを作成し、最後に`goat lex publish`で公開します。

```bash
$ goat lex publish
 🟢 dev.project.thing
```

新しいLexiconを公開したら、`goat lex resolve`で公開されたか確認できます。

```bash
$ goat lex resolve app.bsky.feed.post

{
  "$type": "com.atproto.lexicon.schema",
  "defs": {
    "entity": {
      "description": "Deprecated: use facets instead.",
      "properties": {
        "index": {
          "ref": "#textSlice",
          "type": "ref"
        },
        "type": {
          "description": "Expected values are 'mention' and 'link'.",
          "type": "string"
        },
        "value": {
          "type": "string"
...
```

<Heading level={2} id="revising-permission-sets">権限セットの改訂</Heading>

権限セットは改訂できますが、削除したり破壊的変更を行うと既存アプリケーションが壊れる可能性があります。一般に、権限セットは設計対象のアプリケーションに密接に結びつけるべきですが、必ずしも1:1である必要はありません。atprotoアプリケーションは複数の異なるLexiconを利用できることを覚えておいてください。

<Heading level={2} id="oauth-flow-examples">OAuthフローの例</Heading>

atprotoのIDプロバイダーを認証*のみ*に利用するアプリは、[`atproto`権限を要求するだけで十分](/guides/scopes)です。これにより、他のIDプロバイダーで期待するのと同じOAuthフローが提供されます。Atmosphereのソーシャルグラフ機能は使われず、追加の権限も不要です。

<Container>
  <Image src={oauth} alt="" className="w-full max-w-md mx-auto"/>
</Container>

これは十分に実用的なAtmosphere連携で、多くのアプリが出発点として利用します。ここでは明快で読みやすい「Authorize」フローが提示されます。要求元アプリのURLが明確に表示され、権限ダイアログにはアプリが「wants to uniquely identify you（あなたを識別しようとしています）」とだけ示され、それ以外はありません。

次に、追加の権限を要求する、より複雑な連携を考えます。デフォルトでは、これらは要約で提示されます。

<Container>
  <Image src={skyblur} alt="" className="w-full max-w-md mx-auto" />
</Container>

この画像では、*Bluesky*権限と*Skyblur*権限という2つの異なるLexiconのグループがあることに注目してください。各Lexiconは独自の権限セットを定義し、それらのグループと表示方法も独自に定義します。

「**?**」アイコンをクリックすると、各権限セットの詳細を確認できます。

<Container>
  <Image src={granular} alt="" className="w-full max-w-md mx-auto" />
</Container>

展開されたatprotoとBlueskyの権限には、OAuthログイン用の`atproto`、画像・動画の取り扱い用の`blob:*/*`、そしてプロフィールやソーシャルグラフ操作のための複数の`app.bsky.*`権限が含まれていることが分かるでしょう。

*Skyblur*のLexicon権限は、異なる方法で定義・要約されています。

<Container>
  <Image src={lexicon} alt="" className="w-full max-w-md mx-auto" />
</Container>

これらはすべてアプリ開発者とLexicon設計者の裁量に委ねられています。私たちは、異なるLexiconを並行して利用し、各Lexiconが独自の権限セットと表示を定義するためのモデルを提供しています。 

<Heading level={2} id="further-reading-and-resources">関連・参考資料</Heading>

- [認証](/guides/auth)
- [SDKによる認証](/guides/sdk-auth)
- [OAuthパターン](/guides/oauth-patterns)
- [スコープ](/guides/scopes)
- [OAuth仕様](/specs/oauth)
- [権限仕様](/specs/permission)

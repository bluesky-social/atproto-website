import {Heading} from '@/components/Heading'

export const metadata = {
  title: '계정 마이그레이션',
  description: '계정 마이그레이션 세부사항',
}

# 계정 마이그레이션 세부사항

이 문서는 계정 수명 주기에 대한 개요를 제공하는 [계정 호스팅](/specs/account) 사양을 보완합니다. 여기에서는 "쉬운" 마이그레이션(두 PDS 인스턴스가 모두 참여하는 경우)과 계정 복구 시나리오 모두에 대해 개별 마이그레이션 단계를 상세히 설명합니다. 이 특정 메커니즘들은 프로토콜의 공식 일부가 아니며, 시간이 지남에 따라 변경될 수 있습니다.

<Heading level={2} id="create-new-account">새로운 계정 생성</Heading>

기존 아이덴티티를 사용하여 PDS 계정을 생성하려면, 해당 아이덴티티에 대한 제어 권한을 증명해야 합니다.

- 다른 PDS에서 활성화된 계정의 경우, 아이덴티티의 DID 문서에 명시된 현재 atproto 서명 키를 사용하여 서비스 인증 토큰(JWT)을 생성합니다. 이 토큰은 이전 PDS 인스턴스에서 `com.atproto.server.getServiceAuth` 엔드포인트(또는 이에 상응하는 인터페이스/API)를 통해 요청할 수 있습니다.
- 만약 독자적으로 제어되는 아이덴티티(예: `did:web` 또는 이전 PDS가 오프라인이거나 협조하지 않는 `did:plc`)인 경우, 아이덴티티를 업데이트하여 사용자가 제어하는 atproto 서명 키를 포함시키고, 오프라인에서 서비스 인증 토큰을 생성해야 할 수 있습니다.

서비스 인증 토큰은 새 PDS에서 `com.atproto.server.createAccount` (또는 이에 상응하는 인터페이스/API)를 호출할 때 기존 DID와 함께 제공됩니다.

새 계정은 `비활성화(deactivated)` 상태로 생성됩니다. 사용자는 직접 로그인하여 인증할 수 있지만, 네트워크에 참여하지는 않습니다. 다른 네트워크 서비스의 관점에서는 이전 PDS 계정이 여전히 현재 상태로 간주되며, 새 PDS 계정은 아직 활성화되거나 유효하지 않습니다. 따라서 OAuth나 서비스 인증을 통한 프록시 요청 등의 기능은 아직 새 PDS에서 동작하지 않습니다.

<Heading level={2} id="migrating-data">데이터 마이그레이션</Heading>

일반적으로 마이그레이션되는 데이터 유형은 다음과 같습니다:

- 공개 레포지토리
- 공개 블롭(미디어 파일)
- 개인 설정

마이그레이션의 어느 단계에서든, 인증된 상태로 `com.atproto.server.checkAccountStatus` 엔드포인트를 이전 PDS와 새 PDS 양쪽에서 호출하여 현재 색인된 데이터의 통계를 확인할 수 있습니다.

- 공개 레포지토리의 사본은 이전 PDS에서 공개 `com.atproto.sync.getRepo` 엔드포인트를 사용하여 CAR 파일 형식으로 가져올 수 있습니다. 만약 이전 PDS에 접근할 수 없다면, 공개 릴레이에서 미러를 찾거나 로컬 백업을 사용할 수 있습니다. 백업이 없다면, 새 계정은 동일한 아이덴티티로 기능하지만 이전 콘텐츠는 누락됩니다.
- CAR 파일은 새 PDS에서 인증된 `com.atproto.repo.importRepo` 엔드포인트를 통해 가져올 수 있습니다.

블롭(미디어 파일)은 개별적으로 다운로드하여 재업로드해야 합니다. 레포지토리가 가져와져서 완전히 색인되기 전에는 새 PDS에 블롭을 업로드하면 안 됩니다. 그래야 블롭이 참조하는 레코드와 올바르게 연결되고, 가비지 컬렉션 대상이 되지 않습니다. 관련 블롭의 전체 목록(CID 기준)은 이전 PDS의 `com.atproto.sync.listBlobs` 엔드포인트 또는 새 PDS의 `com.atproto.repo.listMissingBlobs`를 통해 확인할 수 있습니다. 만약 일부 블롭을 찾을 수 없다 하더라도 마이그레이션은 계속 진행할 수 있으며, 나중에 블롭이 복구되면(정확한 CID가 일치할 경우) 업로드할 수 있습니다.

개인 계정 설정은 이전 PDS에서 인증된 `app.bsky.actor.getPreferences` 엔드포인트를 통해 내보낸 후, `app.bsky.actor.putPreferences`를 사용하여 가져올 수 있습니다. 이는 Bluesky 앱 전용 엔드포인트이며, 다른 앱(Lexicons)에서는 자체 설정 API를 정의할 수 있습니다. 단, 이 방식은 PDS에 저장된 개인 상태만 포함하며, 일부 설정이나 상태는 외부 서비스(예: 중앙집중식 채팅/DM 구현)에 존재할 수 있습니다.

<Heading level={2} id="updating-identity">아이덴티티 업데이트</Heading>

콘텐츠 마이그레이션이 완료되면, 아이덴티티(DID 및 핸들)를 업데이트하여 새 PDS가 해당 계정의 현재 호스트임을 나타낼 수 있습니다.

새 PDS에서 `com.atproto.identity.getRecommendedDidCredentials` 엔드포인트를 호출하면 "권장" DID 문서 파라미터를 가져올 수 있습니다. 이에는 DID 서비스 호스트명, 계정 생성 시 요청한 로컬 핸들, PDS에서 관리하는 atproto 서명 키(공개키), 그리고 (해당되는 경우) PLC 회전 키(공개키)가 포함됩니다.

만약 사용자가 안전하게 개인 암호화 키 쌍을 관리할 수 있다면(예: 비밀번호 관리자나 디지털 지갑에 저장), PLC 작업에 자체 제어 PLC 회전 키(공개키)를 포함시키는 것이 권장됩니다.

- **자체 제어 아이덴티티:** (예: `did:web` 또는 로컬 회전 키를 사용하는 `did:plc`)의 경우, 사용자가 직접 아이덴티티 업데이트를 수행할 수 있습니다.
- **이전 PDS에서 관리하는 `did:plc` 계정:** PLC "작업"은 이전 PDS가 서명한 후 새 PDS를 통해 제출됩니다. 새 PDS가 PLC 작업을 직접 제출하도록 하는 이유는, 이를 통해 새 PDS가 작업을 검증하고 계정이 손상되는 것을 방지하기 위한 안전 검사를 수행할 수 있기 때문입니다.

아이덴티티 작업은 민감하므로, 추가적인 보안 토큰이 추가 인증 수단으로 요구됩니다. 이 토큰은 이전 PDS에서 `com.atproto.identity.requestPlcOperationSignature`를 호출하여 요청할 수 있으며, 기본적으로 확인된 계정 이메일로 전달됩니다.

해당 토큰은 `com.atproto.identity.signPlcOperation` 호출 시 함께 포함되어, 요청된 DID 필드(새 서명 키, 회전 키, PDS 위치 등)와 함께 전달됩니다. 이전 PDS는 요청을 검증하고, PDS에서 관리하는 PLC 회전 키를 사용하여 서명한 PLC 작업을 반환합니다. 이 작업은 아직 PLC 디렉터리에 제출되지는 않습니다.

사용자는 이후 새 PDS에서 `com.atproto.identity.submitPlcOperation` 엔드포인트를 호출하여 작업을 제출하는 것이 권장됩니다. 이때 새 PDS는 변경 사항이 PDS가 아이덴티티와 atproto 계정을 관리할 수 있도록 "안전"한지 검증한 후, PLC 디렉터리에 제출합니다.

아이덴티티 업데이트가 성공적으로 완료되면, 전체 네트워크 관점에서 새 PDS가 해당 계정의 "현재" 호스트가 됩니다. 이는 아이덴티티를 해석하는 새로운 서비스에서는 즉시 반영되며, 기존의 파이어호스(firehose) 소비 서비스는 `#identity` 이벤트를 통해 이를 인지하게 됩니다. 캐시된 아이덴티티 메타데이터를 가진 다른 서비스는 캐시 만료 시 또는 서명 오류(예: 잘못된 서비스 인증 서명) 발생 시 새로고침을 수행해야 합니다.

그러나 이 시점에서도 새 계정은 아직 "활성화(active)" 상태가 아닙니다.

<Heading level={2} id="finalizing-account-status">계정 상태 최종화</Heading>

현재 사용자는 두 PDS 인스턴스 모두에서 인증이 가능합니다. 새 PDS는 해당 계정의 현재 호스트임을 인지하고 있으나, 계정 상태는 여전히 "비활성화"로 표시됩니다. 반면, 이전 PDS는 자신이 더 이상 최신 계정이 아님을 인지하지 못할 수 있습니다.

`com.atproto.server.checkAccountStatus` 엔드포인트를 두 PDS에서 모두 호출하여 모든 콘텐츠가 올바르게 마이그레이션되었는지 확인하는 것이 좋습니다.

사용자는 새 PDS에서 `com.atproto.server.activateAccount`를 호출하여 계정을 활성화하고, 이전 PDS에서는 `com.atproto.server.deactivateAccount`를 호출하여 계정을 비활성화할 수 있습니다.

이 시점에서 마이그레이션은 완료됩니다. 이후에는 레포지토리에 게시물을 작성하거나 개인 설정을 업데이트하는 등 정상적인 서비스 이용이 가능해지며, 인터서비스 인증 및 프록시 요청 또한 예상대로 작동합니다. 일부 클라이언트의 경우, 로그아웃 후 재로그인이 필요할 수 있습니다. 또한, 일부 서비스가 공격적인 아이덴티티 캐싱을 사용하여 서명 실패 시 즉시 새로고침하지 않는 경우, 서비스 인증 요청이 최대 24시간까지 실패할 수 있습니다.

이후에도 이전 PDS를 통해 로그인 및 인증은 가능하므로, 사용자는 원할 경우 이전 계정을 완전히 종료할 수 있습니다. 이는 `com.atproto.server.deactivateAccount` 요청의 `deleteAfter` 파라미터를 사용하여 자동화할 수 있습니다. 단, 이전 PDS는 계정이 완전히 삭제되지 않은 경우에 한해, 고정된 72시간 내에 PLC 아이덴티티 복구를 지원할 수 있습니다.

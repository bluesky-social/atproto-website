import {Heading} from '@/components/Heading'

export const header = {
  title: 'アカウント移行',
  description:
    '新しいPDSへアカウントを移行する',
}

この文書は[アカウントホスティング](/specs/account)仕様が与えるアカウントライフサイクル概要を補完します。両方のPDSが協力する簡単な移行と、アカウント復旧シナリオの双方における移行手順を詳細に示します。これらの具体的な仕組みはプロトコルの正式な一部ではなく、将来的に変更される可能性があることに注意してください。

既存のツールでアカウントを新しいPDSに移行したいだけであれば、以下をご覧ください。
- [`goat`を使ったPDSアカウント移行](https://whtwnd.com/bnewbold.net/3l5ii332pf32u)
- [PDS MOOver](https://pdsmoover.com/) — PDS移行のためのコミュニティツール

ここからは、移行時の詳細な処理について説明します。

<Heading level={2} id="creating-a-new-account">新規アカウント作成</Heading>

既存IDを使ってPDSアカウントを作成するには、そのIDを自分が制御していると証明する必要があります。

別のPDSで有効なアカウントの場合、DIDドキュメントに示された現在のAtproto署名鍵で署名されたサービス認証トークン（JWT）を生成することでこれを行います。これは元のPDSインスタンスに対して`com.atproto.server.getServiceAuth`エンドポイント（または同等のインターフェースやAPI）を使って要求できます。

独立して管理されるID（例：`did:web`、あるいは旧PDSがオフラインまたは非協力的な`did:plc`）の場合、管理下のAtproto署名鍵を含めるようIDを更新したり、オフラインでサービス認証トークンを生成することが含まれる場合があります。

サービス認証トークンは、新しいPDS上で`com.atproto.server.createAccount`（または同等のAPI）を使ってアカウントを作成する際に、既存のDIDとともに提供します。

新しいアカウントは`deactivated`状態になります。直接ログインや認証は可能なはずですが、ネットワークに参加することはできません。ネットワーク内の他のサービスから見ると旧PDSのアカウントが依然として現役であり、新PDSのアカウントはまだ有効でも正当でもありません。OAuthやサービス認証を用いたプロキシなどの機能は新PDSではまだ動作しません。

<Heading level={2} id="migrating-data">データ移行</Heading>

移行されるデータの典型的なカテゴリには次のものがあります。

- 公開リポジトリ
- 公開blob（メディアファイル）
- 非公開設定

移行中の任意の段階で、認証付きで`com.atproto.server.checkAccountStatus`エンドポイントを旧PDSまたは新PDSで呼び出し、現在インデックスされているデータの統計を確認できます。

リポジトリのコピーは、旧PDSから認証不要の`com.atproto.sync.getRepo`エンドポイントを使ってCARファイルとして取得できます。旧PDSにアクセスできない場合、公開リレー上のミラーやローカルバックアップが利用できる場合があります。どちらも無い場合でも新しいアカウントは同じIDで動作しますが、移行前のコンテンツが欠落する可能性があります。

認証付きで`com.atproto.repo.importRepo`エンドポイントを使って、CARファイルを新しいPDSにインポートできます。

blob（メディアファイル）は一つずつダウンロードしてアップロードし直されます。リポジトリがインポートされ完全にインデックスされるまで、blobを新PDSへアップロードしてはいけません。これにより、アップロードされたblobがレコードから参照されている状態にし、ガベージコレクションを防ぎます。関連するblob（のCID）の完全なリストを旧PDSから取得（`com.atproto.sync.listBlobs`）するか、現在の不足blobリストを新PDSで確認（`com.atproto.repo.listMissingBlobs`）できます。見つからないブロブがある場合でも移行は継続でき、後で復旧したblobをアップロードできます（blobのCIDが完全に一致する場合）。

非公開のアカウント設定は、旧PDSから認証された`app.bsky.actor.getPreferences`のようなエンドポイントを使ってエクスポートし、`app.bsky.actor.putPreferences`を使ってインポートできます。これらはBlueskyアプリ固有のエンドポイントで、他のアプリ（Lexicon）は独自の設定APIを定義することもあります。これはPDSに保存された状態のみを含む点に注意してください。一部の設定や状態は外部サービス（例：中央集権型チャット/DM実装）に存在するかもしれません。

<Heading level={2} id="updating-identity">ID更新</Heading>

コンテンツが移行されたら、ID（DIDとハンドル）を更新して、新しいPDSがそのアカウントの現行ホストであることを示すことができます。

推奨されるDIDドキュメントのパラメータは、新PDSの`com.atproto.identity.getRecommendedDidCredentials`エンドポイントから取得できます。これにはDIDのサービスホスト名、ローカルハンドル（アカウント作成時に要求したもの）、PDS管理のAtproto署名鍵（公開鍵）、および該当する場合はPLCローテーション鍵（公開鍵）が含まれます。

秘密鍵の鍵ペアを安全に管理できるユーザー（例：パスワードマネージャやデジタルウォレットに保存できる場合）は、PLCオペレーションに自己管理のPLCローテーション鍵（公開鍵）を含めることを推奨します。

自己管理型のID（例：`did:web`、またはローカルのローテーション鍵を持つ`did:plc`）の場合、IDの更新はユーザー自身が直接行うことができます。

旧PDSによって管理されている`did:plc`を使うアカウントの場合、PLCのオペレーションは旧PDSによって署名され、新PDS経由で提出されます。ユーザーに直接提出させるのではなく新PDSに提出させる理由は、新PDSがオペレーションを検証し、アカウントが破損状態になるのを防ぐ安全性チェックを行えるようにするためです。

ID操作はセンシティブなため、追加の『要素』としてセキュリティトークンが必要です。トークンは旧PDS上の`com.atproto.identity.requestPlcOperationSignature`を通じて要求でき、デフォルトではアカウントの確認済みメールアドレスに電子メールで配信されます。

このトークンは、要求するDIDのフィールド（新しい署名鍵、ローテーション鍵、PDSの場所など）とともに旧PDS上の`com.atproto.identity.signPlcOperation`呼び出しの一部として含まれます。旧PDSは要求を検証し、PDSが管理するPLCローテーション鍵で署名したPLC操作を返します。この時点ではオペレーションはまだPLCディレクトリに提出されていません。

その後、ユーザーはそのオペレーションを新PDS（`com.atproto.identity.submitPlcOperation`エンドポイント）に提出することが推奨されます。新PDSは変更が安全であること（すなわちPDSがIDとAtprotoアカウントの管理を支援できること）を検証した後、PLCディレクトリへ提出します。

IDが正常に更新されると、新PDSはネットワーク全体でそのアカウントの現行ホストになります。これは新規サービスのID解決には即座に反映されます。firehoseを消費している既存サービスには`#identity`イベントで通知されます。古いIDメタデータのキャッシュを持つサービスは、キャッシュの期限切れ時に更新するか、不正なサービス認証の署名などのエラーに遭遇した際にキャッシュを更新します。

ただし、新しいアカウントはまだ有効ではありません。

<Heading level={2} id="finalizing-account-status">アカウント状態確定</Heading>

この時点ではユーザーは両方のPDSインスタンスに認証可能です。新PDSは自身がアカウントにとって現行であることを認識していますが、アカウントはまだ無効化されたままです。旧PDSはもはや現行でないことに気づかない可能性があります。

すべてのコンテンツが移行されたことを確認するため、両方のPDSインスタンスで`com.atproto.server.checkAccountStatus`を呼び出して再確認することが有益な場合があります。

ユーザーは`com.atproto.server.activateAccount`を呼び出すことで新PDS上でアカウントを有効化でき、旧PDS上では`com.atproto.server.deactivateAccount`を使ってアカウントを無効化できます。

この時点で移行は完了です。リポジトリへ書き込むことで新しいコンテンツを公開でき、設定の更新やサービス間認証、プロキシも期待通り動作するはずです。クライアントからログアウトして再ログインする必要があるかもしれません。場合によっては、サービスの積極的なIDキャッシュが署名失敗でもリフレッシュされず、サービス認証が最大で24時間失敗する可能性があります。

旧PDSでログインや認証を行うことは引き続き可能です。ユーザーは最終的に旧アカウントを完全に削除したい場合があります。これは`com.atproto.server.deactivateAccount`リクエストの`deleteAfter`パラメータで自動化できます。旧PDSは72時間固定のウィンドウ内でPLC識別子の復旧を支援できる場合がありますが、そのウィンドウ内でアカウントが完全に削除されていない場合に限ります。

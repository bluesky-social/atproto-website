import {Heading} from '@/components/Heading'

export const header = {
  title: 'blobライフサイクル',
  description: 'blobのアップロード、参照、削除の方法',
}

<Heading level={2} id="uploading-blob">blobのアップロード</Heading>

blobは、それを参照するレコードより前にPDSにアップロードする必要があります。サーバーはアップロード時や受信時に目的のLexiconを知らないため、アップロード時には汎用的なblob制限と制約のみが適用可能であり、その後レコード作成時にLexiconで定義される制限を適用します。

クライアントはPDS上の **`com.atproto.repo.uploadBlob`** エンドポイントを使用します。このエンドポイントはLexiconにおけるblobオブジェクト形式の検証済みメタデータを返します。クライアントはアップロードリクエストHTTPの  **`Content-Type`** ヘッダーと **`Content-Length`** ヘッダーを設定する必要があります。SDKはこれを自動的に処理できます。

```typescript
const image = 'data:image/png;base64,...'
const { data } = await agent.uploadBlob(convertDataURIToUint8Array(image), {
  encoding,
})
```

この`data`オブジェクトは別のレコードで参照できます。例えば`embed`として使用できます。

チャンク転送エンコーディングによるアップロードも許可されている場合があります。サーバーはblobのmimetypeをスニッフィングして宣言された **`Content-Type`** ヘッダーに対して検証し、レスポンスで修正されたmimetypeを返すか、アップロードを拒否する場合があります。[『Security Considerations』](/specs/blob#security-considerations)を参照してください。実際のblobアップロードサイズが **`Content-Length`** ヘッダーと異なる場合、サーバーはアップロードを拒否します。

<Heading level={2} id="garbage-collection">ガベージコレクション</Heading>

アップロードに成功した後、blobは一時ストレージに配置されます。この状態では、ダウンロードや配送はできません。サーバーは適切な時間経過後に、参照されていない一時blobをガベージコレクション（削除）すべきです（[実装ガイドライン](#web-accessibility)を参照）。一時ストレージのblobは **`listBlobs`** の出力に含められません。

<Heading level={2} id="referencing-blobs">blobの参照</Heading>

アップロードされたblobは、返されたblobメタデータをレコードに含めることで、レコードから参照できます。レコード作成時に、サーバーは参照されているすべてのblobを抽出し、それらが既に参照されているか、一時ストレージにあるかを確認します。レコード作成に成功すると、サーバーはblobを公開アクセス可能にします。

blobは同じリポジトリ内の複数のレコードから参照できます。既に参照されている保存済みのblobを再度アップロードしても、既存のblobやレコードに変更は生じません。

存在しないblobを参照する新しいレコードの作成は、作成（または更新）時に拒否されるべきです。ただし、サーバーがローカルで利用できないblobを参照するレコードをホストすることは可能です。例えば、リポジトリの一括インポート、アカウント移行、データ損失、またはポリシー上の理由によるコンテンツ削除/消去の場合などです。

<Heading level={2} id="deleting-blobs">blobの削除</Heading>

blobを参照するレコードが削除されると、サーバーは同じリポジトリの他の現存レコードがblobを参照しているかどうかを確認します。参照されていない場合、blobはレコードと一緒に削除されます。

アカウントが削除されると、ホストされているすべてのblobが適切な期間内に削除されます。アカウントが無効化、停止、または凍結された場合、blobは公開アクセス可能にすべきではありません。

サーバーは、アカウント停止または他のアカウントライフサイクルイベントとは別に、個別のblobにアクセス不可能にすることを決定する場合があります。

<Heading level={2} id="web-accessibillity">ウェブアクセシビリティ</Heading>

オリジナルのblobは **`com.atproto.sync.getBlob`** エンドポイントを使用してPDSから取得できます。サーバーは適切な **`Content-Type`** と **`Content-Length`** HTTPヘッダーを返します。PDSからエンドユーザーのブラウザにメディアを直接提供することは推奨されるパターンではなく、サーバーはこのユースケースをサポート、または推進する必要はありません。詳細は『セキュリティに関する考慮事項』を参照してください。

サーバーはLexicon定義の制約とは別に、blob一般に対する独自の制限とポリシーを持つ場合があります。アカウント全体のデータストレージ割り当て、最大blobサイズ、コンテンツポリシーなどを実装する場合があります。これらの制限はアップロード時に適用される場合があります。サーバーオペレーターは、制限と他の制約が既存および将来のアプリケーションの機能に影響を与える可能性があることに注意すべきです。相互運用性を最大化するために、オペレーターは全体的なアカウントリソース消費に対する制限を優先することを推奨します（例：「1つのblob当たり」のサイズ制限ではなく「総blobサイズ」割り当て）。

一部のアプリケーションでは、blobアップロードからレコードによる参照までの間に長い遅延がある場合があります。相互運用性を最大化するために、サーバー実装とオペレーターはガベージコレクション前になるべく数時間、最低でも1時間の猶予を設けてください。

<Heading level={2} id="related-resources">参考資料</Heading>

- [画像と動画](/guides/images-and-video)
- [blobのセキュリティ](/guides/blob-security)
- [動画の取り扱い](/guides/video-handling)
- [blob仕様](/specs/blob)
- [Streamplace](https://stream.place/docs/)はatproto上の動画ストリーミングの実装および関連Lexiconを提供します。

import Link from 'next/link'
import {FooterCTA} from "@/components/FooterCTA"
import {Heading} from '@/components/Heading'
import AppBanner from './app-banner.png'
import AppLogin from './app-login.png'
import AppScreenshot from './app-screenshot.png'
import AppStatusHistory from './app-status-history.png'
import AppStatusOptions from './app-status-options.png'
import DiagramEventStream from './diagram-event-stream.png'
import DiagramInfoFlow from './diagram-info-flow.png'
import DiagramOauth from './diagram-oauth.png'
import DiagramOptimisticUpdate from './diagram-optimistic-update.png'
import DiagramRepo from './diagram-repo.png'

export const header = {
  title: 'AT Protocol ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì¶•ì„ ìœ„í•œ í€µ ìŠ¤íƒ€íŠ¸ ê°€ì´ë“œ',
  description:
    'ì´ ê°€ì´ë“œì—ì„œëŠ” ê°„ë‹¨í•œ ë‹¤ì¤‘ ì‚¬ìš©ì ì•±ì„ êµ¬ì¶•í•˜ì—¬ í˜„ì¬ ìì‹ ì˜ "ìƒíƒœ"ë¥¼ ì´ëª¨ì§€ë¡œ ê²Œì‹œí•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë´…ë‹ˆë‹¤.',
}

# AT Protocol ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì¶•ì„ ìœ„í•œ í€µ ìŠ¤íƒ€íŠ¸ ê°€ì´ë“œ

<Link href="https://github.com/bluesky-social/statusphere-example-app" className="not-prose flex items-center gap-2 bg-blue-100 dark:bg-blue-950 dark:text-white px-4 py-3 text-base rounded-lg hover:underline">
  <svg viewBox="0 0 20 20" aria-hidden="true" className="h-6 dark:text-white">
    <path
      fill="currentColor"
      fillRule="evenodd"
      clipRule="evenodd"
      d="M10 1.667c-4.605 0-8.334 3.823-8.334 8.544 0 3.78 2.385 6.974 5.698 8.106.417.075.573-.182.573-.406 0-.203-.011-.875-.011-1.592-2.093.397-2.635-.522-2.802-1.002-.094-.246-.5-1.005-.854-1.207-.291-.16-.708-.556-.01-.567.656-.01 1.124.62 1.281.876.75 1.292 1.948.93 2.427.705.073-.555.291-.93.531-1.143-1.854-.213-3.791-.95-3.791-4.218 0-.929.322-1.698.854-2.296-.083-.214-.375-1.09.083-2.265 0 0 .698-.224 2.292.876a7.576 7.576 0 0 1 2.083-.288c.709 0 1.417.096 2.084.288 1.593-1.11 2.291-.875 2.291-.875.459 1.174.167 2.05.084 2.263.53.599.854 1.357.854 2.297 0 3.278-1.948 4.005-3.802 4.219.302.266.563.78.563 1.58 0 1.143-.011 2.061-.011 2.35 0 .224.156.491.573.405a8.365 8.365 0 0 0 4.11-3.116 8.707 8.707 0 0 0 1.567-4.99c0-4.721-3.73-8.545-8.334-8.545Z"
    />
  </svg>
  <span>
    ì˜ˆì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì†ŒìŠ¤ ì½”ë“œë¥¼ GitHubì—ì„œ í™•ì¸í•˜ì„¸ìš”.
  </span>
</Link>

ì´ ê°€ì´ë“œì—ì„œëŠ” ê°„ë‹¨í•œ ë‹¤ì¤‘ ì‚¬ìš©ì ì•±ì„ êµ¬ì¶•í•˜ì—¬ ìì‹ ì˜ "ìƒíƒœ"ë¥¼ ì´ëª¨ì§€ë¡œ ê²Œì‹œí•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë´…ë‹ˆë‹¤. ì•±ì€ ë‹¤ìŒê³¼ ê°™ì´ ë™ì‘í•©ë‹ˆë‹¤: {{className: 'lead'}}

<Image alt="ì˜ˆì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìŠ¤í¬ë¦°ìƒ·" src={AppScreenshot} />

ë‹¤ìŒ ê¸°ëŠ¥ë“¤ì„ ë‹¤ë£¨ê²Œ ë©ë‹ˆë‹¤: {{className: 'lead'}}

- OAuthë¥¼ í†µí•œ ë¡œê·¸ì¸ {{className: 'lead'}}
- ì‚¬ìš©ì(í”„ë¡œí•„) ì •ë³´ ê°€ì ¸ì˜¤ê¸° {{className: 'lead'}}
- ë„¤íŠ¸ì›Œí¬ ì „ì²´ì˜ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼(firehose) êµ¬ë… {{className: 'lead'}}
- ì‚¬ìš©ì ê³„ì •ì— ì»¤ìŠ¤í…€ ìŠ¤í‚¤ë§ˆë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ê²Œì‹œí•˜ê¸° {{className: 'lead'}}

ATProtoì˜ ê°œë…ì„ ë¹ ë¥´ê²Œ ìµí ìˆ˜ ìˆë„ë¡ ê°„ë‹¨í•˜ê²Œ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤. ê° ë‹¨ê³„ì— ëŒ€í•´ ë” ìì„¸í•œ ì„¤ëª…ì´ ë§í¬ë¡œ ì œê³µë©ë‹ˆë‹¤. {{className: 'lead'}}

<Heading level={2} id="step-1-expressjs-app-setup">1ë‹¨ê³„. ExpressJS ì•± ì‹œì‘í•˜ê¸°</Heading>

ë¨¼ì €, ì €ì¥ì†Œë¥¼ í´ë¡ í•˜ê³  íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.

```bash
git clone https://github.com/bluesky-social/statusphere-example-app.git
cd statusphere-example-app
cp .env.template .env
npm install
npm run dev
# http://localhost:8080 ìœ¼ë¡œ ì ‘ì†í•˜ì„¸ìš”.
```

ì €ì¥ì†ŒëŠ” ì¼ë°˜ì ì¸ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì…ë‹ˆë‹¤. 1999ë…„ ìŠ¤íƒ€ì¼ì˜ ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§ì„ ì‚¬ìš©í•˜ë©°, [Kysely](https://kysely.dev/)ë¥¼ ì´ìš©í•´ SQLite ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.

ê¸°ë³¸ ìŠ¤íƒ:

- TypeScript
- NodeJS ì›¹ ì„œë²„ ([express](https://expressjs.com/))
- SQLite ë°ì´í„°ë² ì´ìŠ¤ ([Kysely](https://kysely.dev/))
- ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§ ([uhtml](https://www.npmjs.com/package/uhtml))

ê° ë‹¨ê³„ë§ˆë‹¤ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ Atmosphereì™€ ì–´ë–»ê²Œ ìƒí˜¸ì‘ìš©í•˜ëŠ”ì§€ ì„¤ëª…í•©ë‹ˆë‹¤. ìì„¸í•œ ì½”ë“œëŠ” ì €ì¥ì†Œì—ì„œ í™•ì¸í•˜ì„¸ìš”.

<Heading level={2} id="step-2-login-with-oauth">2ë‹¨ê³„. OAuthë¥¼ í†µí•œ ë¡œê·¸ì¸</Heading>

ì‚¬ìš©ìê°€ ì•±ì— ë¡œê·¸ì¸í•˜ë©´, ê°œì¸ì˜ `at://` ë ˆí¬ì§€í† ë¦¬ì— ëŒ€í•œ ì½ê¸° ë° ì“°ê¸° ê¶Œí•œì„ ë¶€ì—¬í•˜ê²Œ ë©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ìƒíƒœ JSON ë ˆì½”ë“œë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

OAuth ([ì‚¬ì–‘](https://github.com/bluesky-social/proposals/tree/main/0004-oauth))ë¥¼ ì‚¬ìš©í•˜ë©°, ëŒ€ë¶€ë¶„ì˜ OAuth íë¦„ì€ [@atproto/oauth-client-node](https://github.com/bluesky-social/atproto/tree/main/packages/oauth/oauth-client-node) ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì²˜ë¦¬í•©ë‹ˆë‹¤. ê¸°ë³¸ì ì¸ íë¦„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

<Image alt="OAuth êµ¬ì„± ìš”ì†Œ ë‹¤ì´ì–´ê·¸ë¨" src={DiagramOauth} />

ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ë©´, OAuth í´ë¼ì´ì–¸íŠ¸ëŠ” ì‚¬ìš©ìì˜ ë ˆí¬ì§€í† ë¦¬ ì„œë²„ì™€ ìƒˆë¡œìš´ ì„¸ì…˜ì„ ìƒì„±í•˜ê³  ì½ê¸°/ì“°ê¸° ê¶Œí•œ ë° ê¸°ë³¸ ì‚¬ìš©ì ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

<Image alt="ë¡œê·¸ì¸ UI ìŠ¤í¬ë¦°ìƒ·" src={AppLogin} />

ë¡œê·¸ì¸ í˜ì´ì§€ëŠ” ì‚¬ìš©ìì˜ "í•¸ë“¤" (ì˜ˆ: `alice.bsky.social` ë˜ëŠ” ë„ë©”ì¸ ì´ë¦„)ì„ ì…ë ¥ë°›ìŠµë‹ˆë‹¤.

```html
<!-- src/pages/login.ts -->
<form action="/login" method="post" class="login-form">
  <input
    type="text"
    name="handle"
    placeholder="í•¸ë“¤ ì…ë ¥ (ì˜ˆ: alice.bsky.social)"
    required
  />
  <button type="submit">ë¡œê·¸ì¸</button>
</form>
```

í¼ ì œì¶œ ì‹œ, OAuth í´ë¼ì´ì–¸íŠ¸ì— ì¸ì¦ í”Œë¡œìš°ë¥¼ ì‹œì‘í•˜ë„ë¡ ìš”ì²­í•˜ê³ , ì‚¬ìš©ìë¥¼ í•´ë‹¹ ì„œë²„ë¡œ ë¦¬ë””ë ‰ì…˜í•©ë‹ˆë‹¤.

```typescript
/** src/routes.ts **/
// ë¡œê·¸ì¸ í•¸ë“¤ëŸ¬
router.post(
  '/login',
  handler(async (req, res) => {
    // OAuth í”Œë¡œìš° ì‹œì‘
    const handle = req.body?.handle
    const url = await oauthClient.authorize(handle, {
      scope: 'atproto transition:generic',
    })
    return res.redirect(url.toString())
  })
)
```

ì‚¬ìš©ìê°€ ì¸ì¦ì„ ì™„ë£Œí•˜ë©´ `/oauth/callback`ìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜ë©ë‹ˆë‹¤. OAuth í´ë¼ì´ì–¸íŠ¸ëŠ” ì‚¬ìš©ìì˜ ì ‘ê·¼ í† í°ì„ ì €ì¥í•˜ê³ , ê³„ì •ì˜ [DID](https://atproto.com/specs/did)ë¥¼ ì¿ í‚¤ ì„¸ì…˜ì— ì²¨ë¶€í•©ë‹ˆë‹¤.

```typescript
/** src/routes.ts **/
// OAuth ì½œë°±: ì„¸ì…˜ ìƒì„± ì™„ë£Œ
router.get(
  '/oauth/callback',
  handler(async (req, res) => {
    // ìê²© ì¦ëª… ì €ì¥
    const { session } = await oauthClient.callback(params)

    // ì¿ í‚¤ì— ê³„ì • DID ì²¨ë¶€
    const cookieSession = await getIronSession(req, res)
    cookieSession.did = session.did
    await cookieSession.save()

    // ì•± ë©”ì¸ìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜
    return res.redirect('/')
  })
)
```

ì´ì œ ì‚¬ìš©ìì˜ ë ˆí¬ì§€í† ë¦¬ ì„œë²„ì™€ ì„¸ì…˜ì´ ìƒì„±ë˜ì—ˆìœ¼ë¯€ë¡œ, ë°ì´í„°ë¥¼ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<Heading level={2} id="step-3-fetching-the-users-profile">3ë‹¨ê³„. ì‚¬ìš©ì í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸°</Heading>

ì‚¬ìš©ìì— ëŒ€í•´ ì¢€ ë” ì•Œì•„ë³¼ê¹Œìš”? [Bluesky](https://bsky.app)ì—ì„œëŠ” ì‚¬ìš©ìê°€ "í”„ë¡œí•„" ë ˆì½”ë“œë¥¼ ê²Œì‹œí•˜ë©°, ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì¡°ë¥¼ ê°€ì§‘ë‹ˆë‹¤:

```typescript
interface ProfileRecord {
  displayName?: string // ì‚¬ìš©ì ì¹œí™”ì ì¸ ì´ë¦„
  description?: string // ì§§ì€ ì†Œê°œê¸€
  avatar?: BlobRef     // í”„ë¡œí•„ ì‚¬ì§„
  banner?: BlobRef     // ë°°ë„ˆ ì´ë¯¸ì§€
  createdAt?: string   // í”„ë¡œí•„ ë°ì´í„°ê°€ ì¶”ê°€ëœ ì‹œê°„
  // ...
}
```

ì´ ë ˆì½”ë“œëŠ” [atproto-browser.vercel.app](https://atproto-browser.vercel.app)ì—ì„œ ì§ì ‘ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, [@bsky.appì˜ í”„ë¡œí•„](https://atproto-browser.vercel.app/at?u=at://did:plc:z72i7hdynmk6r22z27h6tvur/app.bsky.actor.profile/self)ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì‚¬ìš©ìì˜ OAuth ì„¸ì…˜ê³¼ ì—°ê²°ëœ [Agent](https://github.com/bluesky-social/atproto/tree/main/packages/api)ë¥¼ ì‚¬ìš©í•´ ì´ ë ˆì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

```typescript
await agent.com.atproto.repo.getRecord({
  repo: agent.assertDid,                // ì‚¬ìš©ì DID
  collection: 'app.bsky.actor.profile', // ì»¬ë ‰ì…˜ ì´ë¦„
  rkey: 'self',                         // ë ˆì½”ë“œ í‚¤
})
```

ë ˆì½”ë“œë¥¼ ê°€ì ¸ì˜¬ ë•ŒëŠ” ì„¸ ê°€ì§€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.

- **repo**: ì‚¬ìš©ìë¥¼ ì‹ë³„í•˜ëŠ” [DID](https://atproto.com/specs/did)
- **collection**: ì»¬ë ‰ì…˜ ì´ë¦„
- **rkey**: ë ˆì½”ë“œ í‚¤

`"self"`ëŠ” ì»¬ë ‰ì…˜ì— ë‹¨ í•˜ë‚˜ì˜ ë ˆì½”ë“œê°€ ìˆì„ ë•Œ ì‚¬ìš©í•˜ëŠ” íŒ¨í„´ì…ë‹ˆë‹¤.

í™ˆí˜ì´ì§€ì—ì„œ ì´ í”„ë¡œí•„ ë ˆì½”ë“œë¥¼ ê°€ì ¸ì˜¤ë„ë¡ ì—…ë°ì´íŠ¸í•´ë´…ì‹œë‹¤:

```typescript
/** src/routes.ts **/
// í™ˆí˜ì´ì§€
router.get(
  '/',
  handler(async (req, res) => {
    // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ë˜ì–´ ìˆìœ¼ë©´, OAuth Agentë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const agent = await getSessionAgent(req, res, ctx)

    if (!agent) {
      // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ë·° ì œê³µ
      return res.type('html').send(page(home()))
    }

    // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì¶”ê°€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const { data: profileRecord } = await agent.com.atproto.repo.getRecord({
      repo: agent.assertDid,                // ì‚¬ìš©ì ë ˆí¬ì§€í† ë¦¬
      collection: 'app.bsky.actor.profile', // Bluesky í”„ë¡œí•„ ë ˆì½”ë“œ
      rkey: 'self',                         // ë ˆì½”ë“œ í‚¤
    })

    // ë¡œê·¸ì¸í•œ ë·° ì œê³µ
    return res
      .type('html')
      .send(page(home({ profile: profileRecord.value || {} })))
  })
)
```

ì´ ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ë§ì¶¤ í™˜ì˜ ë°°ë„ˆë¥¼ í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

<Image alt="ë°°ë„ˆ ì´ë¯¸ì§€ ìŠ¤í¬ë¦°ìƒ·" src={AppBanner} />

```html
<!-- pages/home.ts -->
<div class="card">
  ${profile
    ? html`<form action="/logout" method="post" class="session-form">
        <div>
          ì•ˆë…•í•˜ì„¸ìš”, <strong>${profile.displayName || 'ì¹œêµ¬'}</strong>ë‹˜.
          ì˜¤ëŠ˜ì˜ ìƒíƒœëŠ” ë¬´ì—‡ì¸ê°€ìš”?
        </div>
        <div>
          <button type="submit">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </form>`
    : html`<div class="session-form">
        <div><a href="/login">ë¡œê·¸ì¸</a>í•˜ì—¬ ìƒíƒœë¥¼ ì„¤ì •í•˜ì„¸ìš”!</div>
        <div>
          <a href="/login" class="button">ë¡œê·¸ì¸</a>
        </div>
      </div>`}
</div>
```

<Heading level={2} id="step-4-reading-writing-records">4ë‹¨ê³„. ë ˆì½”ë“œ ì½ê¸° ë° ì“°ê¸°</Heading>

ì‚¬ìš©ìì˜ ë ˆí¬ì§€í† ë¦¬ëŠ” JSON ë ˆì½”ë“œë“¤ì˜ ëª¨ìŒì…ë‹ˆë‹¤:

<Image alt="ë ˆí¬ì§€í† ë¦¬ ë‹¤ì´ì–´ê·¸ë¨" src={DiagramRepo} />

í”„ë¡œí•„ ë ˆì½”ë“œë¥¼ ë‹¤ì‹œ ì‚´í´ë´…ì‹œë‹¤:

```typescript
await agent.com.atproto.repo.getRecord({
  repo: agent.assertDid,                // ì‚¬ìš©ì DID
  collection: 'app.bsky.actor.profile', // ì»¬ë ‰ì…˜ ì´ë¦„
  rkey: 'self',                         // ë ˆì½”ë“œ í‚¤
})
```

ë ˆì½”ë“œëŠ” ì´ì™€ ìœ ì‚¬í•œ APIë¡œ ì‘ì„±í•©ë‹ˆë‹¤. ì´ì œ "ìƒíƒœ" ë ˆì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ì˜ˆë¥¼ ì‚´í´ë´…ì‹œë‹¤:

```typescript
// ì‹œê°„ ê¸°ë°˜ì˜ í‚¤ ìƒì„±
const rkey = TID.nextStr()

// ìƒíƒœ ë ˆì½”ë“œ ì‘ì„±
await agent.com.atproto.repo.putRecord({
  repo: agent.assertDid,                 // ì‚¬ìš©ì ë ˆí¬ì§€í† ë¦¬
  collection: 'xyz.statusphere.status',  // ì»¬ë ‰ì…˜ ì´ë¦„
  rkey,                                  // ë ˆì½”ë“œ í‚¤
  record: {                              // ë ˆì½”ë“œ ê°’
    status: "ğŸ‘",
    createdAt: new Date().toISOString()
  }
})
```

`POST /status` ë¼ìš°íŠ¸ì—ì„œëŠ” ì´ APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìì˜ ìƒíƒœë¥¼ ë ˆí¬ì§€í† ë¦¬ì— ê²Œì‹œí•©ë‹ˆë‹¤.

```typescript
/** src/routes.ts **/
// ìƒíƒœ ì„¤ì • í•¸ë“¤ëŸ¬
router.post(
  '/status',
  handler(async (req, res) => {
    // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì¸ì§€ í™•ì¸
    const agent = await getSessionAgent(req, res, ctx)
    if (!agent) {
      return res.status(401).type('html').send('<h1>Error: ì„¸ì…˜ì´ í•„ìš”í•©ë‹ˆë‹¤.</h1>')
    }

    // ìƒíƒœ ë ˆì½”ë“œ ìƒì„±
    const record = {
      $type: 'xyz.statusphere.status',
      status: req.body?.status,
      createdAt: new Date().toISOString(),
    }

    try {
      // ì‚¬ìš©ì ë ˆí¬ì§€í† ë¦¬ì— ìƒíƒœ ë ˆì½”ë“œ ì‘ì„±
      await agent.com.atproto.repo.putRecord({
        repo: agent.assertDid,
        collection: 'xyz.statusphere.status',
        rkey: TID.nextStr(),
        record,
      })
    } catch (err) {
      logger.warn({ err }, 'ë ˆì½”ë“œ ì‘ì„± ì‹¤íŒ¨')
      return res.status(500).type('html').send('<h1>Error: ë ˆì½”ë“œ ì‘ì„± ì‹¤íŒ¨</h1>')
    }

    res.status(200).json({})
  })
)
```

í™ˆí˜ì´ì§€ì—ì„œëŠ” ìƒíƒœ ë²„íŠ¼ë“¤ì„ ë‚˜ì—´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```html
<!-- src/pages/home.ts -->
<form action="/status" method="post" class="status-options">
  ${STATUS_OPTIONS.map(status => html`
    <button class="status-option" name="status" value="${status}">
      ${status}
    </button>
  `)}
</form>
```

<Image alt="ìƒíƒœ ì˜µì…˜ ìŠ¤í¬ë¦°ìƒ·" src={AppStatusOptions} />

<Heading level={2} id="step-5-creating-a-custom-status-schema">5ë‹¨ê³„. ì»¤ìŠ¤í…€ "ìƒíƒœ" ìŠ¤í‚¤ë§ˆ ìƒì„±</Heading>

ë ˆí¬ì§€í† ë¦¬ì˜ ì»¬ë ‰ì…˜ì€ íƒ€ì…ì´ ì§€ì •ë˜ì–´ ìˆìœ¼ë©°, ì •í•´ì§„ ìŠ¤í‚¤ë§ˆë¥¼ ë”°ë¦…ë‹ˆë‹¤. `app.bsky.actor.profile` íƒ€ì… ì •ì˜ëŠ” [ì—¬ê¸°](https://github.com/bluesky-social/atproto/blob/main/lexicons/app/bsky/actor/profile.json)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ëˆ„êµ¬ë‚˜ [Lexicon](https://atproto.com/guides/lexicon) ì–¸ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ ìŠ¤í‚¤ë§ˆë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì˜ˆì œ ì•±ì—ì„œëŠ” `xyz.statusphere`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤ (statusphere.xyzë¥¼ ìœ„í•œ ë“±ë¡ ë„ë©”ì¸).

> <Heading level={3} id="why-create-a-schema">ì™œ ìŠ¤í‚¤ë§ˆë¥¼ ë§Œë“¤ê¹Œìš”?</Heading>
>
> ìŠ¤í‚¤ë§ˆëŠ” ë‹¤ë¥¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì•±ì—ì„œ ìƒì„±í•˜ëŠ” ë°ì´í„°ë¥¼ ì´í•´í•˜ë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤. ìŠ¤í‚¤ë§ˆë¥¼ ê²Œì‹œí•˜ë©´, ë‹¤ë¥¸ ê°œë°œìë“¤ì´ í•´ë‹¹ í˜•ì‹ì— ë§ê²Œ ë°ì´í„°ë¥¼ ê²Œì‹œí•˜ê¸°ê°€ ì‰¬ì›Œì§‘ë‹ˆë‹¤.

`/lexicons` í´ë”ì— ìŠ¤í‚¤ë§ˆ íŒŒì¼ì„ ìƒì„±í•´ë´…ì‹œë‹¤.

```json
/** lexicons/status.json **/
{
  "lexicon": 1,
  "id": "xyz.statusphere.status",
  "defs": {
    "main": {
      "type": "record",
      "key": "tid",
      "record": {
        "type": "object",
        "required": ["status", "createdAt"],
        "properties": {
          "status": {
            "type": "string",
            "minLength": 1,
            "maxGraphemes": 1,
            "maxLength": 32
          },
          "createdAt": {
            "type": "string",
            "format": "datetime"
          }
        }
      }
    }
  }
}
```

ì´ì œ ìŠ¤í‚¤ë§ˆë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì½”ë“œ ìƒì„±ì„ ì‹¤í–‰í•©ë‹ˆë‹¤:

```bash
./node_modules/.bin/lex gen-server ./src/lexicon ./lexicons/*
```

ì´ ëª…ë ¹ì€ TypeScript ì¸í„°í˜ì´ìŠ¤ì™€ ëŸ°íƒ€ì„ ê²€ì¦ í•¨ìˆ˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ìƒì„±ëœ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

```typescript
/** src/lexicon/types/xyz/statusphere/status.ts **/
export interface Record {
  status: string
  createdAt: string
  [k: string]: unknown
}

export function isRecord(v: unknown): v is Record {
  return (
    isObj(v) &&
    hasProp(v, '$type') &&
    (v.$type === 'xyz.statusphere.status#main' || v.$type === 'xyz.statusphere.status')
  )
}

export function validateRecord(v: unknown): ValidationResult {
  return lexicons.validate('xyz.statusphere.status#main', v)
}
```

ì´ë¥¼ í™œìš©í•´ `POST /status` ë¼ìš°íŠ¸ë¥¼ ê°œì„ í•´ë´…ë‹ˆë‹¤:

```typescript
/** src/routes.ts **/
import * as Status from '#/lexicon/types/xyz/statusphere/status'
// ...
// ìƒíƒœ ì„¤ì • í•¸ë“¤ëŸ¬
router.post(
  '/status',
  handler(async (req, res) => {
    // ...

    // ìƒíƒœ ë ˆì½”ë“œ ìƒì„± ë° ê²€ì¦
    const record = {
      $type: 'xyz.statusphere.status',
      status: req.body?.status,
      createdAt: new Date().toISOString(),
    }
    if (!Status.validateRecord(record).success) {
      return res.status(400).json({ error: 'ì˜ëª»ëœ ìƒíƒœ ê°’ì…ë‹ˆë‹¤.' })
    }

    // ...
  })
)
```

<Heading level={2} id="step-6-listening-to-the-firehose">6ë‹¨ê³„. ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼(firehose) êµ¬ë…</Heading>

ì§€ê¸ˆê¹Œì§€:

- OAuthë¥¼ í†µí•œ ë¡œê·¸ì¸
- ì»¤ìŠ¤í…€ ìŠ¤í‚¤ë§ˆ ìƒì„±
- ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ë ˆì½”ë“œ ì½ê¸° ë° ì“°ê¸°

ì´ì œ ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì˜ ìƒíƒœ ë ˆì½”ë“œë¥¼ ê°€ì ¸ì™€ë´…ë‹ˆë‹¤.

ê° ì‚¬ìš©ìëŠ” ìì‹ ì˜ `at://` ë ˆí¬ì§€í† ë¦¬ì— ë°ì´í„° ë ˆì½”ë“œë¥¼ ê²Œì‹œí•©ë‹ˆë‹¤. ì´ ë°ì´í„°ë¥¼ ëª¨ì•„ SQLite DBì— ì§‘ê³„í•  ì˜ˆì •ì…ë‹ˆë‹¤.

> `at://`ëŠ” AT Protocolì˜ URL ìŠ¤í‚´ì…ë‹ˆë‹¤. HTTPì™€ DNS ë“± ì¼ë°˜ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ì§€ë§Œ, ì´ íŠœí† ë¦¬ì–¼ì—ì„œ ë‹¤ë£° ì—¬ëŸ¬ ê¸°ëŠ¥ì„ í¬í•¨í•©ë‹ˆë‹¤.

ê° ë ˆí¬ì§€í† ë¦¬ëŠ” ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ ë¡œê·¸ë¥¼ ê²Œì‹œí•©ë‹ˆë‹¤.

<Image alt="ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ ë‹¤ì´ì–´ê·¸ë¨" src={DiagramEventStream} />

ë¦´ë ˆì´ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë©´ ë„¤íŠ¸ì›Œí¬ ì „ì²´ì—ì„œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ì„ êµ¬ë…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìš°ë¦¬ê°€ ì°¾ëŠ” ê²ƒì€ ìœ íš¨í•œ `xyz.statusphere.status` ë ˆì½”ë“œì…ë‹ˆë‹¤.

```typescript
/** src/ingester.ts **/
import { Firehose } from '@atproto/sync'
import * as Status from '#/lexicon/types/xyz/statusphere/status'
// ...

new Firehose({
  filterCollections: ['xyz.statusphere.status'],
  handleEvent: async (evt) => {
    // ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ ê°ì§€
    if (evt.event === 'create' || evt.event === 'update') {
      const record = evt.record

      // ìœ íš¨í•œ ìƒíƒœ ì—…ë°ì´íŠ¸ì¸ì§€ í™•ì¸
      if (
        evt.collection === 'xyz.statusphere.status' &&
        Status.isRecord(record) &&
        Status.validateRecord(record).success
      ) {
        // ìƒíƒœ ì €ì¥ (TODO)
      }
    }
  },
})
```

SQLiteì— ìƒíƒœë“¤ì„ ì €ì¥í•˜ê¸° ìœ„í•´ í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤:

```typescript
/** src/db.ts **/
// ìƒíƒœ í…Œì´ë¸” ìƒì„±
await db.schema
  .createTable('status')
  .addColumn('uri', 'varchar', (col) => col.primaryKey())
  .addColumn('authorDid', 'varchar', (col) => col.notNull())
  .addColumn('status', 'varchar', (col) => col.notNull())
  .addColumn('createdAt', 'varchar', (col) => col.notNull())
  .addColumn('indexedAt', 'varchar', (col) => col.notNull())
  .execute()
```

ì´ì œ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ì—ì„œ ìƒíƒœë¥¼ ë°›ì•„ SQLite DBì— ê¸°ë¡í•©ë‹ˆë‹¤:

```typescript
/** src/ingester.ts **/
// ìœ íš¨í•œ ìƒíƒœ ì—…ë°ì´íŠ¸ì˜ ê²½ìš°
if (
  evt.collection === 'xyz.statusphere.status' &&
  Status.isRecord(record) &&
  Status.validateRecord(record).success
) {
  // SQLiteì— ìƒíƒœ ì €ì¥
  await db
    .insertInto('status')
    .values({
      uri: evt.uri.toString(),
      authorDid: evt.author,
      status: record.status,
      createdAt: record.createdAt,
      indexedAt: new Date().toISOString(),
    })
    .onConflict((oc) =>
      oc.column('uri').doUpdateSet({
        status: record.status,
        indexedAt: new Date().toISOString(),
      })
    )
    .execute()
}
```

<Image alt="ì •ë³´ íë¦„ ë‹¤ì´ì–´ê·¸ë¨" src={DiagramInfoFlow} />

ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ë ˆí¬ì§€í† ë¦¬ì— ë°ì´í„°ë¥¼ ê¸°ë¡í•˜ê³ , ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ì„ í†µí•´ DBì— ì§‘ê³„í•©ë‹ˆë‹¤.

<Heading level={2} id="step-7-listing-the-latest-statuses">7ë‹¨ê³„. ìµœì‹  ìƒíƒœ ëª©ë¡ í‘œì‹œ</Heading>

SQLiteì— ì €ì¥ëœ ìƒíƒœë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ìš©ìë“¤ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸ íƒ€ì„ë¼ì¸ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. [DID](https://atproto.com/specs/did)-to-í•¸ë“¤ ë³€í™˜ê¸°ë¥¼ ì‚¬ìš©í•´, ì‚¬ìš©ì ì´ë¦„ì„ í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```typescript
/** src/routes.ts **/
// í™ˆí˜ì´ì§€
router.get(
  '/',
  handler(async (req, res) => {
    // ...

    // SQLiteì—ì„œ ìƒíƒœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const statuses = await db
      .selectFrom('status')
      .selectAll()
      .orderBy('indexedAt', 'desc')
      .limit(10)
      .execute()

    // ì‚¬ìš©ì DIDë¥¼ ë„ë©”ì¸ í•¸ë“¤ë¡œ ë§¤í•‘
    const didHandleMap = await resolver.resolveDidsToHandles(
      statuses.map((s) => s.authorDid)
    )

    // ...
  })
)
```

HTMLì—ì„œëŠ” ìƒíƒœ ë ˆì½”ë“œë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ë‚˜ì—´í•©ë‹ˆë‹¤:

```html
<!-- src/pages/home.ts -->
${statuses.map((status, i) => {
  const handle = didHandleMap[status.authorDid] || status.authorDid
  return html`
    <div class="status-line">
      <div>
        <div class="status">${status.status}</div>
      </div>
      <div class="desc">
        <a class="author" href="https://bsky.app/profile/${handle}">@${handle}</a>
        ë‹˜ì´ ${status.indexedAt}ì— ${status.status} ìƒíƒœë¥¼ ê²Œì‹œí–ˆìŠµë‹ˆë‹¤.
      </div>
    </div>
  `
})}
```

<Image alt="ìƒíƒœ íƒ€ì„ë¼ì¸ ìŠ¤í¬ë¦°ìƒ·" src={AppStatusHistory} />

<Heading level={2} id="step-8-optimistic-updates">8ë‹¨ê³„. ë‚™ê´€ì  ì—…ë°ì´íŠ¸ (Optimistic Updates)</Heading>

ë§ˆì§€ë§‰ ìµœì í™”ë¡œ, "ë‚™ê´€ì  ì—…ë°ì´íŠ¸"ë¥¼ ë„ì…í•´ë´…ë‹ˆë‹¤.

ë ˆí¬ì§€í† ë¦¬ì— ì“°ê¸°ë¥¼ í•˜ê³  ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ì„ êµ¬ë…í•˜ëŠ” íë¦„ì„ ë‹¨ì¶•í•˜ì—¬, ì‚¬ìš©ìê°€ ìì‹ ì˜ ë³€ê²½ ì‚¬í•­ì„ ì¦‰ì‹œ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. ì´ë²¤íŠ¸ê°€ ë„ì°©í•˜ë©´, ì´ë¯¸ ë¡œì»¬ DBì— ì €ì¥ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë¬´ì‹œí•©ë‹ˆë‹¤.

ì´ë¥¼ ìœ„í•´ `POST /status` ë¼ìš°íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ SQLite DBì—ë„ ìƒíƒœë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤:

```typescript
/** src/routes.ts **/
// ìƒíƒœ ì„¤ì • í•¸ë“¤ëŸ¬
router.post(
  '/status',
  handler(async (req, res) => {
    // ...

    let uri
    try {
      // ì‚¬ìš©ì ë ˆí¬ì§€í† ë¦¬ì— ìƒíƒœ ë ˆì½”ë“œ ì‘ì„±
      const res = await agent.com.atproto.repo.putRecord({
        repo: agent.assertDid,
        collection: 'xyz.statusphere.status',
        rkey: TID.nextStr(),
        record,
      })
      uri = res.uri
    } catch (err) {
      logger.warn({ err }, 'ë ˆì½”ë“œ ì‘ì„± ì‹¤íŒ¨')
      return res.status(500).json({ error: 'ë ˆì½”ë“œ ì‘ì„± ì‹¤íŒ¨' })
    }

    try {
      // ë‚™ê´€ì  ì—…ë°ì´íŠ¸: SQLiteì— ìƒíƒœ ê¸°ë¡ <-- ì—¬ê¸°ì„œ!
      await db
        .insertInto('status')
        .values({
          uri,
          authorDid: agent.assertDid,
          status: record.status,
          createdAt: record.createdAt,
          indexedAt: new Date().toISOString(),
        })
        .execute()
    } catch (err) {
      logger.warn(
        { err },
        'ë·° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨; ì¶”í›„ firehoseì—ì„œ ë³´ì™„ë©ë‹ˆë‹¤.'
      )
    }

    res.status(200).json({})
  })
)
```

ì´ ì½”ë“œëŠ” `ingester.ts`ì˜ ì½”ë“œì™€ ê±°ì˜ ë™ì¼í•©ë‹ˆë‹¤.

<Heading level={2} id="thinking-in-at-proto">AT Protocol ì‚¬ê³ ë°©ì‹</Heading>

ì´ë²ˆ íŠœí† ë¦¬ì–¼ì—ì„œëŠ” AT Protocol ì•± êµ¬ì¶•ì˜ ì£¼ìš” ë‹¨ê³„ë¥¼ ë‹¤ë¤˜ìŠµë‹ˆë‹¤. ë°ì´í„°ëŠ” ì‚¬ìš©ìì˜ `at://` ë ˆí¬ì§€í† ë¦¬ì— ì›ë³¸ í˜•íƒœë¡œ ê²Œì‹œë˜ê³ , ê° ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë°ì´í„°ë² ì´ìŠ¤ì— ì§‘ê³„ë˜ì–´ ë„¤íŠ¸ì›Œí¬ ë·°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

ì•±ì„ êµ¬ì¶•í•  ë•Œ ê¸°ì–µí•´ì•¼ í•  ë„¤ ê°€ì§€ í•µì‹¬ ë‹¨ê³„:

- ê²Œì‹œí•  ë ˆì½”ë“œì˜ [Lexicon](https://atproto.com/guides/lexicon) ìŠ¤í‚¤ë§ˆ ì„¤ê³„
- ë ˆì½”ë“œë¥¼ ì§‘ê³„í•  ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±
- ì‚¬ìš©ìì˜ ë ˆí¬ì§€í† ë¦¬ì— ë ˆì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì¶•
- ë„¤íŠ¸ì›Œí¬ ì „ë°˜ì˜ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ì„ êµ¬ë…í•˜ì—¬ ë°ì´í„° ì§‘ê³„

ì •ë³´ì˜ íë¦„:

<Image alt="ì •ë³´ íë¦„ ë‹¤ì´ì–´ê·¸ë¨" src={DiagramInfoFlow} />

ì´ì™€ ê°™ì€ ë°©ì‹ìœ¼ë¡œ Bluesky ì†Œì…œ ì•±ì„ í¬í•¨í•œ ëª¨ë“  Atmosphere ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë™ì‘í•©ë‹ˆë‹¤.

<Heading level={2} id="next-steps">ë‹¤ìŒ ë‹¨ê³„</Heading>

ë°°ìš´ ë‚´ìš©ì„ ì—°ìŠµí•´ë³´ê³  ì‹¶ë‹¤ë©´, ë‹¤ìŒ ë„ì „ ê³¼ì œë“¤ì„ ì‹œë„í•´ë³´ì„¸ìš”:

- ëª¨ë“  ì‚¬ìš©ìì˜ í”„ë¡œí•„ ë ˆì½”ë“œë¥¼ ë™ê¸°í™”í•˜ì—¬ í•¸ë“¤ ëŒ€ì‹  í‘œì‹œ ì´ë¦„ì„ ë³´ì—¬ì£¼ê¸°
- ê° ìƒíƒœ ì´ëª¨ì§€ì˜ ì‚¬ìš© íšŸìˆ˜ë¥¼ ì§‘ê³„í•˜ì—¬ ì´í•© í‘œì‹œí•˜ê¸°
- ì¸ì¦ëœ ì‚¬ìš©ìì˜ `app.bsky.graph.follow` ì •ë³´ë¥¼ ê°€ì ¸ì™€ íŒ”ë¡œì‰ ìƒíƒœ í‘œì‹œí•˜ê¸°
- ë§í¬ ê²Œì‹œ ë° 1~4ì„± í‰ê°€ì™€ ê°™ì€ ë‹¤ë¥¸ ìŠ¤í‚¤ë§ˆ ìƒì„±í•˜ê¸°

<FooterCTA href="/" title="ë” ì•Œì•„ë³¼ ì¤€ë¹„ê°€ ë˜ì…¨ë‚˜ìš”?" description="ì‚¬ì–‘, ê°€ì´ë“œ ë° SDKë¥¼ í™•ì¸í•´ë³´ì„¸ìš”." />
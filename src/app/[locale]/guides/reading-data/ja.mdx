import {Heading} from '@/components/Heading'

export const header = {
  title: 'データ読み取り',
  description: 'ATプロトコルレコードを読み取る',
}

<Heading level={2} id="listing-records">レコードの列挙</Heading>

<TabGroup defaultValue="ts">
  <TabList>
    <Tab value="ts">TypeScript</Tab>
    <Tab value="go">Go</Tab>
  </TabList>
  <TabPanels>
    <TabPanel value="ts">
    `client.list()`を使用してユーザーのテータリポジトリからレコードを読み取ることができます。

    ```tsx
    const posts = await client.list(app.bsky.feed.post, {
      limit: 10,
      repo: 'alex.bsky.team',
    })
    ```

    各Lexiconには独自のパラメータがあります。`app.bsky.feed.post`では、`repo`（ユーザーのハンドルまたは[DID](#did-resolution)）と、返す投稿数の上限を表す`limit`を指定できます。
    </TabPanel>
    <TabPanel value="go">
    `RepoListRecords()`を使用してユーザーのデータリポジトリから投稿を読み取ることができます。

    ```go
    resp, _ := comatproto.RepoListRecords(ctx, client,
        "app.bsky.feed.post",  // lexicon
        "",                    // cursor
        10,                    // limit
        "alex.bsky.team",      // handle or DID
        false,                 // reverse
    )

    for _, record := range resp.Records {
        fmt.Printf("Record: %s\n", record.Uri)
    }
    ```
    </TabPanel>
  </TabPanels>
</TabGroup>

完全なLexiconについては[`app.bsky.feed.post`](https://docs.bsky.app/docs/api/app-bsky-feed-get-posts)を参照してください。

<Heading level={2} id="getting-records">レコードの取得</Heading>

<TabGroup defaultValue="ts">
  <TabList>
    <Tab value="ts">TypeScript</Tab>
    <Tab value="go">Go</Tab>
  </TabList>
  <TabPanels>
    <TabPanel value="ts">
    `client.get()`を使用して、[`rkey`](/specs/record-key)で個別レコードを読み取ることができます。

    ```tsx
    const post = await client.get(app.bsky.feed.post, {
      rkey: '3jxf7z2k3q2',
    })
    ```
    </TabPanel>
    <TabPanel value="go">
    `RepoGetRecord()`を使用して、[`rkey`](/specs/record-key)で個別レコードを読み取ることができます。
    
    ```go
    resp, _ := comatproto.RepoGetRecord(ctx, client, 
        "",                    // cid (empty for latest)
        "app.bsky.feed.post",  // lexicon
        "alex.bsky.team",      // handle or DID
        "3mbl5xdw4yk2r",       // rkey
    )

    fmt.Printf("URI: %s\n", resp.Uri)
    // resp.Valueにレコードデータが含まれています
    ```
    </TabPanel>
  </TabPanels>
</TabGroup>


<Heading level={2} id="did-resolition">DID解決</Heading>

ATでは、ユーザーデータは[DID](/guides/sync#data-repositories)（別名[分散型識別子](https://en.wikipedia.org/wiki/Decentralized_identifier)）を通じて解決されます。ほとんどのATプロトコルアプリケーションはユーザーアカウント登録時に[`did:plc` DID](/guides/the-at-stack#did-plc)を使用します。

`com.atproto.identity.resolveHandle`エンドポイントを使用して、既知のユーザー名をDIDに解決できます。これは、ブラウザで`handle=`引数を使用してこのアドレスにアクセスしてDIDを調べられることを意味します。

```
https://bsky.social/xrpc/com.atproto.identity.resolveHandle?handle=youraccount.bsky.social
```

```
{
did: "did:plc:3vekukmab2djjeengw2o3wln"
}
```

TypeScript SDKは、現在認証されているユーザーのDIDを`client.did`として提供します。

```tsx
const your_did = client.did
```

<Heading level={2} id="unauthenticated-reads">認証無しの読み取り</Heading>

一部のAPIエンドポイントは認証無しでアクセスできます。公開APIのURLを新しい`Client`に渡して、認証無しのクライアントを作成できます。

<TabGroup defaultValue="ts">
  <TabList>
    <Tab value="ts">TypeScript</Tab>
    <Tab value="go">Go</Tab>
  </TabList>
  <TabPanels>
    <TabPanel value="ts">
    ```tsx
    import { Client } from '@atproto/lex'
    import * as app from './lexicons/app.js'

    const client = new Client('https://public.api.bsky.app')
    ```

    認証済みクライアントと同様に、ユーザープロフィールなどの公開レコードを`.get()`できます。

    ```tsx
    const profile = await client.get(app.bsky.actor.profile)
    ```

    同様のSDKクライアントパターンを使用して、任意のLexiconにAPI呼び出しを行うことができます。その他の例については、[SDKドキュメント](https://www.npmjs.com/package/@atproto/lex)を参照してください。
    </TabPanel>
    <TabPanel value="go">
    ```go
    import (
        "context"
        appbsky "github.com/bluesky-social/indigo/api/bsky"
        "github.com/bluesky-social/indigo/xrpc"
    )

    ctx := context.Background()

    client := &xrpc.Client{
        Host: "https://public.api.bsky.app", // public API endpoint
    }
    ```

    認証済みクライアントと同様に、ユーザープロフィールなどの公開レコードを`.get()`できます。

    ```go
    profile, _ := appbsky.ActorGetProfile(ctx, client, "alex.bsky.team")

    fmt.Printf("Handle: %s\n", profile.Handle)
    fmt.Printf("Display Name: %s\n", *profile.DisplayName)
    fmt.Printf("Followers: %d\n", *profile.FollowersCount)
    ```

    同様のSDKクライアントパターンを使用して、任意のLexiconにAPI呼び出しを行うことができます。その他の例については、[Go SDKライブラリ](https://pkg.go.dev/github.com/bluesky-social/indigo)を参照してください。
    </TabPanel>
  </TabPanels>
</TabGroup>

次は、ユーザーのデータリポジトリに[書き込み](/guides/writing-data)を試してみるとよいでしょう。

<Heading level={2} id="further-reading-and-resources">関連・参考資料</Heading>

- [読み取りと書き込み](/guides/reads-and-writes)
- [データ書き込み](/guides/writing-data)
- [アカウントと削除](/guides/account-lifecycle)
- [ソーシャルグラフ](/guides/social-graph)
- [レコードキー仕様](/specs/record-key)
- [URIスキーム](/specs/at-uri-scheme)

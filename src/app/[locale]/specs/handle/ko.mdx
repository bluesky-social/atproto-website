export const metadata = {
  title: '핸들',
  description: '사람 친화적인 계정 식별자에 대한 명세입니다.',
}

# 핸들

DID는 atproto에서 계정을 위한 장기적이고 영속적인 식별자이지만, 사람이 읽기에는 다소 모호할 수 있습니다. 이에 반해 핸들은 계정을 식별하기 위한 덜 영구적인 식별자입니다. 계정 핸들과 계정 DID 간의 연결을 검증하는 메커니즘은 DNS(및 경우에 따라 네트워크 호스트와의 연결)에 의존하므로, 모든 핸들은 유효한 네트워크 호스트네임이어야 합니다. *거의* 모든 유효한 "호스트네임"이 핸들로도 유효하지만, 소수의 예외가 존재합니다. {{ className: 'lead' }}

"호스트네임"의 정의(즉, 모든 가능한 "DNS 이름"의 부분집합)는 시간이 지남에 따라, 또는 여러 RFC 문서에 따라 변해왔습니다. 관련 문서로는 [RFC-1035](https://www.rfc-editor.org/rfc/rfc1035), [RFC-3696](https://www.rfc-editor.org/rfc/rfc3696) 2절, 그리고 [RFC-3986](https://www.rfc-editor.org/rfc/rfc3986) 3절 등이 있습니다. {{ className: 'lead' }}

## 핸들 식별자 문법

Lexicon 문자열 포맷 타입: `handle`

다른 표준과의 조화를 위해, 그리고 "핸들" 문법을 구체적으로 정의하기 위해:

- 전체 핸들은 ASCII 문자만 포함해야 하며, 최대 253자까지 허용됩니다 (실제로는 핸들이 다소 짧게 제한될 수 있습니다)
- 전체 핸들은 여러 개의 세그먼트(표준 문서에서는 "라벨"이라고 함)로 나뉘며, ASCII 마침표(`.`)로 구분됩니다.
- 시작이나 끝에 마침표가 올 수 없으며, 최소 두 개의 세그먼트가 필요합니다. 즉, "tld"와 같은 단일 최상위 도메인은 핸들로 허용되지 않습니다. (DNS의 "trailing dot" 표기법 역시 핸들에서는 허용되지 않습니다.)
- 각 세그먼트는 1자 이상, 63자 이하여야 하며 (마침표 제외), 허용되는 문자는 ASCII 영문자(`a-z`), 숫자(`0-9`), 그리고 하이픈(`-`)입니다.
- 각 세그먼트는 하이픈으로 시작하거나 끝날 수 없습니다.
- 마지막 세그먼트(최상위 도메인)는 숫자로 시작할 수 없습니다.
- 핸들은 대소문자를 구분하지 않으며, 모두 소문자(ASCII `a-z`)로 정규화되어야 합니다.

즉, 위 규칙은 핸들 내에 공백, 널 바이트, 조인 문자, 기타 ASCII 제어 문자(앞뒤 공백 포함)가 포함되지 않음을 명시합니다.

현대의 "호스트네임" (따라서 핸들도)은 대부분의 위치에서 ASCII 숫자 사용을 허용하나, 마지막 세그먼트(최상위 도메인)는 숫자로 시작할 수 없습니다.

IP 주소는 유효한 문법이 아닙니다: IPv4 주소의 마지막 세그먼트는 숫자로 시작하며, IPv6 주소는 콜론(`:`)으로 구분됩니다.

핸들 문법에 대한 참고용 정규 표현식(regex)은 다음과 같습니다:

```
/^([a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?$/
```

## 추가적인 문법 외 제한사항

"예약된" 최상위 도메인은 문법 검증(예, atproto Lexicon 검증)에서는 통과할 수 있으나, 등록이나 해석 등의 시도 시 즉시 거부되어야 합니다. 참고: [https://en.wikipedia.org/wiki/Top-level_domain#Reserved_domains](https://en.wikipedia.org/wiki/Top-level_domain#Reserved_domains)

mDNS용 `.local` 호스트네임은 atproto에서 사용되어서는 안 됩니다.

`.onion` 최상위 도메인은 Tor 프로토콜의 히든 서비스에 해당합니다. Tor를 통한 핸들 해석은 생태계 전체의 지원이 필요하므로, 현재는 허용되지 않습니다.

즉, 초기의 금지된 TLD 목록은 다음과 같습니다:

- `.alt`
- `.arpa`
- `.example`
- `.internal`
- `.invalid`
- `.local`
- `.localhost`
- `.onion`

`.test` TLD는 예제, 테스트, 개발용으로 의도되어 있습니다. atproto 개발에서는 사용될 수 있으나, 실제 환경에서는 실패해야 합니다.

특별한 `handle.invalid` 값에만 `.invalid` TLD가 사용되어야 합니다. 이 값은 Lexicon 스키마 상으로는 문법적으로 유효하나, 대부분의 상황에서 유효한 핸들로는 인정되지 않아야 합니다.

## 식별자 예시

문법적으로 유효한 핸들 (실제 존재하는 TLD 여부와는 무관):

```
jay.bsky.social
8.cn
name.t--t        // 실제 TLD는 아니지만 문법상 문제 없음
XX.LCS.MIT.EDU
a.co
xn--notarealidn.com
xn--fiqa61au8b7zsevnm8ak20mc4a87e.xn--fiqs8s
xn--ls8h.test
example.t        // 실제 TLD는 아니지만 문법상 문제 없음
```

문법적으로 유효하지 않은 예:

```
jo@hn.test
💩.test
john..test
xn--bcher-.tld
john.0
cn.8
www.masełkowski.pl.com
org
name.org.
```

문법은 유효하지만, 다른 제한사항에 의해 항상 해석에 실패해야 하는 예:

```
2gzyxa5ihm7nsggfxnu52rck2vv4rvmdlkiu3zzui5du4xyclen53wid.onion
laptop.local
blah.arpa
```

## 핸들 해석

핸들은 atproto 내에서 제한적인 역할을 하며, 거의 모든 상황에서 DID로 해석되어야 합니다. 해석 메커니즘은 해당 도메인 이름에 대해 어느 정도의 권한을 증명할 수 있어야 하며, 효율적으로 조회 가능해야 합니다. 현재 두 가지 해석 메커니즘이 지원됩니다. 하나는 DID를 포함하는 DNS TXT 레코드를 이용하는 방법이며, 또 다른 하나는 HTTPS의 특별한 `/.well-known/` URL을 이용하는 방법입니다.

클라이언트는 일반적으로 `com.atproto.identity.resolveHandle` 엔드포인트를 사용하여 네트워크 서비스(예, PDS)를 통해 핸들을 해석하며, 직접 해석 로직을 구현할 필요는 없습니다.

DNS TXT 방식은 개별 핸들 설정에 권장되고 선호되는 해석 방법이지만, 서비스는 두 가지 방법 모두를 완벽히 지원해야 합니다. HTTPS 방식은 대규모 웹 서비스와 같이 수천, 수백만 개의 DNS TXT 레코드를 자동으로 등록하기 어려운 경우를 위한 것입니다.

핸들이 DID로 해석되고, 현재 DID 문서가 핸들과의 연결을 확인하기 전까지는 해당 핸들을 신뢰하거나 유효한 것으로 간주해서는 안 됩니다. 핸들과 DID 간의 연결은 양방향으로 확인되어야 하며, 그렇지 않으면 누구나 타인의 계정에 대해 핸들 별칭을 생성할 수 있게 됩니다.

### DNS TXT 방식

이 방식에서는 핸들 호스트네임의 `_atproto` 서브도메인에 DNS TXT 레코드를 등록합니다. 레코드 값은 `did=` 접두사를 포함한 후 전체 DID를 기술해야 합니다. 이 방식은 [RFC-1464](https://www.rfc-editor.org/rfc/rfc1464.html) ("임의의 문자열 속성을 저장하기 위해 도메인 네임 시스템 사용")과 일치합니다.

예를 들어, 핸들 `bsky.app`의 경우, `_atproto.bsky.app`에 TXT 레코드가 등록되며, 레코드 값은 다음과 같이 구성됩니다: `did=did:plc:z72i7hdynmk6r22z27h6tvur`.

`did=`로 시작하지 않는 TXT 레코드는 무시되어야 합니다. 한 시점에 유효한 레코드는 하나만 존재해야 하며, 만약 서로 다른 DID를 가진 여러 유효 레코드가 존재한다면 해석은 실패해야 합니다. 이 경우, 일정 시간 후 재시도하거나 재귀적 해석기를 사용해야 합니다.

추가로, 매우 긴 핸들의 경우, `_atproto.` 접두사가 전체 도메인 길이를 253자를 초과하게 만들어 DNS TXT 방식으로는 해석할 수 없습니다. 이 경우 HTTPS 방식은 정상 작동합니다.

DNSSEC는 필수가 아닙니다.

### HTTPS well-known 방식

이 방식에서는 핸들 도메인에 위치한 웹 서버가 `/.well-known/atproto-did` 경로에 특별한 엔드포인트를 구현합니다. 유효한 HTTP 응답은 2xx 상태 코드와 `Content-Type` 헤더가 `text/plain`으로 설정되며, 본문에 DID가 추가 포맷팅 없이 포함되어야 합니다.

예를 들어, 핸들 `bsky.app`의 경우, `https://bsky.app/.well-known/atproto-did`에 GET 요청을 보내 해석할 수 있으며, 유효한 응답은 다음과 같아야 합니다:

```
HTTP/1.1 200 OK
Content-Length: 33
Content-Type: text/plain
Date: Wed, 14 Jun 2023 00:47:21 GMT

did:plc:z72i7hdynmk6r22z27h6tvur
```

`Content-Type` 헤더의 엄격한 확인은 필요하지 않습니다.

응답 본문의 앞뒤 공백은 제거한 후 DID로 파싱하는 것이 허용됩니다.

실제 환경에서 핸들을 해석할 때는 기본 포트(443)의 HTTPS를 사용해야 하며, HTTP는 로컬 개발 및 테스트용으로만 사용해야 합니다.

HTTP 리다이렉트(예, 301, 302)도 허용되며, 합리적인 리다이렉트 홉 수 내에서는 유효합니다.

### 유효하지 않은 핸들

특정 DID에 대해 핸들이 더 이상 해석되지 않는 것으로 확인되면, 해당 핸들은 유효하지 않은 것으로 표시되어야 합니다. API 응답에서는 특별한 핸들 값인 `handle.invalid`가 주어져, 해당 DID에 대해 양방향으로 유효한 핸들이 없음을 나타냅니다. 이 핸들은 대부분의 상황(검색 쿼리, API 요청 등)에서 사용될 수 없습니다.

### 해석 권장 모범 사례

두 가지 해석 방식을 병렬로 시도하고, 먼저 성공한 결과를 사용하는 것이 좋습니다. 만약 두 방식이 상충하는 결과(즉, 서로 다른 DID)를 반환한다면, DNS TXT 방식의 결과를 우선시해야 합니다. 물론, 모호한 결과로 기록하고 나중에 재시도하는 것도 허용됩니다.

서비스 내부적으로 핸들 해석 결과를 일정 기간 캐시하고 주기적으로 재해석하는 것이 권장됩니다. DNS TTL 값이 캐시 수명으로 활용될 수 있으나, 일반적으로 핸들 해석의 경우에는 너무 짧은 수명으로 간주됩니다.

해석 요청은 신뢰할 수 있는 네트워크 환경과 설정에서 수행하는 것이 좋으며, 여러 지역과 환경에서 요청을 분산시키면(예: 재귀적 DNS 해석기 사용) 트래픽 조작이나 의도적인 응답 분할 문제를 완화할 수 있습니다.

## 사용 및 구현 가이드라인

핸들은 사용자 인터페이스에서 "@" 기호(예: `@jay.bsky.team`)를 접두사로 붙여 표시될 수 있으나, 이는 레코드, API, 백엔드 등에서는 유효한 문법이 아닙니다.

국제화 도메인 이름(IDN, 또는 "punycode")은 저수준 핸들 문법과 직접적인 관련이 없습니다. IDN의 인코딩된 형태는 이미 유효한 호스트네임(따라서 핸들)이며, 이런 핸들은 반드시 ASCII 인코딩 형태로 저장되고 전송되어야 합니다. IDN처럼 보이나 유효한 IDN으로 파싱되지 않는 핸들도, 유효한 호스트네임이라면 핸들로서 허용됩니다. 애플리케이션은 필요에 따라 IDN 핸들을 유니코드로 파싱하여 표시할 수 있습니다.

핸들은 대소문자를 구분하지 않으므로, 사용자 입력을 소문자(ASCII)로 정규화하는 것이 안전합니다. 소문자로 정규화된 핸들만 레코드에 저장되거나 아웃바운드 API 호출에 사용되어야 하며, 사용자 입력 그대로의 대소문자 정보를 보존해 표시하는 것은 피해야 합니다. 예를 들어, 사용자가 입력한 `BlueskyWeb.xyz`는 반드시 `blueskyweb.xyz`로 정규화되어 저장 및 표시되어야 합니다. 단, 길이가 긴 전부 소문자인 핸들은 가독성과 접근성에 도전이 될 수 있으므로, 세그먼트 구분(마침표), 하이픈 사용, 또는 애플리케이션 프로토콜 내 "디스플레이 이름" 사용 등이 고려될 수 있습니다.

매우 긴 핸들은 사용자 인터페이스 상에서 도전적일 수 있으나, 프로토콜 상에서는 허용되며 애플리케이션 개발자는 이를 지원해야 합니다.

유명 도메인과 유사하게 보이는 핸들은 보안 및 사칭 문제를 일으킬 수 있습니다. 예를 들어, `paypa1.com` 또는 `paypal.cc`와 같이 `paypal.com`과 혼동될 수 있는 핸들 또는 시작이나 끝이 잘려서 `paypal.com…`으로 표시되는 경우 등이 있습니다.

핸들은 지역적 맥락에 맞게 축약되어 표시되어서는 안 됩니다. 예를 들어, `@jay.bsky.social` 핸들이 지역적 맥락에서 단순히 `@jay`로 표시되어서는 안 됩니다.

핸들 "네임스페이스"를 제공하는 업체(예: 등록된 도메인의 서브도메인)는 추가적인 제한을 둘 수 있습니다. 일반적으로 각 세그먼트 길이를 합리적인 범위로 제한하고, `www`, `admin`, `mail` 등과 같이 흔히 사용되는 문자열은 예약하는 것이 권장됩니다.

실제로 핸들은 DNS 이름으로 허용되는 253자보다 짧은, 최대 244자로 제한하는 것이 좋습니다. 이는 DNS 검증 시 `_atproto.` 접두사가 추가되어 전체 길이가 제한을 초과할 수 있기 때문입니다.

핸들 호스트네임은 주류 DNS 도메인 이름이어야 하며, 비표준 TLD나 비표준 네이밍 시스템을 사용하는 핸들은 atproto 생태계 내 다른 네트워크 서비스나 프로토콜 구현과 상호 운용되지 않을 수 있습니다.

PDS(개인 데이터 서버)는 계정을 호스팅하면서 계정의 핸들이 더 이상 검증되지 않을 경우(즉, `handle.invalid` 상황) repo 변경을 막을 수 있습니다. 다른 네트워크 서비스는 콘텐츠 단절을 막기 위해 계속해서 해당 콘텐츠를 표시하되, 상황에 따라 경고나 주석을 추가할 수 있습니다.

## 향후 변경 가능성

핸들 문법은 비교적 안정적입니다.

미래에는 `.onion` 핸들이 허용될 가능성도 있습니다.

export const metadata = {
  title: '이벤트 스트림',
  description:
    'Lexicon 객체 스트림 구독을 위한 네트워크 와이어 프로토콜',
  wip: true
}

# 이벤트 스트림

일반적인 [HTTP API](/specs/xrpc) 엔드포인트 외에도, atproto는 연속적인 이벤트 스트림을 지원합니다. 메시지 스키마와 엔드포인트 이름은 전송 방식에 구애받지 않으며, [Lexicons](/specs/lexicon)에서 정의됩니다. 초기 인코딩 및 전송 방식은 바이너리 [DAG-CBOR](https://ipld.io/docs/codecs/known/dag-cbor/) 인코딩을 [WebSockets](https://en.wikipedia.org/wiki/WebSocket) 위에서 사용합니다. {{ className: 'lead' }}

Lexicon에서 스트림의 타입은 `subscription`입니다. 이 스키마는 엔드포인트 식별자(`id`), 메시지 스키마(일반적으로 여러 메시지 타입을 허용하는 union 형태), 그리고 에러 타입 목록(`errors`)을 포함합니다.

클라이언트는 지정된 엔드포인트에 연결을 시작함으로써 특정 스트림을 구독합니다. 현재 스트림은 서버에서 클라이언트로 단방향 메시지를 전송합니다. 클라이언트는 연결을 시작할 때 쿼리 파라미터를 제공하여 스트림을 애플리케이션 별로 구성할 수 있습니다.

**백필(Backfill) 윈도우** 메커니즘을 통해 클라이언트는 놓친 스트림 메시지를 다시 받을 수 있습니다. 기본적으로 스트림 이벤트에는 단조 증가하는 시퀀스 번호가 부여되며, 클라이언트는 연결을 시작할 때 초기 시퀀스 번호를 지정할 수 있습니다. 이 메커니즘의 목적은 연결 장애 후 일정 기간(예: 수 시간 또는 수 일) 내에 안정적인 이벤트 전달을 보장하는 것이지, 클라이언트가 스트림의 시작부터 모든 메시지를 요청할 수 있도록 하는 것이 아닙니다.

초기 구독 Lexicon들은 모두 `com.atproto` 네임스페이스 내에서 백필 메커니즘을 사용합니다. 하지만 백필 메커니즘(및 아래에서 정의하는 커서)은 스트림에 _필수_ 사항이 아닙니다. 안정적인 전달이 필요 없는 구독 엔드포인트는 백필 메커니즘이나 시퀀스 번호를 구현할 필요가 없습니다.

초기 구독 엔드포인트는 공개되어 있으며, 구독을 위해 인증이나 사전 권한이 필요하지 않습니다(단, 클라이언트에 대해 리소스 제한이 적용될 수 있음). 다만, 스트림 엔드포인트는 기존 HTTP API(XRPC) 인증 방법을 사용하여 연결 시 인증을 요구할 수 있습니다.

## 스트리밍 와이어 프로토콜 (v0)

요약하면, 메시지는 DAG-CBOR로 인코딩되어 바이너리 WebSocket을 통해 전송됩니다. 클라이언트는 특정 HTTP 엔드포인트에 연결하고 쿼리 파라미터를 포함한 후, WebSocket으로 업그레이드합니다. 모든 WebSocket 프레임은 두 개의 DAG-CBOR 객체(바이트가 연결되어 있음)를 포함하는데, 첫 번째는 헤더(메시지 타입을 나타냄)이고 두 번째는 실제 메시지입니다.

WebSocket의 "Living Standard"는 현재 [WHATWG](https://en.wikipedia.org/wiki/WHATWG)에서 유지 관리되며, 전체 명세는 [https://websockets.spec.whatwg.org/](https://websockets.spec.whatwg.org/)에서 확인할 수 있습니다.

### 연결

클라이언트는 HTTP 연결을 열고 WebSocket으로 업그레이드하여 스트림 구독을 초기화합니다. 인터넷 상의 연결에는 기본 포트(443)의 HTTPS와 "WebSocket Secure"(즉, `wss://`)를 사용해야 합니다. 테스트, 개발, 또는 로컬 연결(예: SSL을 구현하는 리버스 프록시 뒤)에서는 HTTP, 비보안 WebSocket(`ws://`), 또는 비표준 포트를 사용할 수 있습니다. 클라이언트 관점에서는 WebSocket으로 업그레이드하지 못하는 경우 에러로 간주됩니다.

엔드포인트의 Lexicon 스키마에서 지정한 대로, 쿼리 파라미터를 통해 애플리케이션 별로 스트림을 구성할 수 있습니다.

에러는 보통 스트림 자체를 통해 반환됩니다. 연결 시 발생하는 에러는 스트림의 첫 번째 메시지로 전송된 후 서버가 연결을 종료합니다. 다만, 일부 에러는 스트림을 통해 처리할 수 없어 HTTP 에러로 반환됩니다:

- `405 Method Not Allowed`: 스트림 엔드포인트에 GET이 아닌 HTTP 요청을 보낸 경우
- `426 Upgrade Required`: 요청에 `Upgrade` 헤더가 포함되지 않은 경우
- `429 Too Many Requests`: 주로 속도 제한에 사용되며, 클라이언트는 일정 시간 후 재시도할 수 있음 (특히 `Retry-After` 헤더 지원이 권장됨)
- `500 Internal Server Error`: 클라이언트는 일정 시간 후 재시도할 수 있음
- `501 Not Implemented`: 서비스가 해당 엔드포인트에 대해 WebSocket이나 스트림을 구현하지 않은 경우(클라이언트는 재시도하지 않아야 함)
- `502 Bad Gateway`, `503 Service Unavailable`, `504 Gateway Timeout`: 클라이언트는 일정 시간 후 재시도할 수 있음

서버는 이들 상태 코드에 대해 표준 XRPC 에러 메시지 스키마에 따른 JSON 형태의 HTTP 본문을 반환하는 것이 *권장*되지만, 클라이언트는 예상치 못한 응답 본문 형식에도 유연하게 대응해야 합니다. 예를 들어, 예정된 점검이나 예기치 않은 다운타임 중에 로드 밸런서 또는 리버스 프록시의 기본 에러 페이지를 받을 수 있습니다.

서버나 클라이언트 모두, 일정 시간 동안 메시지가 없을 경우 열린 스트림 연결을 종료할 수 있습니다. 또는 연결을 무한정 유지할 수도 있습니다.

### 프레이밍

각 바이너리 WebSocket 프레임은 두 개의 DAG-CBOR 객체(연결된 바이트)를 포함합니다. 첫 번째 객체는 **헤더**이고, 두 번째 객체는 **페이로드**입니다.

헤더 DAG-CBOR 객체는 다음 필드를 포함합니다:

- `op` ("operation", 정수, 필수): 이 프레임에 포함된 내용의 유형을 나타내는 고정 값
  - `1`: `t`로 표시된 타입의 일반 메시지
  - `-1`: 에러 메시지
- `t` ("type", 문자열, 선택): `op`가 `1`인 경우 필수이며, Lexicon 하위 타입(예: `#commit`)을 짧은 형식으로 나타냅니다. `op`가 `-1`인 경우 헤더에 포함되어서는 안 됩니다.

클라이언트는 알 수 없는 `op` 또는 `t` 값을 가진 헤더를 포함하는 프레임은 무시해야 합니다. 헤더와 페이로드에 포함된 알 수 없는 필드 역시 무시되어야 합니다. 프레임의 프레이밍이나 DAG-CBOR 인코딩이 잘못된 경우, 클라이언트는 해당 프레임을 건너뛰지 않고 전체 연결을 종료해야 합니다. 서버는 클라이언트로부터 수신된 프레임에 대해 에러로 처리하지 않고 무시해야 합니다.

에러 페이로드는 다음 필드를 포함합니다:

- `error` (문자열, 필수): 네임스페이스나 `#` 접두사 없이 에러 타입 이름
- `message` (문자열, 선택): 에러에 대한 설명

에러 프레임 전송 또는 수신 후에는 즉시 스트림 연결이 종료되어야 합니다.

메시지 페이로드는 항상 객체여야 하며, `$type` 필드는 생략해야 합니다(헤더에서 이미 해당 정보가 전달되기 때문입니다). atproto에서는 WebSocket 프레임의 크기에 특정 제한은 없으나, 프레임은 합리적인 크기(약 몇 메가바이트 내외)로 유지해야 합니다.

클라이언트가 메시지 처리 속도를 따라가지 못하는 경우, 서버는 "너무 느림" 에러를 전송하고 연결을 종료할 수 있습니다.

### 시퀀스 번호

스트림은 전송의 안정성을 높이기 위해 메시지 당 시퀀스 번호를 선택적으로 사용할 수 있습니다. 클라이언트는 마지막으로 받은 시퀀스 번호를 추적하며, 재연결 시 해당 번호 이후의 누락된 메시지를 요청할 수 있습니다. 서버는 연결 간에 클라이언트 상태를 유지하지 않습니다. 이 방식은 [Apache Kafka](https://en.wikipedia.org/wiki/Apache_Kafka)나 기타 스트림 처리 프로토콜과 유사한 의미를 가집니다.

구독 Lexicon은 반드시 `seq` 필드(정수 타입)와 `cursor` 쿼리 파라미터(정수 타입)를 포함해야 합니다. 모든 메시지 타입에 `seq`를 포함할 필요는 없습니다. 에러 메시지는 시퀀스 번호를 포함하지 않으며, 종종 지속되지 않는 `#info` 메시지 타입이 사용됩니다.

시퀀스 번호는 항상 0이 아닌 양의 정수이며 단조 증가하지만, 그 외의 의미는 유연합니다. 시퀀스 번호는 불연속적일 수 있습니다. 예를 들어, 타임스탬프를 나타낼 수도 있습니다.

자바스크립트가 기본적으로 모든 숫자를 부동 소수점으로 표현하는 문제를 피하기 위해, 시퀀스 번호는 64비트 부동 소수점으로 안전하게 표현 가능한 범위, 즉 `1`부터 `2^53` 미만으로 제한하는 것이 좋습니다.

시퀀스 번호의 범위는 서비스 제공자(호스트명)와 엔드포인트(NSID)의 조합에 의해 결정됩니다. 이는 대략적으로 연결에 사용된 `wss://` URL에 해당하며, 같은 서비스 내의 다른 스트림 엔드포인트 간에 시퀀스 번호가 고유하지 않을 수 있음을 의미합니다.

서비스는 시퀀스 번호가 재사용되지 않도록 보장해야 하며, 일반적으로 이벤트(시퀀스 번호 포함)를 전송하기 전에 내구성 있는 영구 저장소에 기록해야 합니다.

심각한 장애나 인프라 변경 시, 서버가 백필 윈도우의 데이터를 잃고 시퀀스 번호를 `1`로 재설정할 가능성도 있습니다. 이 경우 클라이언트가 더 높은 번호로 재연결하면, 서버는 `FutureCursor` 에러를 반환합니다. 클라이언트는 이러한 상황에 대해 적절한 전략을 결정해야 합니다. 대부분의 클라이언트는 순서가 맞지 않거나 중복된 시퀀스 번호를 에러로 처리하고 메시지를 무시한 후 연결을 종료해야 합니다. 대부분의 클라이언트는 사람이 개입하지 않는 한 시퀀스 상태를 재설정하지 않아야 하지만, 신뢰성이 덜 요구되는 일부 클라이언트에서는 허용될 수 있습니다.

## 사용 및 구현 가이드라인

현재 스트림 전송 방식은 주로 서버 간 데이터 동기화를 위해 설계되었습니다. 최종 사용자 브라우저에서 직접 연결할 수도 있으나, 바이너리 프레임과 DAG-CBOR 디코딩은 간단하지 않음을 유의해야 합니다.

HTTP 리다이렉트와 WebSocket 업그레이드의 조합은 WebSocket 클라이언트 라이브러리마다 일관되게 지원되지 않습니다. atproto에서는 이를 특별히 지원하거나 금지하지 않습니다.

지원되는 WebSocket 표준 버전은 atproto에서 명시되어 있지 않습니다. 현재 안정적인 WebSocket 표준은 버전 13이며, 구현체는 최신 버전을 지원하기 위해 합리적인 노력을 기울이고 일정 범위의 하위 호환성을 제공해야 합니다.

WebSocket은 고유의 리소스 속도 제한 및 서비스 거부(DoS) 문제를 갖고 있으므로, 서버와 클라이언트 모두 네트워크 대역폭 제한 및 스로틀링을 적용하는 것이 권장됩니다. 서버는 동시 연결 제한과 버퍼 크기를 적절히 조절하여 리소스 고갈을 방지해야 합니다.

서비스가 시퀀스 상태를 재설정해야 하는 경우, 이전 시퀀스 번호보다 충분히 큰 새로운 초기 시퀀스 번호를 선택하는 것이 좋습니다. 예를 들어, 영구 저장소 손실이나 이전 스트림 상태 초기화 시에 해당됩니다.

특정 호스트의 스트림 엔드포인트를 참조하는 URL은 일반적으로 `https://` 대신 `wss://` URI 스킴을 사용해야 합니다.

## 보안 및 프라이버시 고려사항

앞서 "연결" 섹션에서 언급한 바와 같이, 인터넷 상의 스트림 연결은 반드시 `wss://`(SSL)을 사용해야 합니다. 공개 서비스는 비SSL 연결을 거부해야 합니다.

대부분의 HTTP XRPC 엔드포인트는 JSON 형식의 콘텐츠를 사용하지만, 스트림 엔드포인트는 신뢰할 수 없는 입력으로서 DAG-CBOR 객체를 직접 처리합니다. 따라서 악의적인 데이터 인코딩이나 데이터 구조 조작에 대비한 주의가 필요하며, 구체적인 내용은 [데이터 모델](/specs/data-model) 및 [레포지토리](/specs/repository) 명세에서 다룹니다.

## 향후 변경 가능 사항

이벤트 스트림은 AT Protocol의 가장 최신 구성 요소 중 하나로, 다른 구성 요소에 비해 세부 사항이 자주 변경될 가능성이 있습니다.

시퀀스 번호 체계는 샤딩된 스트림을 더 효과적으로 지원하기 위해 조정될 수 있습니다. 이는 공개 인터넷 상에서 더 높은 데이터 처리량을 다루기 위함입니다.

WebSocket 이외의 추가 전송 방식이나, DAG-CBOR 이외의 다른 인코딩 방식이 명세될 수 있습니다. 예를 들어, 텍스트 WebSocket 프레임 내의 JSON 페이로드는 브라우저에서 디코딩하기 더 간단할 수 있습니다.

추가적인 WebSocket 기능이 채택될 수 있습니다:

- `permessage-deflate`와 같은 전송 압축 "확장"
- 서브 프로토콜 정의
- 양방향 메시징
- 1000 클래스 응답 코드

명세 내 모호한 부분은 해결되거나 그대로 열어둘 수 있습니다. 예를 들어:

- HTTP 리다이렉트
- 브라우저 연결을 위한 CORS 및 기타 문제
- 최대 메시지/프레임 크기

정규 HTTP XRPC 엔드포인트와 유사하게 인증 방식이 지원될 수 있습니다.

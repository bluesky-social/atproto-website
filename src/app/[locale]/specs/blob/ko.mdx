export const metadata = {
  title: '블롭',
  description: '레코드가 참조하는 미디어 파일',
}

# 블롭

"블롭"은 계정의 레포지토리와 함께 저장되는 미디어 파일입니다. 이들은 이미지, 비디오, 오디오 등을 포함하지만, 다른 파일 형식도 포함할 수 있습니다. 블롭은 각 레코드에서 `blob` 렉시콘 데이터 유형으로 참조되며, 여기에는 블롭의 콘텐츠 해시(CID)가 포함됩니다.

블롭 파일은 레코드와 별도로 업로드 및 배포됩니다. 블롭은 계정의 PDS 인스턴스에 의해 권위적으로 저장되지만, 보통 애플리케이션(AppViews)과 연관된 CDN을 통해 뷰가 제공되어 PDS의 트래픽을 줄입니다. CDN은 원본 블롭의 변환된(크기 조정, 트랜스코딩 등) 버전을 제공할 수 있습니다.

블롭은 보편적으로 콘텐츠 주소 지정(CID)되지만, 항상 개별 계정(DID)의 컨텍스트 내에서 참조 및 관리됩니다.

빈 블롭(0 바이트)은 일반적으로 유효하지만, 일부 렉시콘이나 애플리케이션에서는 허용되지 않을 수 있습니다.

## 블롭 메타데이터

현재 블롭에 대해 "인증된" CID 유형은 레포지토리 레코드와 유사하지만 `raw` 멀티코덱을 사용합니다:

- CIDv1
- 멀티베이스: DAG-CBOR 내의 바이너리 직렬화 (또는 JSON 매핑의 경우 `base32`)
- 멀티코덱: `raw` (0x55)
- 멀티해시: 256비트 `sha-256` (0x12)

예시 블롭 CID (base32 문자열 인코딩): `bafkreibjfgx2gprinfvicegelk5kosd6y2frmqpqzwqkg7usac74l3t2v4`

블롭 메타데이터는 또한 블롭의 크기(바이트 단위)와 MIME 타입을 포함합니다. 크기와 CID는 결정적이며 유효하고 일관되어야 합니다. MIME 타입은 다소 주관적입니다: 동일한 바이트들이 여러 MIME 타입에 대해 유효할 수 있습니다.

## 블롭 수명 주기

레코드가 해당 블롭을 참조하기 전에 블롭은 반드시 PDS에 업로드되어야 합니다. 서버는 업로드 시 의도된 렉시콘을 알 수 없으므로, 초기 업로드 시에는 일반적인 블롭 제한 및 제약만 적용할 수 있고, 이후 레코드 생성 시 렉시콘에서 정의한 제한을 적용할 수 있습니다.

클라이언트는 PDS의 `com.atproto.repo.uploadBlob` 엔드포인트를 사용하며, 이 엔드포인트는 렉시콘 블롭 객체의 형태로 검증된 메타데이터를 반환합니다. 클라이언트는 HTTP `Content-Type` 헤더와 `Content-Length` 헤더를 업로드 요청에 "설정해야" 합니다. 청크 전송 인코딩도 업로드에 허용될 수 있습니다. 서버는 업로드된 블롭의 MIME 타입을 감지하여 선언된 `Content-Type` 헤더와 비교 검증할 수 있으며, 수정된 MIME 타입을 응답으로 반환하거나 업로드를 거부할 수 있습니다. 실제 업로드된 블롭의 크기가 `Content-Length` 헤더와 다를 경우, 서버는 업로드를 거부해야 합니다.

업로드가 성공하면, 블롭은 임시 저장소에 배치됩니다. 이 상태의 블롭은 다운로드나 배포가 불가능합니다. 서버는 임시 상태의 참조되지 않은 블롭을 적절한 시간 경과 후에 "가비지 컬렉션"(삭제) 해야 합니다 (아래 구현 지침 참조). 임시 저장소에 있는 블롭은 `listBlobs` 출력에 포함되어서는 안 됩니다.

이제 업로드된 블롭은 반환된 블롭 메타데이터를 레코드에 포함하여 참조할 수 있습니다. 레코드 생성 처리 시, 서버는 참조된 모든 블롭들을 추출하고, 해당 블롭들이 이미 참조되고 있거나 임시 저장소에 있는지 확인합니다. 레코드 생성이 성공하면, 서버는 블롭을 공개적으로 접근 가능하게 만듭니다.

동일한 블롭은 같은 레포지토리 내 여러 레코드에서 참조될 수 있습니다. 이미 저장되어 참조되고 있는 블롭을 다시 업로드해도 기존의 블롭이나 레코드에는 변화가 없습니다.

블롭을 참조하는 레코드가 삭제되면, 서버는 같은 레포지토리 내 다른 현재 레코드가 해당 블롭을 참조하는지 확인합니다. 참조하는 레코드가 없다면, 해당 블롭은 레코드와 함께 삭제됩니다.

계정이 삭제되면, 모든 호스팅된 블롭은 합리적인 시간 내에 삭제됩니다. 계정이 비활성화되거나 중단, 정지된 경우, 블롭은 공개적으로 접근할 수 없어야 합니다.

서버는 개별 블롭을 계정의 중단이나 다른 계정 수명 주기 이벤트와 별개로 접근 불가능하게 만들 수도 있습니다.

존재하지 않는 블롭을 참조하는 새로운 레코드 생성은 생성(또는 업데이트) 시 거부되어야 합니다. 그러나, 서버가 로컬에서 사용 가능한 블롭이 아닌 레포지토리 레코드를 호스팅할 가능성은 있습니다. 예를 들어, 대량 레포지토리 가져오기나 계정 마이그레이션, 데이터 손실 또는 정책상의 이유로 콘텐츠가 삭제/제거되는 경우가 이에 해당합니다.

원본 블롭은 `com.atproto.sync.getBlob` 엔드포인트를 통해 PDS에서 가져올 수 있습니다. 서버는 적절한 `Content-Type` 및 `Content-Length` HTTP 헤더를 반환해야 합니다. 미디어 파일을 PDS에서 직접 브라우저로 제공하는 것은 권장되거나 요구되는 패턴이 아니므로, 서버는 이를 지원할 필요가 없습니다. (아래 "보안 고려 사항" 참조)

## 사용 및 구현 지침

서버는 렉시콘에서 정의한 제약과는 별개로 블롭에 대해 자체적인 일반 제한 및 정책을 가질 수 있습니다. 예를 들어, 계정 전체의 데이터 저장소 쿼터, 최대 블롭 크기, 콘텐츠 정책 등을 구현할 수 있으며, 이러한 제한은 초기 업로드 시 적용될 수 있습니다. 운영자는 제한 및 기타 제약 사항이 기존 및 향후 애플리케이션의 기능에 영향을 미칠 수 있음을 인지해야 합니다. 상호 운용성을 극대화하기 위해, 운영자는 개별 블롭 크기 제한보다는 계정 전체의 리소스 소비(예: "전체 블롭 크기" 쿼터)에 대한 제한을 선호하는 것이 좋습니다.

일부 애플리케이션은 블롭 업로드와 레코드 참조 사이에 긴 지연 시간이 있을 수 있습니다. 상호 운용성을 극대화하기 위해, 서버 구현 및 운영자는 "가비지 컬렉션"을 최소 한 시간 이상의 확실한 시간 후, 몇 시간의 유예 기간을 두고 수행하는 것이 좋습니다.

## 보안 고려 사항

사용자가 업로드한 임의의 파일을 웹 서버에서 제공하는 것은 다양한 콘텐츠 보안 문제를 야기할 수 있습니다. 예를 들어, 스크립트나 SVG 콘텐츠에서의 교차 사이트 스크립팅(XSS)이 동일 출처 정책에 위배될 수 있습니다. `getBlob` 엔드포인트에는 Content Security Policy(CSP, [MDN 문서](https://developer.mozilla.org/ko/docs/Web/HTTP/CSP))를 활성화하는 것이 필수적입니다. PDS에서 직접 블롭을 브라우저나 웹 애플리케이션에 동적으로 제공하는 것은 실질적으로 지원되지 않습니다. 애플리케이션은 블롭, 파일, 자산을 독립적인 CDN, 프록시 또는 기타 웹 서비스로 중계하여 제공해야 하며, 이러한 서비스는 보안 예방 조치를 구현해야 합니다.

예시로, 이 엔드포인트에 적합한 콘텐츠 보안 헤더는 다음과 같습니다:

```
Content-Security-Policy: default-src 'none'; sandbox
X-Content-Type-Options: nosniff
```

일부 미디어 타입은 민감한 메타데이터를 포함할 수 있습니다. 예를 들어, JPEG 이미지 파일의 EXIF 메타데이터에는 GPS 좌표가 포함될 수 있습니다. 서버는 이러한 메타데이터의 우발적 누출을 방지하기 위해, 예를 들어 메타데이터를 포함하는 블롭의 업로드를 차단하는 등의 조치를 취할 수 있습니다. (자세한 내용은 "향후 변경 사항" 섹션의 주석을 참조하십시오.)

미디어 파일 파싱은 메모리 안전 버그 및 보안 취약점의 주요 원인이 될 수 있습니다. 콘텐츠 타입 감지(스니핑) 또한 취약점의 원인이 될 수 있으므로, 서버는 강력한 샌드박싱 메커니즘 없이 미디어 파일(이미지, 비디오, 오디오 또는 기타 복잡한 형식)을 직접 파싱하는 것을 강력히 권장하지 않습니다. 특히, PDS 인스턴스 자체가 미디어 크기 조정이나 트랜스코딩을 직접 구현해서는 안 됩니다.

더 복잡한 미디어 타입은 악의적이거나 불법적인 콘텐츠의 위험을 증가시킵니다. 서버는 그러한 콘텐츠가 감지되고 신고될 경우 적절한 제거 메커니즘을 구현해야 합니다.

서버는 악의적인 리소스 소비를 방지하기 위한 조치를 취해야 할 수도 있습니다. 예를 들어, 의도적인 디스크 공간 고갈, 네트워크 혼잡, 대역폭 사용 등이 이에 해당합니다. 속도 제한, 크기 제한 및 쿼터 적용이 권장됩니다.

## 향후 변경 사항

허용된 CID 유형은 시간이 지남에 따라 진화할 것으로 예상됩니다. 대용량 파일에 대해 `blake3`에 대한 관심이 있습니다.

EXIF 메타데이터 제거와 같이 메타데이터 누출을 보다 구체적으로 완화하는 방안이 API 변경을 통해 권장되거나 활성화되어야 합니다. 이는 기본적인 안전성을 제공하는 것과 사용자가 업로드한 "원본" 데이터를 항상 변경하지 않고 제공하는 것 사이의 긴장을 야기합니다. 또한, 업로드된 미디어 파일을 파싱하고 조작하는 것은 다른 종류의 보안 문제를 발생시킬 수 있습니다.